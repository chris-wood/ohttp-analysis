theory OHTTP begin

// Function signature and definition of the equational theory E

builtins: diffie-hellman
functions: Expand/3, Extract/2, aead/4, aead_verify/4, decrypt/3,
           fst/1, h/1, hmac/1, pair/2, pk/1, sdec/2, senc/2, sign/2, snd/1,
           true/0, verify/3
equations:
    aead_verify(k, n, a, aead(k, n, a, p)) = true,
    decrypt(k, n, aead(k, n, a, p)) = p,
    fst(<x.1, x.2>) = x.1,
    sdec(senc(x.1, x.2), x.2) = x.1,
    snd(<x.1, x.2>) = x.2,
    verify(sign(x.1, x.2), x.1, pk(x.2)) = true



restriction Eq_check_succeed:
  "∀ x y #i. (Eq( x, y ) @ #i) ⇒ (x = y)"
  // safety formula

restriction Neq_check_succeed:
  "∀ x y #i. (Neq( x, y ) @ #i) ⇒ (¬(x = y))"
  // safety formula

rule (modulo E) Starter:
   [ Fr( ~kxy ) ]
  --[ Channel( $X, $Y ) ]->
   [
   KeyExC( $X, $Y, ~kxy ), KeyExS( $X, $Y, ~kxy ),
   KeyExI( $X, $Y, ~kxy )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Generate_DH_key_pair:
   [ Fr( ~x ), Fr( ~key_id ) ]
  -->
   [
   !Pk( $A, <~key_id, $kdf_id, $aead_id>, 'g'^~x ),
   Out( <~key_id, 'g'^~x> ),
   !Ltk( $A, <~key_id, $kdf_id, $aead_id>, ~x )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) C_QueryGeneration:
   [
   KeyExC( $C, $P, ~k ), !Pk( $T, <~key_id, kdf_id, aead_id>, gy ),
   Fr( ~x ), Fr( ~req ), Fr( ~cid )
   ]
  --[
  Neq( $P, $T ),
  CQG_sources( 'g'^~x,
               aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy^~x>),
                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                    Expand(Extract(Expand(Extract('blank',
                                                  <'HPKE_v1', 'eae_prk', gy^~x>),
                                          <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                   <'HPKE_v1', 'secret', 'blank'>),
                           <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                            Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                           '32'),
                    <~key_id, kdf_id, aead_id>, ~req)
  ),
  C_SS( 'g'^~x, gy,
        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy^~x>),
               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32')
  ),
  C_QG( $C, 'g'^~x, $P, ~k, $T, gy, ~cid, ~req )
  ]->
   [
   Out( senc(<~cid, <~key_id, kdf_id, aead_id>, 'g'^~x, 
              aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy^~x>),
                          <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                   Expand(Extract(Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', gy^~x>),
                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                  <'HPKE_v1', 'secret', 'blank'>),
                          <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                           Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                          '32'),
                   <~key_id, kdf_id, aead_id>, ~req)
             >,
             ~k)
   ),
   C_ResponseHandler( ~req, $C, 'g'^~x, $P, ~k, $T, gy,
                      Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy^~x>),
                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32')
   )
   ]

  /*
  rule (modulo AC) C_QueryGeneration:
     [
     KeyExC( $C, $P, ~k ), !Pk( $T, <~key_id, kdf_id, aead_id>, gy ),
     Fr( ~x ), Fr( ~req ), Fr( ~cid )
     ]
    --[
    Neq( $P, $T ),
    CQG_sources( 'g'^~x,
                 aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                      Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                              Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                             '32'),
                      <~key_id, kdf_id, aead_id>, ~req)
    ),
    C_SS( 'g'^~x, gy,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32')
    ),
    C_QG( $C, 'g'^~x, $P, ~k, $T, gy, ~cid, ~req )
    ]->
     [
     Out( senc(<~cid, <~key_id, kdf_id, aead_id>, 'g'^~x, 
                aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                     Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                             Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                            '32'),
                     <~key_id, kdf_id, aead_id>, ~req)
               >,
               ~k)
     ),
     C_ResponseHandler( ~req, $C, 'g'^~x, $P, ~k, $T, gy,
                        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32')
     )
     ]
    variants (modulo AC)
    1. ~x    = ~x.20
       gy    = gy.22
       z     = gy.22^~x.20
    
    2. ~x    = ~x.26
       gy    = z.34^inv(~x.26)
       z     = z.34
    
    3. ~x    = ~x.246
       gy    = x.482^x.483
       z     = x.482^(~x.246*x.483)
    
    4. ~x    = ~x.248
       gy    = x.486^inv((~x.248*x.487))
       z     = x.486^inv(x.487)
    
    5. ~x    = ~x.248
       gy    = x.486^(x.487*inv(~x.248))
       z     = x.486^x.487
    
    6. ~x    = ~x.249
       gy    = x.487^(x.488*inv((~x.249*x.489)))
       z     = x.487^(x.488*inv(x.489))
  */

rule (modulo E) P_HandleQuery:
   [
   KeyExS( $C, $P, ~k ),
   In( senc(<cid, <key_id, kdf_id, aead_id>, gx, opaque>, ~k) ),
   !Pk( $T, <key_id, kdf_id, aead_id>, gy ), Fr( ~ptid )
   ]
  --[ PHQ( gx, opaque ) ]->
   [
   Out( <$T, <key_id, kdf_id, aead_id>, gx, opaque> ),
   P_ResponseHandler( ~ptid, $C, $P, ~k )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) T_HandleQuery:
   [
   In( <$T, <~key_id, kdf_id, aead_id>, gx, 
        aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>),
                    <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
             Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', gx^~y>),
                                   <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                     Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                    '32'),
             <~key_id, kdf_id, aead_id>, request)
       >
   ),
   !Ltk( $T, <~key_id, kdf_id, aead_id>, ~y ), Fr( ~ttid ),
   Fr( ~resp ), Fr( ~resp_nonce )
   ]
  --[
  Eq( aead_verify(Expand(Extract('blank',
                                 <'HPKE_v1', 'eae_prk', gx^~y>),
                         <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                  Expand(Extract(Expand(Extract('blank',
                                                <'HPKE_v1', 'eae_prk', gx^~y>),
                                        <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                 <'HPKE_v1', 'secret', 'blank'>),
                         <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                          Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                         '32'),
                  <~key_id, kdf_id, aead_id>,
                  aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>),
                              <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                       Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', gx^~y>),
                                             <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                               Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                              '32'),
                       <~key_id, kdf_id, aead_id>, request)),
      true
  ),
  T_Done( ~ttid ),
  T_SS( gx, 'g'^~y,
        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>),
               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32')
  ),
  T_Answer( ~ttid, $T, gx, 'g'^~y, request, ~resp )
  ]->
   [
   Out( <~resp_nonce, 
         aead(Expand(Extract(request,
                             Expand(Expand(Extract(<
                                                    Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', gx^~y>),
                                                           <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                            'g'^~y>,
                                                           '32'), 
                                                    ~resp_nonce>,
                                                   <'HPKE_v1', 'secret', 'blank'>),
                                           <'32', 'HPKE_v1', 'exp', '0x01', 
                                            Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                                           '32'),
                                    <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                     'key', '32'),
              Expand(Extract(request,
                             Expand(Expand(Extract(<
                                                    Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', gx^~y>),
                                                           <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                            'g'^~y>,
                                                           '32'), 
                                                    ~resp_nonce>,
                                                   <'HPKE_v1', 'secret', 'blank'>),
                                           <'32', 'HPKE_v1', 'exp', '0x01', 
                                            Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                                           '32'),
                                    <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                     'nonce', '32'),
              'blank', ~resp)
        >
   )
   ]

  /*
  rule (modulo AC) T_HandleQuery:
     [
     In( <$T, <~key_id, kdf_id, aead_id>, gx, 
          aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                      <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
               Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                     <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                       Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                      '32'),
               <~key_id, kdf_id, aead_id>, request)
         >
     ),
     !Ltk( $T, <~key_id, kdf_id, aead_id>, ~y ), Fr( ~ttid ),
     Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    Eq( true, true ), T_Done( ~ttid ),
    T_SS( gx, 'g'^~y,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                 <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32')
    ),
    T_Answer( ~ttid, $T, gx, 'g'^~y, request, ~resp )
    ]->
     [
     Out( <~resp_nonce, 
           aead(Expand(Extract(request,
                               Expand(Expand(Extract(<
                                                      Expand(Extract('blank',
                                                                     <'HPKE_v1', 'eae_prk', z>),
                                                             <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                              'g'^~y>,
                                                             '32'), 
                                                      ~resp_nonce>,
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x01', 
                                              Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                       'key', '32'),
                Expand(Extract(request,
                               Expand(Expand(Extract(<
                                                      Expand(Extract('blank',
                                                                     <'HPKE_v1', 'eae_prk', z>),
                                                             <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                              'g'^~y>,
                                                             '32'), 
                                                      ~resp_nonce>,
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x01', 
                                              Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
    variants (modulo AC)
    1. ~y    = ~y.18
       gx    = gx.20
       z     = gx.20^~y.18
    
    2. ~y    = ~y.24
       gx    = z.32^inv(~y.24)
       z     = z.32
    
    3. ~y    = ~y.437
       gx    = x.866^x.867
       z     = x.866^(~y.437*x.867)
    
    4. ~y    = ~y.439
       gx    = x.870^inv((~y.439*x.871))
       z     = x.870^inv(x.871)
    
    5. ~y    = ~y.439
       gx    = x.870^(x.871*inv(~y.439))
       z     = x.870^x.871
    
    6. ~y    = ~y.440
       gx    = x.871^(x.872*inv((~y.440*x.873)))
       z     = x.871^(x.872*inv(x.873))
  */

rule (modulo E) P_HandleResponse:
   [ P_ResponseHandler( ~ptid, $C, $P, ~k ), In( <nonce, opaque> ) ]
  --[ P_Done( ~ptid ) ]->
   [ Out( senc(<nonce, opaque>, ~k) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) C_HandleResponse:
   [
   C_ResponseHandler( ~request, $C, gx, $P, ~k, $T, gy, shared_secret
   ),
   In( senc(<response_nonce, 
             aead(Expand(Extract(~request,
                                 Expand(Expand(Extract(<shared_secret, response_nonce>,
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', 
                                                Extract('blank',
                                                        <'HPKE_v1', 'info_hash', 'request'>)
                                               >,
                                               '32'),
                                        <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                         'key', '32'),
                  Expand(Extract(~request,
                                 Expand(Expand(Extract(<shared_secret, response_nonce>,
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', 
                                                Extract('blank',
                                                        <'HPKE_v1', 'info_hash', 'request'>)
                                               >,
                                               '32'),
                                        <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                         'nonce', '32'),
                  'blank', response)
            >,
            ~k)
   )
   ]
  --[
  C_Done( ~request, response, $C, gx, $T, gy ),
  Eq( aead_verify(Expand(Extract(~request,
                                 Expand(Expand(Extract(<shared_secret, response_nonce>,
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', 
                                                Extract('blank',
                                                        <'HPKE_v1', 'info_hash', 'request'>)
                                               >,
                                               '32'),
                                        <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                         'key', '32'),
                  Expand(Extract(~request,
                                 Expand(Expand(Extract(<shared_secret, response_nonce>,
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', 
                                                Extract('blank',
                                                        <'HPKE_v1', 'info_hash', 'request'>)
                                               >,
                                               '32'),
                                        <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                         'nonce', '32'),
                  'blank',
                  aead(Expand(Extract(~request,
                                      Expand(Expand(Extract(<shared_secret, response_nonce>,
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 'request'>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                              'key', '32'),
                       Expand(Extract(~request,
                                      Expand(Expand(Extract(<shared_secret, response_nonce>,
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 'request'>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                              'nonce', '32'),
                       'blank', response)),
      true
  )
  ]->
   [ ]

  /*
  rule (modulo AC) C_HandleResponse:
     [
     C_ResponseHandler( ~request, $C, gx, $P, ~k, $T, gy, shared_secret
     ),
     In( senc(<response_nonce, 
               aead(Expand(Extract(~request,
                                   Expand(Expand(Extract(<shared_secret, response_nonce>,
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x01', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 'request'>)
                                                 >,
                                                 '32'),
                                          <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                           'key', '32'),
                    Expand(Extract(~request,
                                   Expand(Expand(Extract(<shared_secret, response_nonce>,
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x01', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 'request'>)
                                                 >,
                                                 '32'),
                                          <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                           'nonce', '32'),
                    'blank', response)
              >,
              ~k)
     )
     ]
    --[ C_Done( ~request, response, $C, gx, $T, gy ), Eq( true, true )
    ]->
     [ ]
  */

rule (modulo E) RevSK:
   [ KeyExI( $X, $Y, ~kxy ) ] --[ RevSk( ~kxy ) ]-> [ Out( ~kxy ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) RevDH:
   [ !Ltk( $A, ~key_id, ~x ) ]
  --[ RevDH( $A, ~key_id, 'g'^~x ) ]->
   [ Out( ~x ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) NonceReuse:
   [ In( aead(k, n, a1, p1) ), In( aead(k, n, a2, p2) ) ]
  --[ Neq( p1, p2 ), ReuseNonce( k, n, p1, p2 ) ]->
   [ Out( p1 ) ]

  /* has exactly the trivial AC variant */

lemma CQG_sources [sources]:
  all-traces
  "∀ gx op #j.
    (PHQ( gx, op ) @ #j) ⇒
    ((∃ #i. (CQG_sources( gx, op ) @ #i) ∧ (#i < #j)) ∨
     ((∃ #i. (!KU( gx ) @ #i) ∧ (#i < #j)) ∧
      (∃ #i. (!KU( op ) @ #i) ∧ (#i < #j))))"
/*
guarded formula characterizing all counter-examples:
"∃ gx op #j.
  (PHQ( gx, op ) @ #j)
 ∧
  (∀ #i. (CQG_sources( gx, op ) @ #i) ⇒ ¬(#i < #j)) ∧
  (((∀ #i. (!KU( gx ) @ #i) ⇒ ¬(#i < #j)) ∨
    (∀ #i. (!KU( op ) @ #i) ⇒ ¬(#i < #j))))"
*/
by sorry

lemma aead_sources [sources]:
  all-traces
  "∀ k n a p #j.
    (!KU( aead(k, n, a, p) ) @ #j) ⇒
    (((∃ #i. (!KU( p ) @ #i) ∧ (#i < #j)) ∨
      (∃ tid T gx gy req #i.
        (T_Answer( tid, T, gx, gy, req, p ) @ #i) ∧ (#i < #j))) ∨
     (∃ C gx P k.1 T gy cid #i.
       (C_QG( C, gx, P, k.1, T, gy, cid, p ) @ #i) ∧ (#i < #j)))"
/*
guarded formula characterizing all counter-examples:
"∃ k n a p #j.
  (!KU( aead(k, n, a, p) ) @ #j)
 ∧
  (∀ #i. (!KU( p ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ tid T gx gy req #i.
    (T_Answer( tid, T, gx, gy, req, p ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ C gx P k.1 T gy cid #i.
    (C_QG( C, gx, P, k.1, T, gy, cid, p ) @ #i) ⇒ ¬(#i < #j))"
*/
by sorry

lemma end_to_end:
  exists-trace
  "∃ req resp C gx T gy #i. C_Done( req, resp, C, gx, T, gy ) @ #i"
/*
guarded formula characterizing all satisfying traces:
"∃ req resp C gx T gy #i. (C_Done( req, resp, C, gx, T, gy ) @ #i)"
*/
simplify
solve( C_ResponseHandler( ~request, $C, gx, $P, ~k, $T, gy,
                          shared_secret
       ) ▶₀ #i )
  case C_QueryGeneration
  solve( !KU( senc(<response_nonce, 
                    aead(Expand(Extract(~request,
                                        Expand(Expand(Extract(<
                                                               Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~x.1)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~x.1>,
                                                                      '32'), 
                                                               response_nonce>,
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 'request'>)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                'key', '32'),
                         Expand(Extract(~request,
                                        Expand(Expand(Extract(<
                                                               Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~x.1)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~x.1>,
                                                                      '32'), 
                                                               response_nonce>,
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 'request'>)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                'nonce', '32'),
                         'blank', resp)
                   >,
                   ~k)
         ) @ #vk )
    case P_HandleResponse
    solve( !KU( aead(Expand(Extract(~request,
                                    Expand(Expand(Extract(<
                                                           Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', 
                                                                           'g'^(~x*~x.1)>),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', 'g'^~x, 'g'^~x.1
                                                                  >,
                                                                  '32'), 
                                                           response_nonce>,
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 'request'>)
                                                  >,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                            'key', '32'),
                     Expand(Extract(~request,
                                    Expand(Expand(Extract(<
                                                           Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', 
                                                                           'g'^(~x*~x.1)>),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', 'g'^~x, 'g'^~x.1
                                                                  >,
                                                                  '32'), 
                                                           response_nonce>,
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 'request'>)
                                                  >,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                            'nonce', '32'),
                     'blank', resp)
           ) @ #vk.3 )
      case T_HandleQuery
      solve( !KU( senc(<cid.1, <~key_id.1, $kdf_id.1, $aead_id.1>, gx, 
                        opaque>,
                       ~k)
             ) @ #vk.4 )
        case C_QueryGeneration
        solve( !KU( ~key_id ) @ #vk.9 )
          case C_QueryGeneration
          solve( !KU( ~k.1 ) @ #vk.16 )
            case RevSK
            solve( !KU( ~resp_nonce ) @ #vk.7 )
              case T_HandleQuery
              solve( !KU( 'g'^~x ) @ #vk.15 )
                case C_QueryGeneration
                solve( !KU( ~k ) @ #vk.17 )
                  case RevSK
                  solve( !KU( aead(Expand(Extract('blank',
                                                  <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                          <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                          '32'),
                                   Expand(Extract(Expand(Extract('blank',
                                                                 <'HPKE_v1', 'eae_prk', 
                                                                  'g'^(~x*~x.1)>),
                                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                          'g'^~x.1>,
                                                         '32'),
                                                  <'HPKE_v1', 'secret', 'blank'>),
                                          <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                           Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                                          '32'),
                                   <~key_id, $kdf_id, $aead_id>, ~request)
                         ) @ #vk.17 )
                    case C_QueryGeneration
                    SOLVED // trace found
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma ss_match:
  all-traces
  "∀ gx gy ss #j.
    (T_SS( gx, gy, ss ) @ #j) ⇒
    ((∃ #i. (C_SS( gx, gy, ss ) @ #i) ∧ (#i < #j)) ∨
     (∃ #i. (!KU( ss ) @ #i) ∧ (#i < #j)))"
/*
guarded formula characterizing all counter-examples:
"∃ gx gy ss #j.
  (T_SS( gx, gy, ss ) @ #j)
 ∧
  (∀ #i. (C_SS( gx, gy, ss ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ #i. (!KU( ss ) @ #i) ⇒ ¬(#i < #j))"
*/
simplify
solve( !Ltk( $T, <~key_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
  case Generate_DH_key_pair
  solve( !KU( ~key_id ) @ #vk.4 )
    case C_QueryGeneration
    solve( !KU( ~k ) @ #vk.11 )
      case RevSK
      solve( !KU( aead(Expand(Extract('blank',
                                      <'HPKE_v1', 'eae_prk', z>),
                              <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                       Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                             <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                               Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                              '32'),
                       <~key_id, $kdf_id, $aead_id>, request)
             ) @ #vk.11 )
        case C_QueryGeneration
        by contradiction /* from formulas */
      next
        case P_HandleQuery
        by contradiction /* from formulas */
      next
        case c_aead
        by contradiction /* from formulas */
      qed
    qed
  next
    case Generate_DH_key_pair
    solve( !KU( aead(Expand(Extract('blank',
                                    <'HPKE_v1', 'eae_prk', z>),
                            <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                     Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                           <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                             Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                            '32'),
                     <~key_id, $kdf_id, $aead_id>, request)
           ) @ #vk.10 )
      case C_QueryGeneration
      by contradiction /* from formulas */
    next
      case P_HandleQuery
      by contradiction /* from formulas */
    next
      case c_aead
      by contradiction /* from formulas */
    qed
  next
    case P_HandleQuery
    solve( !KU( aead(Expand(Extract('blank',
                                    <'HPKE_v1', 'eae_prk', z>),
                            <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                     Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                           <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                             Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                            '32'),
                     <~key_id, $kdf_id, $aead_id>, request)
           ) @ #vk.10 )
      case C_QueryGeneration
      by contradiction /* from formulas */
    next
      case P_HandleQuery
      by contradiction /* from formulas */
    next
      case c_aead
      by contradiction /* from formulas */
    qed
  qed
qed

lemma secret_request [reuse]:
  all-traces
  "∀ C gx P key T gy cid req #j #k.
    ((C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧
     (!KU( req ) @ #k)) ⇒
    (∃ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ∧ (#i < #k))"
/*
guarded formula characterizing all counter-examples:
"∃ C gx P key T gy cid req #j #k.
  (C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧ (!KU( req ) @ #k)
 ∧
  ∀ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ⇒ ¬(#i < #k)"
*/
simplify
solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
  case Starter
  solve( !Pk( $T, <~key_id, kdf_id, aead_id>, gy ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~req ) @ #k.1 )
      case C_QueryGeneration
      solve( !KU( ~k ) @ #vk.6 )
        case RevSK
        solve( !KU( 'g'^(~x*~x.1) ) @ #vk.26 )
          case C_QueryGeneration
          by solve( !KU( ~x ) @ #vk.33 )
        next
          case Generate_DH_key_pair
          by solve( !KU( ~x.1 ) @ #vk.33 )
        next
          case c_exp
          by solve( !KU( ~x ) @ #vk.35 )
        qed
      qed
    next
      case NonceReuse
      solve( !KU( aead(k.2, n, a1, ~req) ) @ #vk )
        case C_QueryGeneration
        solve( !KU( ~k ) @ #vk.2 )
          case RevSK
          solve( !KU( aead(Expand(Extract('blank',
                                          <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                  <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32'),
                           Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                   Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                                  '32'),
                           a2, p2)
                 ) @ #vk.2 )
            case C_QueryGeneration
            by contradiction /* from formulas */
          next
            case c_aead
            solve( !KU( Expand(Extract('blank',
                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32')
                   ) @ #vk.3 )
              case c_Expand
              solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                >,
                                                '32'),
                                         <'HPKE_v1', 'secret', 'blank'>),
                                 <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                  Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                                 '32')
                     ) @ #vk.4 )
                case c_Expand
                solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                       ) @ #vk.7 )
                  case c_Extract
                  solve( !KU( Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>)
                         ) @ #vk.20 )
                    case c_Extract
                    solve( !KU( 'g'^(~x*~x.1) ) @ #vk.31 )
                      case C_QueryGeneration
                      by solve( !KU( ~x ) @ #vk.33 )
                    next
                      case Generate_DH_key_pair
                      by solve( !KU( ~x.1 ) @ #vk.33 )
                    next
                      case c_exp
                      by solve( !KU( ~x ) @ #vk.35 )
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case P_HandleQuery
        solve( !KU( aead(Expand(Extract('blank',
                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32'),
                         Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                 Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                                '32'),
                         a2, p2)
               ) @ #vk.1 )
          case P_HandleQuery
          by contradiction /* from formulas */
        next
          case c_aead
          solve( !KU( Expand(Extract('blank',
                                     <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32')
                 ) @ #vk.3 )
            case c_Expand
            solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                      <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                              <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                              '32'),
                                       <'HPKE_v1', 'secret', 'blank'>),
                               <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                               '32')
                   ) @ #vk.4 )
              case c_Expand
              solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                     ) @ #vk.7 )
                case c_Extract
                solve( !KU( Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>)
                       ) @ #vk.20 )
                  case c_Extract
                  solve( !KU( 'g'^(~x*~x.1) ) @ #vk.31 )
                    case Generate_DH_key_pair
                    by solve( !KU( ~x.1 ) @ #vk.33 )
                  next
                    case P_HandleQuery
                    by solve( !KU( ~x ) @ #vk.33 )
                  next
                    case c_exp
                    by solve( !KU( ~x ) @ #vk.35 )
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case c_aead
        by contradiction /* cyclic */
      qed
    next
      case P_HandleQuery
      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.25 )
        case Generate_DH_key_pair
        by solve( !KU( ~x.1 ) @ #vk.33 )
      next
        case P_HandleQuery
        by solve( !KU( ~x ) @ #vk.33 )
      next
        case c_exp
        by solve( !KU( ~x ) @ #vk.35 )
      qed
    qed
  qed
qed

lemma secret_response:
  all-traces
  "∀ tid T gx gy req resp #j #k.
    ((T_Answer( tid, T, gx, gy, req, resp ) @ #j) ∧
     (!KU( resp ) @ #k)) ⇒
    ((∃ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ∧ (#i < #k)) ∨
     (∃ #i. (!KU( req ) @ #i) ∧ (#i < #k)))"
/*
guarded formula characterizing all counter-examples:
"∃ tid T gx gy req resp #j #k.
  (T_Answer( tid, T, gx, gy, req, resp ) @ #j) ∧ (!KU( resp ) @ #k)
 ∧
  (∀ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ⇒ ¬(#i < #k)) ∧
  (∀ #i. (!KU( req ) @ #i) ⇒ ¬(#i < #k))"
*/
simplify
solve( !Ltk( $T, <~key_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
  case Generate_DH_key_pair
  solve( !KU( ~key_id ) @ #vk.4 )
    case C_QueryGeneration
    solve( !KU( ~resp ) @ #k.1 )
      case NonceReuse
      solve( !KU( ~k ) @ #vk.12 )
        case RevSK
        solve( !KU( aead(Expand(Extract('blank',
                                        <'HPKE_v1', 'eae_prk', z>),
                                <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                         Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                 Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                                '32'),
                         <~key_id, $kdf_id, $aead_id>, req)
               ) @ #vk.12 )
          case C_QueryGeneration
          solve( !KU( ~k.3 ) @ #vk.14 )
            case RevSK
            solve( !KU( aead(k.3, n, a1, ~resp) ) @ #vk.4 )
              case T_HandleQuery
              solve( !KU( aead(Expand(Extract(~req,
                                              Expand(Expand(Extract(<
                                                                     Expand(Extract('blank',
                                                                                    <'HPKE_v1', 
                                                                                     'eae_prk', 
                                                                                     'g'^(~x*~y)>),
                                                                            <'32', 'HPKE_v1', 
                                                                             'shared_secret', 
                                                                             'g'^~x, 'g'^~y>,
                                                                            '32'), 
                                                                     ~resp_nonce>,
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x01', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'request'>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                      'key', '32'),
                               Expand(Extract(~req,
                                              Expand(Expand(Extract(<
                                                                     Expand(Extract('blank',
                                                                                    <'HPKE_v1', 
                                                                                     'eae_prk', 
                                                                                     'g'^(~x*~y)>),
                                                                            <'32', 'HPKE_v1', 
                                                                             'shared_secret', 
                                                                             'g'^~x, 'g'^~y>,
                                                                            '32'), 
                                                                     ~resp_nonce>,
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x01', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'request'>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                      'nonce', '32'),
                               a2, p2)
                     ) @ #vk.14 )
                case T_HandleQuery
                by contradiction /* from formulas */
              next
                case c_aead
                solve( !KU( Expand(Extract(~req,
                                           Expand(Expand(Extract(<
                                                                  Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'), 
                                                                  ~resp_nonce>,
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x01', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 'request'
                                                                  >)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                   'key', '32')
                       ) @ #vk.15 )
                  case c_Expand
                  solve( !KU( Expand(Extract(~req,
                                             Expand(Expand(Extract(<
                                                                    Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'), 
                                                                    ~resp_nonce>,
                                                                   <'HPKE_v1', 'secret', 'blank'>),
                                                           <'32', 'HPKE_v1', 'exp', '0x01', 
                                                            Extract('blank',
                                                                    <'HPKE_v1', 'info_hash', 
                                                                     'request'>)
                                                           >,
                                                           '32'),
                                                    <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                     'nonce', '32')
                         ) @ #vk.16 )
                    case c_Expand
                    solve( !KU( Extract(~req,
                                        Expand(Expand(Extract(<
                                                               Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~y)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~y>,
                                                                      '32'), 
                                                               ~resp_nonce>,
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 'request'>)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'blank'>, '32'))
                           ) @ #vk.19 )
                      case c_Extract
                      by contradiction /* from formulas */
                    qed
                  qed
                qed
              qed
            next
              case c_aead
              by contradiction /* cyclic */
            qed
          qed
        next
          case P_HandleQuery
          solve( !KU( aead(k.2, n, a1, ~resp) ) @ #vk.3 )
            case T_HandleQuery
            solve( !KU( aead(Expand(Extract(~req,
                                            Expand(Expand(Extract(<
                                                                   Expand(Extract('blank',
                                                                                  <'HPKE_v1', 
                                                                                   'eae_prk', 
                                                                                   'g'^(~x*~y)>),
                                                                          <'32', 'HPKE_v1', 
                                                                           'shared_secret', 'g'^~x, 
                                                                           'g'^~y>,
                                                                          '32'), 
                                                                   ~resp_nonce>,
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'request'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                    'key', '32'),
                             Expand(Extract(~req,
                                            Expand(Expand(Extract(<
                                                                   Expand(Extract('blank',
                                                                                  <'HPKE_v1', 
                                                                                   'eae_prk', 
                                                                                   'g'^(~x*~y)>),
                                                                          <'32', 'HPKE_v1', 
                                                                           'shared_secret', 'g'^~x, 
                                                                           'g'^~y>,
                                                                          '32'), 
                                                                   ~resp_nonce>,
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'request'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                    'nonce', '32'),
                             a2, p2)
                   ) @ #vk.13 )
              case T_HandleQuery
              by contradiction /* from formulas */
            next
              case c_aead
              solve( !KU( Expand(Extract(~req,
                                         Expand(Expand(Extract(<
                                                                Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'), 
                                                                ~resp_nonce>,
                                                               <'HPKE_v1', 'secret', 'blank'>),
                                                       <'32', 'HPKE_v1', 'exp', '0x01', 
                                                        Extract('blank',
                                                                <'HPKE_v1', 'info_hash', 'request'>)
                                                       >,
                                                       '32'),
                                                <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                 'key', '32')
                     ) @ #vk.15 )
                case c_Expand
                solve( !KU( Expand(Extract(~req,
                                           Expand(Expand(Extract(<
                                                                  Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'), 
                                                                  ~resp_nonce>,
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x01', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 'request'
                                                                  >)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                   'nonce', '32')
                       ) @ #vk.16 )
                  case c_Expand
                  solve( !KU( Extract(~req,
                                      Expand(Expand(Extract(<
                                                             Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~y)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 'g'^~y
                                                                    >,
                                                                    '32'), 
                                                             ~resp_nonce>,
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 'request'>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'blank'>, '32'))
                         ) @ #vk.19 )
                    case c_Extract
                    by contradiction /* from formulas */
                  qed
                qed
              qed
            qed
          next
            case c_aead
            by contradiction /* cyclic */
          qed
        next
          case c_aead
          by contradiction /* from formulas */
        qed
      qed
    next
      case T_HandleQuery
      by contradiction /* from formulas */
    qed
  next
    case Generate_DH_key_pair
    solve( !KU( ~resp ) @ #k )
      case NonceReuse
      solve( !KU( aead(Expand(Extract('blank',
                                      <'HPKE_v1', 'eae_prk', z>),
                              <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                       Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                             <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                               Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                              '32'),
                       <~key_id, $kdf_id, $aead_id>, req)
             ) @ #vk.11 )
        case C_QueryGeneration
        solve( !KU( ~k.2 ) @ #vk.13 )
          case RevSK
          solve( !KU( aead(k.2, n, a1, ~resp) ) @ #vk.3 )
            case T_HandleQuery
            solve( !KU( aead(Expand(Extract(~req,
                                            Expand(Expand(Extract(<
                                                                   Expand(Extract('blank',
                                                                                  <'HPKE_v1', 
                                                                                   'eae_prk', 
                                                                                   'g'^(~x*~y)>),
                                                                          <'32', 'HPKE_v1', 
                                                                           'shared_secret', 'g'^~x, 
                                                                           'g'^~y>,
                                                                          '32'), 
                                                                   ~resp_nonce>,
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'request'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                    'key', '32'),
                             Expand(Extract(~req,
                                            Expand(Expand(Extract(<
                                                                   Expand(Extract('blank',
                                                                                  <'HPKE_v1', 
                                                                                   'eae_prk', 
                                                                                   'g'^(~x*~y)>),
                                                                          <'32', 'HPKE_v1', 
                                                                           'shared_secret', 'g'^~x, 
                                                                           'g'^~y>,
                                                                          '32'), 
                                                                   ~resp_nonce>,
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'request'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                    'nonce', '32'),
                             a2, p2)
                   ) @ #vk.13 )
              case T_HandleQuery
              by contradiction /* from formulas */
            next
              case c_aead
              solve( !KU( Expand(Extract(~req,
                                         Expand(Expand(Extract(<
                                                                Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'), 
                                                                ~resp_nonce>,
                                                               <'HPKE_v1', 'secret', 'blank'>),
                                                       <'32', 'HPKE_v1', 'exp', '0x01', 
                                                        Extract('blank',
                                                                <'HPKE_v1', 'info_hash', 'request'>)
                                                       >,
                                                       '32'),
                                                <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                 'key', '32')
                     ) @ #vk.14 )
                case c_Expand
                solve( !KU( Expand(Extract(~req,
                                           Expand(Expand(Extract(<
                                                                  Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'), 
                                                                  ~resp_nonce>,
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x01', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 'request'
                                                                  >)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                   'nonce', '32')
                       ) @ #vk.15 )
                  case c_Expand
                  solve( !KU( Extract(~req,
                                      Expand(Expand(Extract(<
                                                             Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~y)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 'g'^~y
                                                                    >,
                                                                    '32'), 
                                                             ~resp_nonce>,
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 'request'>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'blank'>, '32'))
                         ) @ #vk.18 )
                    case c_Extract
                    by contradiction /* from formulas */
                  qed
                qed
              qed
            qed
          next
            case c_aead
            by contradiction /* cyclic */
          qed
        qed
      next
        case P_HandleQuery
        solve( !KU( aead(k.1, n, a1, ~resp) ) @ #vk.2 )
          case T_HandleQuery
          solve( !KU( aead(Expand(Extract(~req,
                                          Expand(Expand(Extract(<
                                                                 Expand(Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'eae_prk', 
                                                                                 'g'^(~x*~y)>),
                                                                        <'32', 'HPKE_v1', 
                                                                         'shared_secret', 'g'^~x, 
                                                                         'g'^~y>,
                                                                        '32'), 
                                                                 ~resp_nonce>,
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x01', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 'request'
                                                                 >)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                  'key', '32'),
                           Expand(Extract(~req,
                                          Expand(Expand(Extract(<
                                                                 Expand(Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'eae_prk', 
                                                                                 'g'^(~x*~y)>),
                                                                        <'32', 'HPKE_v1', 
                                                                         'shared_secret', 'g'^~x, 
                                                                         'g'^~y>,
                                                                        '32'), 
                                                                 ~resp_nonce>,
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x01', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 'request'
                                                                 >)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                  'nonce', '32'),
                           a2, p2)
                 ) @ #vk.12 )
            case T_HandleQuery
            by contradiction /* from formulas */
          next
            case c_aead
            solve( !KU( Expand(Extract(~req,
                                       Expand(Expand(Extract(<
                                                              Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~y)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~y>,
                                                                     '32'), 
                                                              ~resp_nonce>,
                                                             <'HPKE_v1', 'secret', 'blank'>),
                                                     <'32', 'HPKE_v1', 'exp', '0x01', 
                                                      Extract('blank',
                                                              <'HPKE_v1', 'info_hash', 'request'>)
                                                     >,
                                                     '32'),
                                              <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                               'key', '32')
                   ) @ #vk.14 )
              case c_Expand
              solve( !KU( Expand(Extract(~req,
                                         Expand(Expand(Extract(<
                                                                Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'), 
                                                                ~resp_nonce>,
                                                               <'HPKE_v1', 'secret', 'blank'>),
                                                       <'32', 'HPKE_v1', 'exp', '0x01', 
                                                        Extract('blank',
                                                                <'HPKE_v1', 'info_hash', 'request'>)
                                                       >,
                                                       '32'),
                                                <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                 'nonce', '32')
                     ) @ #vk.15 )
                case c_Expand
                solve( !KU( Extract(~req,
                                    Expand(Expand(Extract(<
                                                           Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', 
                                                                           'g'^(~x*~y)>),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', 'g'^~x, 'g'^~y>,
                                                                  '32'), 
                                                           ~resp_nonce>,
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 'request'>)
                                                  >,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'blank'>, '32'))
                       ) @ #vk.18 )
                  case c_Extract
                  by contradiction /* from formulas */
                qed
              qed
            qed
          qed
        next
          case c_aead
          by contradiction /* cyclic */
        qed
      next
        case c_aead
        by contradiction /* from formulas */
      qed
    next
      case T_HandleQuery
      by contradiction /* from formulas */
    qed
  next
    case P_HandleQuery
    solve( !KU( ~resp ) @ #k.1 )
      case NonceReuse
      solve( !KU( aead(Expand(Extract('blank',
                                      <'HPKE_v1', 'eae_prk', z>),
                              <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                       Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                             <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                               Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                              '32'),
                       <~key_id, $kdf_id, $aead_id>, req)
             ) @ #vk.11 )
        case C_QueryGeneration
        solve( !KU( ~k.3 ) @ #vk.14 )
          case RevSK
          solve( !KU( senc(<cid, <~key_id, $kdf_id, $aead_id>, gx, opaque>,
                           ~k.1)
                 ) @ #vk.13 )
            case C_QueryGeneration
            solve( !KU( aead(k.3, n, a1, ~resp) ) @ #vk.4 )
              case T_HandleQuery
              solve( !KU( aead(Expand(Extract(~req,
                                              Expand(Expand(Extract(<
                                                                     Expand(Extract('blank',
                                                                                    <'HPKE_v1', 
                                                                                     'eae_prk', 
                                                                                     'g'^(~x*~y)>),
                                                                            <'32', 'HPKE_v1', 
                                                                             'shared_secret', 
                                                                             'g'^~x, 'g'^~y>,
                                                                            '32'), 
                                                                     ~resp_nonce>,
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x01', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'request'>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                      'key', '32'),
                               Expand(Extract(~req,
                                              Expand(Expand(Extract(<
                                                                     Expand(Extract('blank',
                                                                                    <'HPKE_v1', 
                                                                                     'eae_prk', 
                                                                                     'g'^(~x*~y)>),
                                                                            <'32', 'HPKE_v1', 
                                                                             'shared_secret', 
                                                                             'g'^~x, 'g'^~y>,
                                                                            '32'), 
                                                                     ~resp_nonce>,
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x01', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'request'>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                      'nonce', '32'),
                               a2, p2)
                     ) @ #vk.14 )
                case T_HandleQuery
                by contradiction /* from formulas */
              next
                case c_aead
                solve( !KU( Expand(Extract(~req,
                                           Expand(Expand(Extract(<
                                                                  Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'), 
                                                                  ~resp_nonce>,
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x01', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 'request'
                                                                  >)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                   'key', '32')
                       ) @ #vk.15 )
                  case c_Expand
                  solve( !KU( Expand(Extract(~req,
                                             Expand(Expand(Extract(<
                                                                    Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'), 
                                                                    ~resp_nonce>,
                                                                   <'HPKE_v1', 'secret', 'blank'>),
                                                           <'32', 'HPKE_v1', 'exp', '0x01', 
                                                            Extract('blank',
                                                                    <'HPKE_v1', 'info_hash', 
                                                                     'request'>)
                                                           >,
                                                           '32'),
                                                    <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                     'nonce', '32')
                         ) @ #vk.16 )
                    case c_Expand
                    solve( !KU( Extract(~req,
                                        Expand(Expand(Extract(<
                                                               Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~y)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~y>,
                                                                      '32'), 
                                                               ~resp_nonce>,
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 'request'>)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'blank'>, '32'))
                           ) @ #vk.19 )
                      case c_Extract
                      by contradiction /* from formulas */
                    qed
                  qed
                qed
              qed
            next
              case c_aead
              by contradiction /* cyclic */
            qed
          next
            case P_HandleResponse
            by contradiction /* cyclic */
          next
            case c_senc
            by contradiction /* cyclic */
          qed
        qed
      next
        case P_HandleQuery
        solve( !KU( senc(<cid, <~key_id, $kdf_id, $aead_id>, gx, opaque>,
                         ~k.1)
               ) @ #vk.12 )
          case C_QueryGeneration
          solve( !KU( aead(k.3, n, a1, ~resp) ) @ #vk.3 )
            case T_HandleQuery
            solve( !KU( aead(Expand(Extract(~req,
                                            Expand(Expand(Extract(<
                                                                   Expand(Extract('blank',
                                                                                  <'HPKE_v1', 
                                                                                   'eae_prk', 
                                                                                   'g'^(~x*~y)>),
                                                                          <'32', 'HPKE_v1', 
                                                                           'shared_secret', 'g'^~x, 
                                                                           'g'^~y>,
                                                                          '32'), 
                                                                   ~resp_nonce>,
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'request'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                    'key', '32'),
                             Expand(Extract(~req,
                                            Expand(Expand(Extract(<
                                                                   Expand(Extract('blank',
                                                                                  <'HPKE_v1', 
                                                                                   'eae_prk', 
                                                                                   'g'^(~x*~y)>),
                                                                          <'32', 'HPKE_v1', 
                                                                           'shared_secret', 'g'^~x, 
                                                                           'g'^~y>,
                                                                          '32'), 
                                                                   ~resp_nonce>,
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'request'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                    'nonce', '32'),
                             a2, p2)
                   ) @ #vk.13 )
              case T_HandleQuery
              by contradiction /* from formulas */
            next
              case c_aead
              solve( !KU( Expand(Extract(~req,
                                         Expand(Expand(Extract(<
                                                                Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'), 
                                                                ~resp_nonce>,
                                                               <'HPKE_v1', 'secret', 'blank'>),
                                                       <'32', 'HPKE_v1', 'exp', '0x01', 
                                                        Extract('blank',
                                                                <'HPKE_v1', 'info_hash', 'request'>)
                                                       >,
                                                       '32'),
                                                <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                 'key', '32')
                     ) @ #vk.15 )
                case c_Expand
                solve( !KU( Expand(Extract(~req,
                                           Expand(Expand(Extract(<
                                                                  Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'), 
                                                                  ~resp_nonce>,
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x01', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 'request'
                                                                  >)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                   'nonce', '32')
                       ) @ #vk.16 )
                  case c_Expand
                  solve( !KU( Extract(~req,
                                      Expand(Expand(Extract(<
                                                             Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~y)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 'g'^~y
                                                                    >,
                                                                    '32'), 
                                                             ~resp_nonce>,
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 'request'>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'blank'>, '32'))
                         ) @ #vk.19 )
                    case c_Extract
                    by contradiction /* from formulas */
                  qed
                qed
              qed
            qed
          next
            case c_aead
            by contradiction /* cyclic */
          qed
        next
          case P_HandleResponse
          by contradiction /* cyclic */
        next
          case c_senc
          by contradiction /* cyclic */
        qed
      next
        case c_aead
        by contradiction /* from formulas */
      qed
    next
      case T_HandleQuery
      by contradiction /* from formulas */
    qed
  qed
qed

lemma secret_cid [reuse]:
  all-traces
  "∀ C gx P key T gy cid req #j #k.
    ((C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧
     (!KU( cid ) @ #k)) ⇒
    (∃ #i. (RevSk( key ) @ #i) ∧ (#i < #k))"
/*
guarded formula characterizing all counter-examples:
"∃ C gx P key T gy cid req #j #k.
  (C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧ (!KU( cid ) @ #k)
 ∧
  ∀ #i. (RevSk( key ) @ #i) ⇒ ¬(#i < #k)"
*/
simplify
solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
  case Starter
  solve( !Pk( $T, <~key_id, kdf_id, aead_id>, gy ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~cid ) @ #k.1 )
      case C_QueryGeneration
      solve( !KU( ~k ) @ #vk )
        case RevSK
        by contradiction /* from formulas */
      qed
    qed
  qed
qed

lemma request_binding:
  all-traces
  "∀ C gx P key T gy cid req #j #k #l.
    (((C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧
      (!KU( req ) @ #k)) ∧
     (!KU( cid ) @ #l)) ⇒
    (∃ sig_algs #h #i.
      (((RevDH( T, sig_algs, gy ) @ #h) ∧ (#h < #k)) ∧
       (RevSk( key ) @ #i)) ∧
      (#i < #l))"
/*
guarded formula characterizing all counter-examples:
"∃ C gx P key T gy cid req #j #k #l.
  (C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧
  (!KU( req ) @ #k) ∧
  (!KU( cid ) @ #l)
 ∧
  ∀ sig_algs #h #i.
   (RevDH( T, sig_algs, gy ) @ #h) ∧ (RevSk( key ) @ #i)
  ⇒
   ((¬(#h < #k)) ∨ (¬(#i < #l)))"
*/
simplify
by contradiction /* from formulas */

lemma consistency:
  all-traces
  "∀ req resp C gx T gy #j.
    (C_Done( req, resp, C, gx, T, gy ) @ #j) ⇒
    ((∃ tid #i.
       (T_Answer( tid, T, gx, gy, req, resp ) @ #i) ∧ (#i < #j)) ∨
     (∃ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ∧ (#i < #j)))"
/*
guarded formula characterizing all counter-examples:
"∃ req resp C gx T gy #j.
  (C_Done( req, resp, C, gx, T, gy ) @ #j)
 ∧
  (∀ tid #i.
    (T_Answer( tid, T, gx, gy, req, resp ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ⇒ ¬(#i < #j))"
*/
simplify
solve( C_ResponseHandler( ~request, $C, gx, $P, ~k, $T, gy,
                          shared_secret
       ) ▶₀ #j )
  case C_QueryGeneration
  solve( !KU( senc(<response_nonce, 
                    aead(Expand(Extract(~request,
                                        Expand(Expand(Extract(<
                                                               Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~x.1)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~x.1>,
                                                                      '32'), 
                                                               response_nonce>,
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 'request'>)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                'key', '32'),
                         Expand(Extract(~request,
                                        Expand(Expand(Extract(<
                                                               Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~x.1)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~x.1>,
                                                                      '32'), 
                                                               response_nonce>,
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 'request'>)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                                'nonce', '32'),
                         'blank', resp)
                   >,
                   ~k)
         ) @ #vk )
    case P_HandleResponse
    solve( !KU( aead(Expand(Extract(~request,
                                    Expand(Expand(Extract(<
                                                           Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', 
                                                                           'g'^(~x*~x.1)>),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', 'g'^~x, 'g'^~x.1
                                                                  >,
                                                                  '32'), 
                                                           response_nonce>,
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 'request'>)
                                                  >,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                            'key', '32'),
                     Expand(Extract(~request,
                                    Expand(Expand(Extract(<
                                                           Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', 
                                                                           'g'^(~x*~x.1)>),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', 'g'^~x, 'g'^~x.1
                                                                  >,
                                                                  '32'), 
                                                           response_nonce>,
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 'request'>)
                                                  >,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                            'nonce', '32'),
                     'blank', resp)
           ) @ #vk.3 )
      case T_HandleQuery
      by contradiction /* from formulas */
    next
      case c_aead
      solve( !KU( Expand(Extract(~request,
                                 Expand(Expand(Extract(<
                                                        Expand(Extract('blank',
                                                                       <'HPKE_v1', 'eae_prk', 
                                                                        'g'^(~x*~x.1)>),
                                                               <'32', 'HPKE_v1', 'shared_secret', 
                                                                'g'^~x, 'g'^~x.1>,
                                                               '32'), 
                                                        response_nonce>,
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', 
                                                Extract('blank',
                                                        <'HPKE_v1', 'info_hash', 'request'>)
                                               >,
                                               '32'),
                                        <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                         'key', '32')
             ) @ #vk.5 )
        case c_Expand
        solve( !KU( Expand(Extract(~request,
                                   Expand(Expand(Extract(<
                                                          Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^(~x*~x.1)>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g'^~x, 'g'^~x.1>,
                                                                 '32'), 
                                                          response_nonce>,
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x01', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 'request'>)
                                                 >,
                                                 '32'),
                                          <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                           'nonce', '32')
               ) @ #vk.6 )
          case c_Expand
          solve( !KU( Extract(~request,
                              Expand(Expand(Extract(<
                                                     Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     'g'^(~x*~x.1)>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             'g'^~x, 'g'^~x.1>,
                                                            '32'), 
                                                     response_nonce>,
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x01', 
                                             Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)>,
                                            '32'),
                                     <'32', 'HPKE_v1', 'sec', 'blank'>, '32'))
                 ) @ #vk.9 )
            case c_Extract
            by contradiction /* from formulas */
          qed
        qed
      qed
    qed
  next
    case c_senc
    solve( !KU( ~k ) @ #vk.2 )
      case RevSK
      solve( !KU( aead(Expand(Extract(~request,
                                      Expand(Expand(Extract(<
                                                             Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~x.1)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 
                                                                     'g'^~x.1>,
                                                                    '32'), 
                                                             response_nonce>,
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 'request'>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                              'key', '32'),
                       Expand(Extract(~request,
                                      Expand(Expand(Extract(<
                                                             Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~x.1)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 
                                                                     'g'^~x.1>,
                                                                    '32'), 
                                                             response_nonce>,
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 'request'>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                              'nonce', '32'),
                       'blank', resp)
             ) @ #vk.4 )
        case T_HandleQuery
        by contradiction /* from formulas */
      next
        case c_aead
        solve( !KU( Expand(Extract(~request,
                                   Expand(Expand(Extract(<
                                                          Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^(~x*~x.1)>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g'^~x, 'g'^~x.1>,
                                                                 '32'), 
                                                          response_nonce>,
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x01', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 'request'>)
                                                 >,
                                                 '32'),
                                          <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                           'key', '32')
               ) @ #vk.5 )
          case c_Expand
          solve( !KU( Expand(Extract(~request,
                                     Expand(Expand(Extract(<
                                                            Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~x.1)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 
                                                                    'g'^~x.1>,
                                                                   '32'), 
                                                            response_nonce>,
                                                           <'HPKE_v1', 'secret', 'blank'>),
                                                   <'32', 'HPKE_v1', 'exp', '0x01', 
                                                    Extract('blank',
                                                            <'HPKE_v1', 'info_hash', 'request'>)
                                                   >,
                                                   '32'),
                                            <'32', 'HPKE_v1', 'sec', 'blank'>, '32')),
                             'nonce', '32')
                 ) @ #vk.6 )
            case c_Expand
            solve( !KU( Extract(~request,
                                Expand(Expand(Extract(<
                                                       Expand(Extract('blank',
                                                                      <'HPKE_v1', 'eae_prk', 
                                                                       'g'^(~x*~x.1)>),
                                                              <'32', 'HPKE_v1', 'shared_secret', 
                                                               'g'^~x, 'g'^~x.1>,
                                                              '32'), 
                                                       response_nonce>,
                                                      <'HPKE_v1', 'secret', 'blank'>),
                                              <'32', 'HPKE_v1', 'exp', '0x01', 
                                               Extract('blank', <'HPKE_v1', 'info_hash', 'request'>)
                                              >,
                                              '32'),
                                       <'32', 'HPKE_v1', 'sec', 'blank'>, '32'))
                   ) @ #vk.9 )
              case c_Extract
              by contradiction /* from formulas */
            qed
          qed
        qed
      qed
    qed
  qed
qed

/* All well-formedness checks were successful. */

end