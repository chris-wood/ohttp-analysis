theory OHTTP begin

// Function signature and definition of the equational theory E

builtins: diffie-hellman
functions: Expand/3, Extract/2, fst/1, h/1, hmac/1, open/4, pair/2,
           pk/1, sdec/2, seal/4, senc/2, sign/2, snd/1, true/0, verify/3
equations:
    fst(<x.1, x.2>) = x.1,
    open(k, n, a, seal(k, n, a, p)) = p,
    sdec(senc(x.1, x.2), x.2) = x.1,
    snd(<x.1, x.2>) = x.2,
    verify(sign(x.1, x.2), x.1, pk(x.2)) = true



restriction Eq_check_succeed:
  "∀ x y #i. (Eq( x, y ) @ #i) ⇒ (x = y)"
  // safety formula

restriction Neq_check_succeed:
  "∀ x y #i. (Neq( x, y ) @ #i) ⇒ (¬(x = y))"
  // safety formula

restriction VerifyPSKInputs_succeed:
  "∀ mode psk psk_id #i.
    (VerifyPSKInputs( mode, psk, psk_id ) @ #i) ⇒
    ((((psk = 'blank') ∧ (psk_id = 'blank')) ∧ (mode = '0x00')) ∨
     (((¬(psk = 'blank')) ∧ (¬(psk_id = 'blank'))) ∧ (mode = '0x01')))"
  // safety formula

rule (modulo E) Starter:
   [ Fr( ~kxy ) ]
  --[ Channel( $X, $Y ) ]->
   [
   KeyExC( $X, $Y, ~kxy ), KeyExS( $X, $Y, ~kxy ),
   KeyExI( $X, $Y, ~kxy )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Generate_DH_key_pair:
   [ Fr( ~x ), Fr( ~key_id ) ]
  -->
   [
   !Pk( $A, <~key_id, $kem_id, $kdf_id, $aead_id>, 'g'^~x ),
   Out( <~key_id, 'g'^~x> ),
   !Ltk( $A, <~key_id, $kem_id, $kdf_id, $aead_id>, ~x )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) C_QueryGeneration:
   [
   KeyExC( $C, $P, ~k ),
   !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, gy ), Fr( ~x ),
   Fr( ~req ), Fr( ~cid )
   ]
  --[
  Neq( $P, $T ),
  CQG_sources( 'g'^~x,
               seal(Expand(Extract(Expand(Extract('blank',
                                                  <'HPKE_v1', 'eae_prk', gy^~x>),
                                          <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                   <'HPKE_v1', 'secret', 'blank'>),
                           <'32', 'HPKE_v1', 'key', '0x00', 
                            Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                            Extract('blank',
                                    <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                     ~key_id, kem_id, kdf_id, aead_id>)
                           >,
                           '32'),
                    Expand(Extract(Expand(Extract('blank',
                                                  <'HPKE_v1', 'eae_prk', gy^~x>),
                                          <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                   <'HPKE_v1', 'secret', 'blank'>),
                           <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                            Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                            Extract('blank',
                                    <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                     ~key_id, kem_id, kdf_id, aead_id>)
                           >,
                           '32'),
                    <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                    >,
                    ~req)
  ),
  C_SS( 'g'^~x, gy,
        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy^~x>),
               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32')
  ),
  C_QG( $C, 'g'^~x, $P, ~k, $T, gy, ~cid, ~req ),
  VerifyPSKInputs( '0x00', 'blank', 'blank' )
  ]->
   [
   Out( senc(<~cid, <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x, 
              seal(Expand(Extract(Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', gy^~x>),
                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                  <'HPKE_v1', 'secret', 'blank'>),
                          <'32', 'HPKE_v1', 'key', '0x00', 
                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                           Extract('blank',
                                   <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                    ~key_id, kem_id, kdf_id, aead_id>)
                          >,
                          '32'),
                   Expand(Extract(Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', gy^~x>),
                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                  <'HPKE_v1', 'secret', 'blank'>),
                          <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                           Extract('blank',
                                   <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                    ~key_id, kem_id, kdf_id, aead_id>)
                          >,
                          '32'),
                   <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                   >,
                   ~req)
             >,
             ~k)
   ),
   C_ResponseHandler( ~req, $C, 'g'^~x, $P, ~k, $T, gy,
                      Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy^~x>),
                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                      <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id>
   )
   ]
 variants
  rule (modulo AC) C_QueryGeneration___VARIANT_1:
     [
     KeyExC( $C, $P, ~k ),
     !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, gy.2 ), Fr( ~x.1 ),
     Fr( ~req ), Fr( ~cid )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         gy.2^~x.1>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, gy.2>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'key', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         gy.2^~x.1>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, gy.2>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          <'message_bhttp_request', '0x00', ~key_id, kem_id, 
                                           kdf_id, aead_id>,
                                          ~req)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        gy.2^~x.1>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, gy.2>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        gy.2^~x.1>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, gy.2>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        gy.2^~x.1>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, gy.2>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        gy.2^~x.1>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, gy.2>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    Neq( $P, $T ),
    CQG_sources( 'g'^~x.1,
                 seal(Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', gy.2^~x.1>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, gy.2>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'key', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', gy.2^~x.1>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, gy.2>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                      >,
                      ~req)
    ),
    C_SS( 'g'^~x.1, gy.2,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy.2^~x.1>),
                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, gy.2>, '32')
    ),
    C_QG( $C, 'g'^~x.1, $P, ~k, $T, gy.2, ~cid, ~req ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( senc(<~cid, <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', gy.2^~x.1>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, gy.2>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', gy.2^~x.1>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, gy.2>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                     >,
                     ~req)
               >,
               ~k)
     ),
     C_ResponseHandler( ~req, $C, 'g'^~x.1, $P, ~k, $T, gy.2,
                        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy.2^~x.1>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, gy.2>, '32'),
                        <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id>
     )
     ]
  ,
  rule (modulo AC) C_QueryGeneration___VARIANT_2:
     [
     KeyExC( $C, $P, ~k ),
     !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, z.2^inv(~x.1) ),
     Fr( ~x.1 ), Fr( ~req ), Fr( ~cid )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', z.2
                                                                        >),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, z.2^inv(~x.1)>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'key', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', z.2
                                                                        >),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, z.2^inv(~x.1)>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          <'message_bhttp_request', '0x00', ~key_id, kem_id, 
                                           kdf_id, aead_id>,
                                          ~req)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        z.2>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                z.2^inv(~x.1)>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        z.2>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                z.2^inv(~x.1)>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        z.2>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                z.2^inv(~x.1)>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        z.2>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                z.2^inv(~x.1)>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    Neq( $P, $T ),
    CQG_sources( 'g'^~x.1,
                 seal(Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', z.2>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                             z.2^inv(~x.1)>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'key', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', z.2>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                             z.2^inv(~x.1)>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                      >,
                      ~req)
    ),
    C_SS( 'g'^~x.1, z.2^inv(~x.1),
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z.2>),
                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, z.2^inv(~x.1)>, '32')
    ),
    C_QG( $C, 'g'^~x.1, $P, ~k, $T, z.2^inv(~x.1), ~cid, ~req ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( senc(<~cid, <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', z.2>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                            z.2^inv(~x.1)>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', z.2>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                            z.2^inv(~x.1)>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                     >,
                     ~req)
               >,
               ~k)
     ),
     C_ResponseHandler( ~req, $C, 'g'^~x.1, $P, ~k, $T, z.2^inv(~x.1),
                        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z.2>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, z.2^inv(~x.1)>, '32'),
                        <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id>
     )
     ]
  ,
  rule (modulo AC) C_QueryGeneration___VARIANT_3:
     [
     KeyExC( $C, $P, ~k ),
     !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, x.2^x.3 ), Fr( ~x.1 ),
     Fr( ~req ), Fr( ~cid )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         x.2^(~x.1*x.3)>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, x.2^x.3>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'key', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         x.2^(~x.1*x.3)>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, x.2^x.3>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          <'message_bhttp_request', '0x00', ~key_id, kem_id, 
                                           kdf_id, aead_id>,
                                          ~req)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^(~x.1*
                                                                                             x.3)
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, x.2^x.3>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^(~x.1*
                                                                                             x.3)
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, x.2^x.3>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^(~x.1*
                                                                                             x.3)
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, x.2^x.3>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^(~x.1*
                                                                                             x.3)
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, x.2^x.3>,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    Neq( $P, $T ),
    CQG_sources( 'g'^~x.1,
                 seal(Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', x.2^(~x.1*x.3)>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^x.3>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'key', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', x.2^(~x.1*x.3)>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^x.3>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                      >,
                      ~req)
    ),
    C_SS( 'g'^~x.1, x.2^x.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.2^(~x.1*x.3)>),
                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^x.3>, '32')
    ),
    C_QG( $C, 'g'^~x.1, $P, ~k, $T, x.2^x.3, ~cid, ~req ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( senc(<~cid, <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x.2^(~x.1*x.3)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^x.3>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x.2^(~x.1*x.3)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^x.3>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                     >,
                     ~req)
               >,
               ~k)
     ),
     C_ResponseHandler( ~req, $C, 'g'^~x.1, $P, ~k, $T, x.2^x.3,
                        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.2^(~x.1*x.3)>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^x.3>, '32'),
                        <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id>
     )
     ]
  ,
  rule (modulo AC) C_QueryGeneration___VARIANT_4:
     [
     KeyExC( $C, $P, ~k ),
     !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, x.2^inv((~x.1*x.3)) ),
     Fr( ~x.1 ), Fr( ~req ), Fr( ~cid )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         x.2^inv(x.3)>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, x.2^inv((~x.1*x.3))>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'key', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         x.2^inv(x.3)>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, x.2^inv((~x.1*x.3))>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          <'message_bhttp_request', '0x00', ~key_id, kem_id, 
                                           kdf_id, aead_id>,
                                          ~req)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^inv(x.3)
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^inv((~x.1*x.3))
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^inv(x.3)
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^inv((~x.1*x.3))
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^inv(x.3)
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^inv((~x.1*x.3))
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^inv(x.3)
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^inv((~x.1*x.3))
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    Neq( $P, $T ),
    CQG_sources( 'g'^~x.1,
                 seal(Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', x.2^inv(x.3)>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                             x.2^inv((~x.1*x.3))>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'key', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', x.2^inv(x.3)>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                             x.2^inv((~x.1*x.3))>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                      >,
                      ~req)
    ),
    C_SS( 'g'^~x.1, x.2^inv((~x.1*x.3)),
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.2^inv(x.3)>),
                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^inv((~x.1*x.3))>,
                 '32')
    ),
    C_QG( $C, 'g'^~x.1, $P, ~k, $T, x.2^inv((~x.1*x.3)), ~cid, ~req ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( senc(<~cid, <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x.2^inv(x.3)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                            x.2^inv((~x.1*x.3))>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x.2^inv(x.3)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                            x.2^inv((~x.1*x.3))>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                     >,
                     ~req)
               >,
               ~k)
     ),
     C_ResponseHandler( ~req, $C, 'g'^~x.1, $P, ~k, $T,
                        x.2^inv((~x.1*x.3)),
                        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.2^inv(x.3)>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^inv((~x.1*x.3))>,
                               '32'),
                        <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id>
     )
     ]
  ,
  rule (modulo AC) C_QueryGeneration___VARIANT_5:
     [
     KeyExC( $C, $P, ~k ),
     !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, x.2^(x.3*inv(~x.1)) ),
     Fr( ~x.1 ), Fr( ~req ), Fr( ~cid )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         x.2^x.3>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, x.2^(x.3*inv(~x.1))>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'key', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         x.2^x.3>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, x.2^(x.3*inv(~x.1))>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          <'message_bhttp_request', '0x00', ~key_id, kem_id, 
                                           kdf_id, aead_id>,
                                          ~req)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^x.3>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^(x.3*inv(~x.1))
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^x.3>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^(x.3*inv(~x.1))
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^x.3>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^(x.3*inv(~x.1))
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^x.3>),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^(x.3*inv(~x.1))
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    Neq( $P, $T ),
    CQG_sources( 'g'^~x.1,
                 seal(Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', x.2^x.3>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                             x.2^(x.3*inv(~x.1))>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'key', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', x.2^x.3>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                             x.2^(x.3*inv(~x.1))>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                      >,
                      ~req)
    ),
    C_SS( 'g'^~x.1, x.2^(x.3*inv(~x.1)),
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.2^x.3>),
                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^(x.3*inv(~x.1))>,
                 '32')
    ),
    C_QG( $C, 'g'^~x.1, $P, ~k, $T, x.2^(x.3*inv(~x.1)), ~cid, ~req ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( senc(<~cid, <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x.2^x.3>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                            x.2^(x.3*inv(~x.1))>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x.2^x.3>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                            x.2^(x.3*inv(~x.1))>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                     >,
                     ~req)
               >,
               ~k)
     ),
     C_ResponseHandler( ~req, $C, 'g'^~x.1, $P, ~k, $T,
                        x.2^(x.3*inv(~x.1)),
                        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.2^x.3>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, x.2^(x.3*inv(~x.1))>,
                               '32'),
                        <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id>
     )
     ]
  ,
  rule (modulo AC) C_QueryGeneration___VARIANT_6:
     [
     KeyExC( $C, $P, ~k ),
     !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>,
          x.2^(x.3*inv((~x.1*x.4)))
     ),
     Fr( ~x.1 ), Fr( ~req ), Fr( ~cid )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         x.2^(x.3*inv(x.4))>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, x.2^(x.3*inv((~x.1*x.4)))
                                                                >,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'key', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         x.2^(x.3*inv(x.4))>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x.1, x.2^(x.3*inv((~x.1*x.4)))
                                                                >,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, kem_id, kdf_id, aead_id>)
                                                 >,
                                                 '32'),
                                          <'message_bhttp_request', '0x00', ~key_id, kem_id, 
                                           kdf_id, aead_id>,
                                          ~req)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^(x.3*
                                                                                             inv(x.4)
                                                                                            )
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^(x.3*
                                                                                     inv((~x.1*x.4))
                                                                                    )
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^(x.3*
                                                                                             inv(x.4)
                                                                                            )
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^(x.3*
                                                                                     inv((~x.1*x.4))
                                                                                    )
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<~cid, 
                                                    <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                                                    seal(Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^(x.3*
                                                                                             inv(x.4)
                                                                                            )
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^(x.3*
                                                                                     inv((~x.1*x.4))
                                                                                    )
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'key', '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         Expand(Extract(Expand(Extract('blank',
                                                                                       <'HPKE_v1', 
                                                                                        'eae_prk', 
                                                                                        x.2^(x.3*
                                                                                             inv(x.4)
                                                                                            )
                                                                                       >),
                                                                               <'32', 'HPKE_v1', 
                                                                                'shared_secret', 
                                                                                'g'^~x.1, 
                                                                                x.2^(x.3*
                                                                                     inv((~x.1*x.4))
                                                                                    )
                                                                               >,
                                                                               '32'),
                                                                        <'HPKE_v1', 'secret', 
                                                                         'blank'>),
                                                                <'32', 'HPKE_v1', 'base_nonce', 
                                                                 '0x00', 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'psk_id_hash', 
                                                                          'blank'>), 
                                                                 Extract('blank',
                                                                         <'HPKE_v1', 'info_hash', 
                                                                          'message_bhttp_request', 
                                                                          '0x00', ~key_id, kem_id, 
                                                                          kdf_id, aead_id>)
                                                                >,
                                                                '32'),
                                                         <'message_bhttp_request', '0x00', ~key_id, 
                                                          kem_id, kdf_id, aead_id>,
                                                         ~req)
                                                   >,
                                                   ~k)
    ),
    Neq( $P, $T ),
    CQG_sources( 'g'^~x.1,
                 seal(Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', x.2^(x.3*inv(x.4))>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                             x.2^(x.3*inv((~x.1*x.4)))>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'key', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      Expand(Extract(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', x.2^(x.3*inv(x.4))>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                             x.2^(x.3*inv((~x.1*x.4)))>,
                                            '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                              Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                              Extract('blank',
                                      <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                       ~key_id, kem_id, kdf_id, aead_id>)
                             >,
                             '32'),
                      <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                      >,
                      ~req)
    ),
    C_SS( 'g'^~x.1, x.2^(x.3*inv((~x.1*x.4))),
          Expand(Extract('blank',
                         <'HPKE_v1', 'eae_prk', x.2^(x.3*inv(x.4))>),
                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                  x.2^(x.3*inv((~x.1*x.4)))>,
                 '32')
    ),
    C_QG( $C, 'g'^~x.1, $P, ~k, $T, x.2^(x.3*inv((~x.1*x.4))), ~cid,
          ~req
    ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( senc(<~cid, <~key_id, kem_id, kdf_id, aead_id>, 'g'^~x.1, 
                seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x.2^(x.3*inv(x.4))>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                            x.2^(x.3*inv((~x.1*x.4)))>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x.2^(x.3*inv(x.4))>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                            x.2^(x.3*inv((~x.1*x.4)))>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, kem_id, kdf_id, aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                     >,
                     ~req)
               >,
               ~k)
     ),
     C_ResponseHandler( ~req, $C, 'g'^~x.1, $P, ~k, $T,
                        x.2^(x.3*inv((~x.1*x.4))),
                        Expand(Extract('blank',
                                       <'HPKE_v1', 'eae_prk', x.2^(x.3*inv(x.4))>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                x.2^(x.3*inv((~x.1*x.4)))>,
                               '32'),
                        <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id>
     )
     ]

rule (modulo E) P_HandleQuery:
   [
   KeyExS( $C, $P, ~k ),
   In( senc(<cid, <key_id, kem_id, kdf_id, aead_id>, gx, opaque>, ~k)
   ),
   !Pk( $T, <key_id, kem_id, kdf_id, aead_id>, gy ), Fr( ~ptid )
   ]
  --[
  AUTO_IN_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid, 
                                                 <key_id, kem_id, kdf_id, aead_id>, gx, opaque>,
                                                ~k),
                                           opaque
  ),
  AUTO_IN_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid, 
                                                 <key_id, kem_id, kdf_id, aead_id>, gx, opaque>,
                                                ~k),
                                           gx
  ),
  PHQ( gx, opaque )
  ]->
   [
   Out( <$T, <key_id, kem_id, kdf_id, aead_id>, gx, opaque> ),
   P_ResponseHandler( ~ptid, $C, $P, ~k )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) T_HandleQuery:
   [
   In( <$T, <~key_id, kem_id, kdf_id, aead_id>, gx, 
        seal(ckey, cnonce, aad, request)>
   ),
   !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ), Fr( ~ttid ),
   Fr( ~resp ), Fr( ~resp_nonce )
   ]
  --[
  Eq( open(Expand(Extract(Expand(Extract('blank',
                                         <'HPKE_v1', 'eae_prk', gx^~y>),
                                 <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                          <'HPKE_v1', 'secret', 'blank'>),
                  <'32', 'HPKE_v1', 'key', '0x00', 
                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                   Extract('blank',
                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', ~key_id, 
                            kem_id, kdf_id, aead_id>)
                  >,
                  '32'),
           Expand(Extract(Expand(Extract('blank',
                                         <'HPKE_v1', 'eae_prk', gx^~y>),
                                 <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                          <'HPKE_v1', 'secret', 'blank'>),
                  <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                   Extract('blank',
                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', ~key_id, 
                            kem_id, kdf_id, aead_id>)
                  >,
                  '32'),
           <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
           >,
           seal(ckey, cnonce, aad, request)),
      request
  ),
  T_Done( ~ttid ),
  T_SS( gx, 'g'^~y,
        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>),
               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32')
  ),
  T_Answer( ~ttid, $T, gx, 'g'^~y, request, ~resp ),
  VerifyPSKInputs( '0x00', 'blank', 'blank' )
  ]->
   [
   Out( <~resp_nonce, 
         seal(Expand(Extract(<gx, ~resp_nonce>,
                             Expand(Expand(Extract(Expand(Extract('blank',
                                                                  <'HPKE_v1', 'eae_prk', gx^~y>),
                                                          <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                           'g'^~y>,
                                                          '32'),
                                                   <'HPKE_v1', 'secret', 'blank'>),
                                           <'32', 'HPKE_v1', 'exp', '0x00', 
                                            Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                            Extract('blank',
                                                    <'HPKE_v1', 'info_hash', 
                                                     'message_bhttp_request', '0x00', ~key_id, 
                                                     kem_id, kdf_id, aead_id>)
                                           >,
                                           '32'),
                                    <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                     'key', '32'),
              Expand(Extract(<gx, ~resp_nonce>,
                             Expand(Expand(Extract(Expand(Extract('blank',
                                                                  <'HPKE_v1', 'eae_prk', gx^~y>),
                                                          <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                           'g'^~y>,
                                                          '32'),
                                                   <'HPKE_v1', 'secret', 'blank'>),
                                           <'32', 'HPKE_v1', 'exp', '0x00', 
                                            Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                            Extract('blank',
                                                    <'HPKE_v1', 'info_hash', 
                                                     'message_bhttp_request', '0x00', ~key_id, 
                                                     kem_id, kdf_id, aead_id>)
                                           >,
                                           '32'),
                                    <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                     'nonce', '32'),
              'blank', ~resp)
        >
   )
   ]
 variants
  rule (modulo AC) T_HandleQuery___VARIANT_1:
     [
     In( <$T, <~key_id.2, kem_id.10, kdf_id.9, aead_id.5>, gx.8, 
          seal(ckey.6, cnonce.7, aad.4, request.11)>
     ),
     !Ltk( $T, <~key_id.2, kem_id.10, kdf_id.9, aead_id.5>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<gx.8, 
                                                          ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               gx.8^~y.3
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       gx.8, 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.10, 
                                                                                 kdf_id.9, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<gx.8, ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               gx.8^~y.3
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       gx.8, 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.10, 
                                                                                 kdf_id.9, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( open(Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', gx.8^~y.3>),
                                   <'32', 'HPKE_v1', 'shared_secret', gx.8, 'g'^~y.3>, '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'key', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.10, kdf_id.9, aead_id.5>)
                    >,
                    '32'),
             Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', gx.8^~y.3>),
                                   <'32', 'HPKE_v1', 'shared_secret', gx.8, 'g'^~y.3>, '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.10, kdf_id.9, aead_id.5>)
                    >,
                    '32'),
             <'message_bhttp_request', '0x00', ~key_id.2, kem_id.10, kdf_id.9, 
              aead_id.5>,
             seal(ckey.6, cnonce.7, aad.4, request.11)),
        request.11
    ),
    T_Done( ~ttid ),
    T_SS( gx.8, 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx.8^~y.3>),
                 <'32', 'HPKE_v1', 'shared_secret', gx.8, 'g'^~y.3>, '32')
    ),
    T_Answer( ~ttid, $T, gx.8, 'g'^~y.3, request.11, ~resp ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<gx.8, ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', gx.8^~y.3
                                                                    >),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             gx.8, 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.10, kdf_id.9, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<gx.8, ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', gx.8^~y.3
                                                                    >),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             gx.8, 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.10, kdf_id.9, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_2:
     [
     In( <$T, <~key_id.2, kem_id.7, kdf_id.6, aead_id.4>, gx.5, 
          seal(Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', gx.5^~y.3>),
                                     <'32', 'HPKE_v1', 'shared_secret', gx.5, 'g'^~y.3>, '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'key', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.7, kdf_id.6, aead_id.4>)
                      >,
                      '32'),
               Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', gx.5^~y.3>),
                                     <'32', 'HPKE_v1', 'shared_secret', gx.5, 'g'^~y.3>, '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.7, kdf_id.6, aead_id.4>)
                      >,
                      '32'),
               <'message_bhttp_request', '0x00', ~key_id.2, kem_id.7, kdf_id.6, 
                aead_id.4>,
               request.8)
         >
     ),
     !Ltk( $T, <~key_id.2, kem_id.7, kdf_id.6, aead_id.4>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<gx.5, 
                                                          ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               gx.5^~y.3
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       gx.5, 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.7, 
                                                                                 kdf_id.6, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<gx.5, ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               gx.5^~y.3
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       gx.5, 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.7, 
                                                                                 kdf_id.6, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( request.8, request.8 ), T_Done( ~ttid ),
    T_SS( gx.5, 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx.5^~y.3>),
                 <'32', 'HPKE_v1', 'shared_secret', gx.5, 'g'^~y.3>, '32')
    ),
    T_Answer( ~ttid, $T, gx.5, 'g'^~y.3, request.8, ~resp ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<gx.5, ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', gx.5^~y.3
                                                                    >),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             gx.5, 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.7, kdf_id.6, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<gx.5, ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', gx.5^~y.3
                                                                    >),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             gx.5, 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.7, kdf_id.6, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_3:
     [
     In( <$T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, 
          z.11^inv(~y.3), seal(ckey.6, cnonce.7, aad.4, request.10)>
     ),
     !Ltk( $T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<
                                                          z.11^inv(~y.3), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               z.11
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       z.11^inv(~y.3), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<z.11^inv(~y.3), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               z.11
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       z.11^inv(~y.3), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( open(Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', z.11>),
                                   <'32', 'HPKE_v1', 'shared_secret', z.11^inv(~y.3), 'g'^~y.3>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'key', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', z.11>),
                                   <'32', 'HPKE_v1', 'shared_secret', z.11^inv(~y.3), 'g'^~y.3>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             <'message_bhttp_request', '0x00', ~key_id.2, kem_id.9, kdf_id.8, 
              aead_id.5>,
             seal(ckey.6, cnonce.7, aad.4, request.10)),
        request.10
    ),
    T_Done( ~ttid ),
    T_SS( z.11^inv(~y.3), 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z.11>),
                 <'32', 'HPKE_v1', 'shared_secret', z.11^inv(~y.3), 'g'^~y.3>, '32')
    ),
    T_Answer( ~ttid, $T, z.11^inv(~y.3), 'g'^~y.3, request.10, ~resp ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<z.11^inv(~y.3), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', z.11>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             z.11^inv(~y.3), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<z.11^inv(~y.3), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', z.11>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             z.11^inv(~y.3), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_4:
     [
     In( <$T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, 
          z.8^inv(~y.3), 
          seal(Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', z.8>),
                                     <'32', 'HPKE_v1', 'shared_secret', z.8^inv(~y.3), 'g'^~y.3>,
                                     '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'key', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', z.8>),
                                     <'32', 'HPKE_v1', 'shared_secret', z.8^inv(~y.3), 'g'^~y.3>,
                                     '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               <'message_bhttp_request', '0x00', ~key_id.2, kem_id.6, kdf_id.5, 
                aead_id.4>,
               request.7)
         >
     ),
     !Ltk( $T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<
                                                          z.8^inv(~y.3), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               z.8
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       z.8^inv(~y.3), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<z.8^inv(~y.3), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               z.8
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       z.8^inv(~y.3), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( request.7, request.7 ), T_Done( ~ttid ),
    T_SS( z.8^inv(~y.3), 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z.8>),
                 <'32', 'HPKE_v1', 'shared_secret', z.8^inv(~y.3), 'g'^~y.3>, '32')
    ),
    T_Answer( ~ttid, $T, z.8^inv(~y.3), 'g'^~y.3, request.7, ~resp ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<z.8^inv(~y.3), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', z.8>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             z.8^inv(~y.3), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<z.8^inv(~y.3), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', z.8>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             z.8^inv(~y.3), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_5:
     [
     In( <$T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, x.11^x.12, 
          seal(ckey.6, cnonce.7, aad.4, request.10)>
     ),
     !Ltk( $T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<x.11^x.12, 
                                                          ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.11^(
                                                                                                     ~y.3*
                                                                                                     x.12
                                                                                                    )
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.11^x.12, 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<x.11^x.12, ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.11^(
                                                                                                     ~y.3*
                                                                                                     x.12
                                                                                                    )
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.11^x.12, 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( open(Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x.11^(~y.3*x.12)>),
                                   <'32', 'HPKE_v1', 'shared_secret', x.11^x.12, 'g'^~y.3>, '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'key', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x.11^(~y.3*x.12)>),
                                   <'32', 'HPKE_v1', 'shared_secret', x.11^x.12, 'g'^~y.3>, '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             <'message_bhttp_request', '0x00', ~key_id.2, kem_id.9, kdf_id.8, 
              aead_id.5>,
             seal(ckey.6, cnonce.7, aad.4, request.10)),
        request.10
    ),
    T_Done( ~ttid ),
    T_SS( x.11^x.12, 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.11^(~y.3*x.12)>),
                 <'32', 'HPKE_v1', 'shared_secret', x.11^x.12, 'g'^~y.3>, '32')
    ),
    T_Answer( ~ttid, $T, x.11^x.12, 'g'^~y.3, request.10, ~resp ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<x.11^x.12, ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.11^(~y.3*x.12)>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.11^x.12, 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<x.11^x.12, ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.11^(~y.3*x.12)>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.11^x.12, 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_6:
     [
     In( <$T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, 
          x.11^inv((~y.3*x.12)), seal(ckey.6, cnonce.7, aad.4, request.10)>
     ),
     !Ltk( $T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<
                                                          x.11^inv((~y.3*x.12)), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.11^inv(x.12)
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.11^inv((
                                                                                                 ~y.3*
                                                                                                 x.12
                                                                                                )), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<x.11^inv((~y.3*x.12)), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.11^inv(x.12)
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.11^inv((
                                                                                                 ~y.3*
                                                                                                 x.12
                                                                                                )), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( open(Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x.11^inv(x.12)>),
                                   <'32', 'HPKE_v1', 'shared_secret', x.11^inv((~y.3*x.12)), 
                                    'g'^~y.3>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'key', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x.11^inv(x.12)>),
                                   <'32', 'HPKE_v1', 'shared_secret', x.11^inv((~y.3*x.12)), 
                                    'g'^~y.3>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             <'message_bhttp_request', '0x00', ~key_id.2, kem_id.9, kdf_id.8, 
              aead_id.5>,
             seal(ckey.6, cnonce.7, aad.4, request.10)),
        request.10
    ),
    T_Done( ~ttid ),
    T_SS( x.11^inv((~y.3*x.12)), 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.11^inv(x.12)>),
                 <'32', 'HPKE_v1', 'shared_secret', x.11^inv((~y.3*x.12)), 'g'^~y.3
                 >,
                 '32')
    ),
    T_Answer( ~ttid, $T, x.11^inv((~y.3*x.12)), 'g'^~y.3, request.10,
              ~resp
    ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<x.11^inv((~y.3*x.12)), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.11^inv(x.12)>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.11^inv((~y.3*x.12)), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<x.11^inv((~y.3*x.12)), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.11^inv(x.12)>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.11^inv((~y.3*x.12)), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_7:
     [
     In( <$T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, 
          x.11^(x.12*inv(~y.3)), seal(ckey.6, cnonce.7, aad.4, request.10)>
     ),
     !Ltk( $T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<
                                                          x.11^(x.12*inv(~y.3)), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.11^x.12
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.11^(x.12*
                                                                                             inv(~y.3)
                                                                                            ), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<x.11^(x.12*inv(~y.3)), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.11^x.12
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.11^(x.12*
                                                                                             inv(~y.3)
                                                                                            ), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( open(Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x.11^x.12>),
                                   <'32', 'HPKE_v1', 'shared_secret', x.11^(x.12*inv(~y.3)), 
                                    'g'^~y.3>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'key', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x.11^x.12>),
                                   <'32', 'HPKE_v1', 'shared_secret', x.11^(x.12*inv(~y.3)), 
                                    'g'^~y.3>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             <'message_bhttp_request', '0x00', ~key_id.2, kem_id.9, kdf_id.8, 
              aead_id.5>,
             seal(ckey.6, cnonce.7, aad.4, request.10)),
        request.10
    ),
    T_Done( ~ttid ),
    T_SS( x.11^(x.12*inv(~y.3)), 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.11^x.12>),
                 <'32', 'HPKE_v1', 'shared_secret', x.11^(x.12*inv(~y.3)), 'g'^~y.3
                 >,
                 '32')
    ),
    T_Answer( ~ttid, $T, x.11^(x.12*inv(~y.3)), 'g'^~y.3, request.10,
              ~resp
    ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<x.11^(x.12*inv(~y.3)), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', x.11^x.12
                                                                    >),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.11^(x.12*inv(~y.3)), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<x.11^(x.12*inv(~y.3)), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', x.11^x.12
                                                                    >),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.11^(x.12*inv(~y.3)), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_8:
     [
     In( <$T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, 
          x.11^(x.12*inv((~y.3*x.13))), 
          seal(ckey.6, cnonce.7, aad.4, request.10)>
     ),
     !Ltk( $T, <~key_id.2, kem_id.9, kdf_id.8, aead_id.5>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<
                                                          x.11^(x.12*inv((~y.3*x.13))), ~resp_nonce
                                                         >,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.11^(
                                                                                                     x.12*
                                                                                                     inv(x.13)
                                                                                                    )
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.11^(x.12*
                                                                                             inv((
                                                                                                  ~y.3*
                                                                                                  x.13
                                                                                                 ))
                                                                                            ), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<x.11^(x.12*inv((~y.3*x.13))), ~resp_nonce
                                                         >,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.11^(
                                                                                                     x.12*
                                                                                                     inv(x.13)
                                                                                                    )
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.11^(x.12*
                                                                                             inv((
                                                                                                  ~y.3*
                                                                                                  x.13
                                                                                                 ))
                                                                                            ), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.9, 
                                                                                 kdf_id.8, aead_id.5
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( open(Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x.11^(x.12*inv(x.13))>),
                                   <'32', 'HPKE_v1', 'shared_secret', x.11^(x.12*inv((~y.3*x.13))), 
                                    'g'^~y.3>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'key', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x.11^(x.12*inv(x.13))>),
                                   <'32', 'HPKE_v1', 'shared_secret', x.11^(x.12*inv((~y.3*x.13))), 
                                    'g'^~y.3>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                     Extract('blank',
                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                              ~key_id.2, kem_id.9, kdf_id.8, aead_id.5>)
                    >,
                    '32'),
             <'message_bhttp_request', '0x00', ~key_id.2, kem_id.9, kdf_id.8, 
              aead_id.5>,
             seal(ckey.6, cnonce.7, aad.4, request.10)),
        request.10
    ),
    T_Done( ~ttid ),
    T_SS( x.11^(x.12*inv((~y.3*x.13))), 'g'^~y.3,
          Expand(Extract('blank',
                         <'HPKE_v1', 'eae_prk', x.11^(x.12*inv(x.13))>),
                 <'32', 'HPKE_v1', 'shared_secret', x.11^(x.12*inv((~y.3*x.13))), 
                  'g'^~y.3>,
                 '32')
    ),
    T_Answer( ~ttid, $T, x.11^(x.12*inv((~y.3*x.13))), 'g'^~y.3,
              request.10, ~resp
    ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<x.11^(x.12*inv((~y.3*x.13))), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.11^(x.12*inv(x.13))>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.11^(x.12*inv((~y.3*x.13))), 'g'^~y.3
                                                            >,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<x.11^(x.12*inv((~y.3*x.13))), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.11^(x.12*inv(x.13))>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.11^(x.12*inv((~y.3*x.13))), 'g'^~y.3
                                                            >,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.9, kdf_id.8, aead_id.5>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_9:
     [
     In( <$T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, 
          x.8^(x.9*inv(~y.3)), 
          seal(Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', x.8^x.9>),
                                     <'32', 'HPKE_v1', 'shared_secret', x.8^(x.9*inv(~y.3)), 
                                      'g'^~y.3>,
                                     '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'key', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', x.8^x.9>),
                                     <'32', 'HPKE_v1', 'shared_secret', x.8^(x.9*inv(~y.3)), 
                                      'g'^~y.3>,
                                     '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               <'message_bhttp_request', '0x00', ~key_id.2, kem_id.6, kdf_id.5, 
                aead_id.4>,
               request.7)
         >
     ),
     !Ltk( $T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<
                                                          x.8^(x.9*inv(~y.3)), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.8^x.9
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.8^(x.9*
                                                                                            inv(~y.3)
                                                                                           ), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<x.8^(x.9*inv(~y.3)), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.8^x.9
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.8^(x.9*
                                                                                            inv(~y.3)
                                                                                           ), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( request.7, request.7 ), T_Done( ~ttid ),
    T_SS( x.8^(x.9*inv(~y.3)), 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.8^x.9>),
                 <'32', 'HPKE_v1', 'shared_secret', x.8^(x.9*inv(~y.3)), 'g'^~y.3>,
                 '32')
    ),
    T_Answer( ~ttid, $T, x.8^(x.9*inv(~y.3)), 'g'^~y.3, request.7,
              ~resp
    ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<x.8^(x.9*inv(~y.3)), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', x.8^x.9
                                                                    >),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.8^(x.9*inv(~y.3)), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<x.8^(x.9*inv(~y.3)), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', x.8^x.9
                                                                    >),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.8^(x.9*inv(~y.3)), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_10:
     [
     In( <$T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, 
          x.8^inv((~y.3*x.9)), 
          seal(Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', x.8^inv(x.9)>),
                                     <'32', 'HPKE_v1', 'shared_secret', x.8^inv((~y.3*x.9)), 
                                      'g'^~y.3>,
                                     '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'key', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', x.8^inv(x.9)>),
                                     <'32', 'HPKE_v1', 'shared_secret', x.8^inv((~y.3*x.9)), 
                                      'g'^~y.3>,
                                     '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               <'message_bhttp_request', '0x00', ~key_id.2, kem_id.6, kdf_id.5, 
                aead_id.4>,
               request.7)
         >
     ),
     !Ltk( $T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<
                                                          x.8^inv((~y.3*x.9)), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.8^inv(x.9)
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.8^inv((
                                                                                                ~y.3*
                                                                                                x.9
                                                                                               )), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<x.8^inv((~y.3*x.9)), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.8^inv(x.9)
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.8^inv((
                                                                                                ~y.3*
                                                                                                x.9
                                                                                               )), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( request.7, request.7 ), T_Done( ~ttid ),
    T_SS( x.8^inv((~y.3*x.9)), 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.8^inv(x.9)>),
                 <'32', 'HPKE_v1', 'shared_secret', x.8^inv((~y.3*x.9)), 'g'^~y.3>,
                 '32')
    ),
    T_Answer( ~ttid, $T, x.8^inv((~y.3*x.9)), 'g'^~y.3, request.7,
              ~resp
    ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<x.8^inv((~y.3*x.9)), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.8^inv(x.9)>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.8^inv((~y.3*x.9)), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<x.8^inv((~y.3*x.9)), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.8^inv(x.9)>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.8^inv((~y.3*x.9)), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_11:
     [
     In( <$T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, x.8^x.9, 
          seal(Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', x.8^(~y.3*x.9)>),
                                     <'32', 'HPKE_v1', 'shared_secret', x.8^x.9, 'g'^~y.3>, '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'key', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', x.8^(~y.3*x.9)>),
                                     <'32', 'HPKE_v1', 'shared_secret', x.8^x.9, 'g'^~y.3>, '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               <'message_bhttp_request', '0x00', ~key_id.2, kem_id.6, kdf_id.5, 
                aead_id.4>,
               request.7)
         >
     ),
     !Ltk( $T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<x.8^x.9, 
                                                          ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.8^(
                                                                                                    ~y.3*
                                                                                                    x.9
                                                                                                   )
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.8^x.9, 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<x.8^x.9, ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.8^(
                                                                                                    ~y.3*
                                                                                                    x.9
                                                                                                   )
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.8^x.9, 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( request.7, request.7 ), T_Done( ~ttid ),
    T_SS( x.8^x.9, 'g'^~y.3,
          Expand(Extract('blank', <'HPKE_v1', 'eae_prk', x.8^(~y.3*x.9)>),
                 <'32', 'HPKE_v1', 'shared_secret', x.8^x.9, 'g'^~y.3>, '32')
    ),
    T_Answer( ~ttid, $T, x.8^x.9, 'g'^~y.3, request.7, ~resp ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<x.8^x.9, ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.8^(~y.3*x.9)>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.8^x.9, 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<x.8^x.9, ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.8^(~y.3*x.9)>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.8^x.9, 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]
  ,
  rule (modulo AC) T_HandleQuery___VARIANT_12:
     [
     In( <$T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, 
          x.8^(x.9*inv((~y.3*x.10))), 
          seal(Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', x.8^(x.9*inv(x.10))>),
                                     <'32', 'HPKE_v1', 'shared_secret', x.8^(x.9*inv((~y.3*x.10))), 
                                      'g'^~y.3>,
                                     '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'key', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               Expand(Extract(Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', x.8^(x.9*inv(x.10))>),
                                     <'32', 'HPKE_v1', 'shared_secret', x.8^(x.9*inv((~y.3*x.10))), 
                                      'g'^~y.3>,
                                     '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                       Extract('blank',
                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                ~key_id.2, kem_id.6, kdf_id.5, aead_id.4>)
                      >,
                      '32'),
               <'message_bhttp_request', '0x00', ~key_id.2, kem_id.6, kdf_id.5, 
                aead_id.4>,
               request.7)
         >
     ),
     !Ltk( $T, <~key_id.2, kem_id.6, kdf_id.5, aead_id.4>, ~y.3 ),
     Fr( ~ttid ), Fr( ~resp ), Fr( ~resp_nonce )
     ]
    --[
    AUTO_OUT_TERM_0_0_3__NonceReuse( seal(Expand(Extract(<
                                                          x.8^(x.9*inv((~y.3*x.10))), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.8^(
                                                                                                    x.9*
                                                                                                    inv(x.10)
                                                                                                   )
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.8^(x.9*
                                                                                            inv((
                                                                                                 ~y.3*
                                                                                                 x.10
                                                                                                ))
                                                                                           ), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'key', '32'),
                                          Expand(Extract(<x.8^(x.9*inv((~y.3*x.10))), ~resp_nonce>,
                                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                                              <
                                                                                               'HPKE_v1', 
                                                                                               'eae_prk', 
                                                                                               x.8^(
                                                                                                    x.9*
                                                                                                    inv(x.10)
                                                                                                   )
                                                                                              >),
                                                                                      <'32', 
                                                                                       'HPKE_v1', 
                                                                                       'shared_secret', 
                                                                                       x.8^(x.9*
                                                                                            inv((
                                                                                                 ~y.3*
                                                                                                 x.10
                                                                                                ))
                                                                                           ), 
                                                                                       'g'^~y.3>,
                                                                                      '32'),
                                                                               <'HPKE_v1', 
                                                                                'secret', 'blank'>),
                                                                       <'32', 'HPKE_v1', 'exp', 
                                                                        '0x00', 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'psk_id_hash', 
                                                                                 'blank'>), 
                                                                        Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'info_hash', 
                                                                                 'message_bhttp_request', 
                                                                                 '0x00', ~key_id.2, 
                                                                                 kem_id.6, 
                                                                                 kdf_id.5, aead_id.4
                                                                                >)
                                                                       >,
                                                                       '32'),
                                                                <'32', 'HPKE_v1', 'sec', 
                                                                 'message_bhttp_response'>,
                                                                '32')),
                                                 'nonce', '32'),
                                          'blank', ~resp)
    ),
    Eq( request.7, request.7 ), T_Done( ~ttid ),
    T_SS( x.8^(x.9*inv((~y.3*x.10))), 'g'^~y.3,
          Expand(Extract('blank',
                         <'HPKE_v1', 'eae_prk', x.8^(x.9*inv(x.10))>),
                 <'32', 'HPKE_v1', 'shared_secret', x.8^(x.9*inv((~y.3*x.10))), 
                  'g'^~y.3>,
                 '32')
    ),
    T_Answer( ~ttid, $T, x.8^(x.9*inv((~y.3*x.10))), 'g'^~y.3,
              request.7, ~resp
    ),
    VerifyPSKInputs( '0x00', 'blank', 'blank' )
    ]->
     [
     Out( <~resp_nonce, 
           seal(Expand(Extract(<x.8^(x.9*inv((~y.3*x.10))), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.8^(x.9*inv(x.10))>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.8^(x.9*inv((~y.3*x.10))), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'key', '32'),
                Expand(Extract(<x.8^(x.9*inv((~y.3*x.10))), ~resp_nonce>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', 
                                                                     x.8^(x.9*inv(x.10))>),
                                                            <'32', 'HPKE_v1', 'shared_secret', 
                                                             x.8^(x.9*inv((~y.3*x.10))), 'g'^~y.3>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x00', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 
                                                       'message_bhttp_request', '0x00', ~key_id.2, 
                                                       kem_id.6, kdf_id.5, aead_id.4>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                       'nonce', '32'),
                'blank', ~resp)
          >
     )
     ]

rule (modulo E) P_HandleResponse:
   [ P_ResponseHandler( ~ptid, $C, $P, ~k ), In( <nonce, opaque> ) ]
  --[
  AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<nonce, opaque>, ~k)
  ),
  AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<nonce, opaque>, ~k)
  ),
  P_Done( ~ptid )
  ]->
   [ Out( senc(<nonce, opaque>, ~k) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) C_HandleResponse:
   [
   C_ResponseHandler( ~request, $C, gx, $P, ~k, $T, gy, shared_secret,
                      <'message_bhttp_request', '0x00', key_id, kem_id, kdf_id, aead_id>
   ),
   In( senc(<response_nonce, 
             seal(aead_key, aead_nonce, 'blank', response)>,
            ~k)
   )
   ]
  --[
  C_Done( ~request, response, $C, gx, $T, gy ),
  Eq( open(Expand(Extract(<gx, response_nonce>,
                          Expand(Expand(Extract(shared_secret,
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                         Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                         Extract('blank',
                                                 <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                  '0x00', key_id, kem_id, kdf_id, aead_id>)
                                        >,
                                        '32'),
                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                  'key', '32'),
           Expand(Extract(<gx, response_nonce>,
                          Expand(Expand(Extract(shared_secret,
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                         Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                         Extract('blank',
                                                 <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                  '0x00', key_id, kem_id, kdf_id, aead_id>)
                                        >,
                                        '32'),
                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                  'nonce', '32'),
           'blank', seal(aead_key, aead_nonce, 'blank', response)),
      response
  )
  ]->
   [ ]
 variants
  rule (modulo AC) C_HandleResponse___VARIANT_1:
     [
     C_ResponseHandler( ~request, $C, gx.4, $P, ~k, $T, gy,
                        shared_secret.10,
                        <'message_bhttp_request', '0x00', key_id.7, kem_id.6, kdf_id.5, 
                         aead_id.1>
     ),
     In( senc(<response_nonce.9, 
               seal(aead_key.2, aead_nonce.3, 'blank', response.8)>,
              ~k)
     )
     ]
    --[
    C_Done( ~request, response.8, $C, gx.4, $T, gy ),
    Eq( open(Expand(Extract(<gx.4, response_nonce.9>,
                            Expand(Expand(Extract(shared_secret.10,
                                                  <'HPKE_v1', 'secret', 'blank'>),
                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                           Extract('blank',
                                                   <'HPKE_v1', 'info_hash', 
                                                    'message_bhttp_request', '0x00', key_id.7, 
                                                    kem_id.6, kdf_id.5, aead_id.1>)
                                          >,
                                          '32'),
                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                    'key', '32'),
             Expand(Extract(<gx.4, response_nonce.9>,
                            Expand(Expand(Extract(shared_secret.10,
                                                  <'HPKE_v1', 'secret', 'blank'>),
                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                           Extract('blank',
                                                   <'HPKE_v1', 'info_hash', 
                                                    'message_bhttp_request', '0x00', key_id.7, 
                                                    kem_id.6, kdf_id.5, aead_id.1>)
                                          >,
                                          '32'),
                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')),
                    'nonce', '32'),
             'blank', seal(aead_key.2, aead_nonce.3, 'blank', response.8)),
        response.8
    )
    ]->
     [ ]
  ,
  rule (modulo AC) C_HandleResponse___VARIANT_2:
     [
     C_ResponseHandler( ~request, $C, gx.2, $P, ~k, $T, gy,
                        shared_secret.8,
                        <'message_bhttp_request', '0x00', key_id.5, kem_id.4, kdf_id.3, 
                         aead_id.1>
     ),
     In( senc(<response_nonce.7, 
               seal(Expand(Extract(<gx.2, response_nonce.7>,
                                   Expand(Expand(Extract(shared_secret.8,
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           key_id.5, kem_id.4, kdf_id.3, aead_id.1>)
                                                 >,
                                                 '32'),
                                          <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                          '32')),
                           'key', '32'),
                    Expand(Extract(<gx.2, response_nonce.7>,
                                   Expand(Expand(Extract(shared_secret.8,
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           key_id.5, kem_id.4, kdf_id.3, aead_id.1>)
                                                 >,
                                                 '32'),
                                          <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                          '32')),
                           'nonce', '32'),
                    'blank', response.6)
              >,
              ~k)
     )
     ]
    --[
    C_Done( ~request, response.6, $C, gx.2, $T, gy ),
    Eq( response.6, response.6 )
    ]->
     [ ]

rule (modulo E) RevSK:
   [ KeyExI( $X, $Y, ~kxy ) ] --[ RevSk( ~kxy ) ]-> [ Out( ~kxy ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) RevDH:
   [ !Ltk( $A, ~key_id, ~x ) ]
  --[ RevDH( $A, ~key_id, 'g'^~x ) ]->
   [ Out( ~x ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) NonceReuse:
   [ In( seal(k, n, a1, p1) ), In( seal(k, n, a2, p2) ) ]
  --[
  AUTO_IN_TERM_0_0_3__NonceReuse( seal(k, n, a1, p1), p1 ),
  Neq( p1, p2 ), ReuseNonce( k, n, p1, p2 )
  ]->
   [ Out( p1 ) ]

  /* has exactly the trivial AC variant */

lemma CQG_sources:
  all-traces
  "∀ gx op #j.
    (PHQ( gx, op ) @ #j) ⇒
    ((∃ #i. (CQG_sources( gx, op ) @ #i) ∧ (#i < #j)) ∨
     ((∃ #i. (!KU( gx ) @ #i) ∧ (#i < #j)) ∧
      (∃ #i. (!KU( op ) @ #i) ∧ (#i < #j))))"
/*
guarded formula characterizing all counter-examples:
"∃ gx op #j.
  (PHQ( gx, op ) @ #j)
 ∧
  (∀ #i. (CQG_sources( gx, op ) @ #i) ⇒ ¬(#i < #j)) ∧
  (((∀ #i. (!KU( gx ) @ #i) ⇒ ¬(#i < #j)) ∨
    (∀ #i. (!KU( op ) @ #i) ⇒ ¬(#i < #j))))"
*/
by sorry

lemma dual:
  all-traces
  "∀ gx op #j.
    (PHQ( gx, op ) @ #j) ⇒
    (((∃ #i. (CQG_sources( gx, op ) @ #i) ∧ (#i < #j)) ∨
      ((∃ #i. (!KU( gx ) @ #i) ∧ (#i < #j)) ∧
       (∃ #i. (!KU( op ) @ #i) ∧ (#i < #j)))) ∨
     (∃ k n p2 #i. (ReuseNonce( k, n, op, p2 ) @ #i) ∧ (#i < #j)))"
/*
guarded formula characterizing all counter-examples:
"∃ gx op #j.
  (PHQ( gx, op ) @ #j)
 ∧
  (∀ #i. (CQG_sources( gx, op ) @ #i) ⇒ ¬(#i < #j)) ∧
  (((∀ #i. (!KU( gx ) @ #i) ⇒ ¬(#i < #j)) ∨
    (∀ #i. (!KU( op ) @ #i) ⇒ ¬(#i < #j)))) ∧
  (∀ k n p2 #i. (ReuseNonce( k, n, op, p2 ) @ #i) ⇒ ¬(#i < #j))"
*/
by sorry

lemma aead_sources:
  all-traces
  "∀ k n a p #j.
    (!KU( seal(k, n, a, p) ) @ #j) ⇒
    (((∃ #i. (!KU( p ) @ #i) ∧ (#i < #j)) ∨
      (∃ tid T gx gy req #i.
        (T_Answer( tid, T, gx, gy, req, p ) @ #i) ∧ (#i < #j))) ∨
     (∃ C gx P k.1 T gy cid #i.
       (C_QG( C, gx, P, k.1, T, gy, cid, p ) @ #i) ∧ (#i < #j)))"
/*
guarded formula characterizing all counter-examples:
"∃ k n a p #j.
  (!KU( seal(k, n, a, p) ) @ #j)
 ∧
  (∀ #i. (!KU( p ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ tid T gx gy req #i.
    (T_Answer( tid, T, gx, gy, req, p ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ C gx P k.1 T gy cid #i.
    (C_QG( C, gx, P, k.1, T, gy, cid, p ) @ #i) ⇒ ¬(#i < #j))"
*/
by sorry

lemma end_to_end:
  exists-trace
  "∃ req resp C gx T gy #i. C_Done( req, resp, C, gx, T, gy ) @ #i"
/*
guarded formula characterizing all satisfying traces:
"∃ req resp C gx T gy #i. (C_Done( req, resp, C, gx, T, gy ) @ #i)"
*/
simplify
solve( C_Done( req, resp, C, gx, T, gy ) @ #i )
  case C_HandleResponse___VARIANT_2
  solve( C_ResponseHandler( ~request, $C, gx, $P, ~k, $T, gy,
                            shared_secret,
                            <'message_bhttp_request', '0x00', key_id, kem_id, kdf_id, aead_id>
         ) ▶₀ #i )
    case C_QueryGeneration___VARIANT_3
    solve( !KU( senc(<response_nonce, 
                      seal(Expand(Extract(<'g'^~x, response_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~x.1)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~x.1>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'key', '32'),
                           Expand(Extract(<'g'^~x, response_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~x.1)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~x.1>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'nonce', '32'),
                           'blank', resp)
                     >,
                     ~k)
           ) @ #vk )
      case P_HandleResponse
      solve( !KU( seal(Expand(Extract(<'g'^~x, response_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~x.1)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 
                                                                    'g'^~x.1>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'key', '32'),
                       Expand(Extract(<'g'^~x, response_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~x.1)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 
                                                                    'g'^~x.1>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'nonce', '32'),
                       'blank', resp)
             ) @ #vk.3 )
        case T_HandleQuery___VARIANT_11
        solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'key', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                          $aead_id>,
                         request.1)
               ) @ #vk.17 )
          case C_QueryGeneration___VARIANT_3
          by sorry
        next
          case P_HandleQuery_case_1
          by sorry
        next
          case P_HandleQuery_case_2
          solve( !KU( senc(<~cid, <~key_id, $kem_id, $kdf_id, $aead_id>, 
                            'g'^~x, 
                            seal(Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                               >),
                                                       <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                        'g'^~x.1>,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'key', '0x00', 
                                         Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                         Extract('blank',
                                                 <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                  '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                        >,
                                        '32'),
                                 Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                               >),
                                                       <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                        'g'^~x.1>,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                         Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                         Extract('blank',
                                                 <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                  '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                        >,
                                        '32'),
                                 <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                                  $aead_id>,
                                 ~request)
                           >,
                           ~k)
                 ) @ #vk.5 )
            case C_QueryGeneration___VARIANT_3
            solve( !KU( ~key_id ) @ #vk.11 )
              case C_QueryGeneration___VARIANT_3
              by sorry
            next
              case Generate_DH_key_pair
              solve( !KU( ~resp_nonce ) @ #vk.9 )
                case T_HandleQuery___VARIANT_11
                solve( !KU( 'g'^~x ) @ #vk.17 )
                  case P_HandleQuery
                  SOLVED // trace found
                qed
              qed
            next
              case P_HandleQuery
              by sorry
            qed
          next
            case c_senc
            by contradiction /* cyclic */
          qed
        next
          case c_seal
          by sorry
        qed
      next
        case c_seal
        by sorry
      qed
    next
      case c_senc
      by sorry
    qed
  qed
qed

lemma tdone:
  exists-trace "∃ tid #i. T_Done( tid ) @ #i"
/*
guarded formula characterizing all satisfying traces:
"∃ tid #i. (T_Done( tid ) @ #i)"
*/
by sorry

lemma phq:
  exists-trace "∃ gx opaque #i. PHQ( gx, opaque ) @ #i"
/*
guarded formula characterizing all satisfying traces:
"∃ gx opaque #i. (PHQ( gx, opaque ) @ #i)"
*/
by sorry

lemma ss_match:
  all-traces
  "∀ gx gy ss #j.
    (T_SS( gx, gy, ss ) @ #j) ⇒
    ((∃ #i. (C_SS( gx, gy, ss ) @ #i) ∧ (#i < #j)) ∨
     (∃ #i. (!KU( ss ) @ #i) ∧ (#i < #j)))"
/*
guarded formula characterizing all counter-examples:
"∃ gx gy ss #j.
  (T_SS( gx, gy, ss ) @ #j)
 ∧
  (∀ #i. (C_SS( gx, gy, ss ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ #i. (!KU( ss ) @ #i) ⇒ ¬(#i < #j))"
*/
simplify
solve( T_SS( gx, gy, ss ) @ #j )
  case T_HandleQuery___VARIANT_10
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^inv(x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', x^inv((~y*x.1)), 
                                            'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^inv(x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', x^inv((~y*x.1)), 
                                            'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                      $aead_id>,
                     request)
           ) @ #vk.12 )
      case c_seal
      solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                <'HPKE_v1', 'eae_prk', x^inv(x.1)>),
                                        <'32', 'HPKE_v1', 'shared_secret', x^inv((~y*x.1)), 'g'^~y>,
                                        '32'),
                                 <'HPKE_v1', 'secret', 'blank'>),
                         <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                          Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                          Extract('blank',
                                  <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                   ~key_id, $kem_id, $kdf_id, $aead_id>)
                         >,
                         '32')
             ) @ #vk.15 )
        case c_Expand
        solve( !KU( Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x^inv(x.1)>),
                                   <'32', 'HPKE_v1', 'shared_secret', x^inv((~y*x.1)), 'g'^~y>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>)
               ) @ #vk.21 )
          case c_Extract
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_11
  solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                         <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32'),
                                  <'HPKE_v1', 'secret', 'blank'>),
                          <'32', 'HPKE_v1', 'key', '0x00', 
                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                           Extract('blank',
                                   <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                    ~key_id, kem_id, kdf_id, aead_id>)
                          >,
                          '32'),
                   Expand(Extract(Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                         <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32'),
                                  <'HPKE_v1', 'secret', 'blank'>),
                          <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                           Extract('blank',
                                   <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                    ~key_id, kem_id, kdf_id, aead_id>)
                          >,
                          '32'),
                   <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                   >,
                   request)
         ) @ #vk.12 )
    case C_QueryGeneration___VARIANT_3
    by contradiction /* from formulas */
  next
    case P_HandleQuery_case_1
    by contradiction /* from formulas */
  next
    case P_HandleQuery_case_2
    by contradiction /* from formulas */
  next
    case c_seal
    solve( !KU( Expand(Extract(Expand(Extract('blank',
                                              <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                      <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32'),
                               <'HPKE_v1', 'secret', 'blank'>),
                       <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                        Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                        Extract('blank',
                                <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', ~key_id, 
                                 kem_id, kdf_id, aead_id>)
                       >,
                       '32')
           ) @ #vk.15 )
      case c_Expand
      solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
        case Generate_DH_key_pair
        solve( !KU( Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                   <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32'),
                            <'HPKE_v1', 'secret', 'blank'>)
               ) @ #vk.22 )
          case c_Extract
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_12
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                           <'32', 'HPKE_v1', 'shared_secret', 
                                            x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                           <'32', 'HPKE_v1', 'shared_secret', 
                                            x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                      $aead_id>,
                     request)
           ) @ #vk.12 )
      case c_seal
      solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                        <'32', 'HPKE_v1', 'shared_secret', x^(x.1*inv((~y*x.2))), 
                                         'g'^~y>,
                                        '32'),
                                 <'HPKE_v1', 'secret', 'blank'>),
                         <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                          Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                          Extract('blank',
                                  <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                   ~key_id, $kem_id, $kdf_id, $aead_id>)
                         >,
                         '32')
             ) @ #vk.15 )
        case c_Expand
        solve( !KU( Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                   <'32', 'HPKE_v1', 'shared_secret', x^(x.1*inv((~y*x.2))), 'g'^~y
                                   >,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>)
               ) @ #vk.21 )
          case c_Extract
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_2
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', gx^~y>),
                                           <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', gx^~y>),
                                           <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                      $aead_id>,
                     request)
           ) @ #vk.12 )
      case c_seal
      solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                <'HPKE_v1', 'eae_prk', gx^~y>),
                                        <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                 <'HPKE_v1', 'secret', 'blank'>),
                         <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                          Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                          Extract('blank',
                                  <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                   ~key_id, $kem_id, $kdf_id, $aead_id>)
                         >,
                         '32')
             ) @ #vk.15 )
        case c_Expand
        solve( !KU( Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', gx^~y>),
                                   <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                            <'HPKE_v1', 'secret', 'blank'>)
               ) @ #vk.21 )
          case c_Extract
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_4
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', z>),
                                           <'32', 'HPKE_v1', 'shared_secret', z^inv(~y), 'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                           <'32', 'HPKE_v1', 'shared_secret', z^inv(~y), 'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                      $aead_id>,
                     request)
           ) @ #vk.12 )
      case c_seal
      solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                <'HPKE_v1', 'eae_prk', z>),
                                        <'32', 'HPKE_v1', 'shared_secret', z^inv(~y), 'g'^~y>,
                                        '32'),
                                 <'HPKE_v1', 'secret', 'blank'>),
                         <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                          Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                          Extract('blank',
                                  <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                   ~key_id, $kem_id, $kdf_id, $aead_id>)
                         >,
                         '32')
             ) @ #vk.15 )
        case c_Expand
        solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                  <'HPKE_v1', 'eae_prk', z>),
                                          <'32', 'HPKE_v1', 'shared_secret', z^inv(~y), 'g'^~y>,
                                          '32'),
                                   <'HPKE_v1', 'secret', 'blank'>),
                           <'32', 'HPKE_v1', 'key', '0x00', 
                            Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                            Extract('blank',
                                    <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                     ~key_id, $kem_id, $kdf_id, $aead_id>)
                           >,
                           '32')
               ) @ #vk.16 )
          case c_Expand
          solve( !KU( z^inv(~y) ) @ #vk.16 )
            case c_exp
            by solve( !KU( ~y ) @ #vk.37 )
          qed
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_9
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^x.1>),
                                           <'32', 'HPKE_v1', 'shared_secret', x^(x.1*inv(~y)), 
                                            'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^x.1>),
                                           <'32', 'HPKE_v1', 'shared_secret', x^(x.1*inv(~y)), 
                                            'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                      $aead_id>,
                     request)
           ) @ #vk.12 )
      case c_seal
      solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                <'HPKE_v1', 'eae_prk', x^x.1>),
                                        <'32', 'HPKE_v1', 'shared_secret', x^(x.1*inv(~y)), 'g'^~y>,
                                        '32'),
                                 <'HPKE_v1', 'secret', 'blank'>),
                         <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                          Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                          Extract('blank',
                                  <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                   ~key_id, $kem_id, $kdf_id, $aead_id>)
                         >,
                         '32')
             ) @ #vk.15 )
        case c_Expand
        solve( !KU( Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x^x.1>),
                                   <'32', 'HPKE_v1', 'shared_secret', x^(x.1*inv(~y)), 'g'^~y>,
                                   '32'),
                            <'HPKE_v1', 'secret', 'blank'>)
               ) @ #vk.21 )
          case c_Extract
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
qed

lemma secret_request [reuse]:
  all-traces
  "∀ C gx P key T gy cid req #j #k.
    ((C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧
     (!KU( req ) @ #k)) ⇒
    (∃ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ∧ (#i < #k))"
/*
guarded formula characterizing all counter-examples:
"∃ C gx P key T gy cid req #j #k.
  (C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧ (!KU( req ) @ #k)
 ∧
  ∀ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ⇒ ¬(#i < #k)"
*/
simplify
solve( C_QG( C, gx, P, key, T, gy, cid, req ) @ #j )
  case C_QueryGeneration___VARIANT_1
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, gy ) ▶₁ #j )
      case Generate_DH_key_pair
      by contradiction /* non-normal terms */
    qed
  qed
next
  case C_QueryGeneration___VARIANT_2
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    by solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, z^inv(~x)
              ) ▶₁ #j )
  qed
next
  case C_QueryGeneration___VARIANT_3
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, x^x.1 ) ▶₁ #j )
      case Generate_DH_key_pair
      solve( !KU( ~req ) @ #k.1 )
        case C_QueryGeneration___VARIANT_3
        solve( !KU( 'g'^(~x*~x.1) ) @ #vk.51 )
          case C_QueryGeneration___VARIANT_3
          by solve( !KU( ~x ) @ #vk.52 )
        next
          case Generate_DH_key_pair
          by solve( !KU( ~x.1 ) @ #vk.52 )
        next
          case c_exp
          by solve( !KU( ~x ) @ #vk.54 )
        qed
      next
        case NonceReuse
        solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'key', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                          $aead_id>,
                         ~req)
               ) @ #vk )
          case C_QueryGeneration___VARIANT_3
          solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'key', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           a2, p2)
                 ) @ #vk.1 )
            case C_QueryGeneration___VARIANT_3
            by contradiction /* from formulas */
          next
            case c_seal
            solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                      <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                              <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                              '32'),
                                       <'HPKE_v1', 'secret', 'blank'>),
                               <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                Extract('blank',
                                        <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                         ~key_id, $kem_id, $kdf_id, $aead_id>)
                               >,
                               '32')
                   ) @ #vk.4 )
              case c_Expand
              solve( !KU( Extract(Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                         '32'),
                                  <'HPKE_v1', 'secret', 'blank'>)
                     ) @ #vk.7 )
                case c_Extract
                solve( !KU( Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32')
                       ) @ #vk.20 )
                  case c_Expand
                  solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                         ) @ #vk.26 )
                    case c_Extract
                    solve( !KU( 'g'^(~x*~x.1) ) @ #vk.35 )
                      case C_QueryGeneration___VARIANT_3
                      by solve( !KU( ~x ) @ #vk.36 )
                    next
                      case Generate_DH_key_pair
                      by solve( !KU( ~x.1 ) @ #vk.36 )
                    next
                      case c_exp
                      by solve( !KU( ~x ) @ #vk.38 )
                    qed
                  qed
                qed
              qed
            qed
          qed
        next
          case P_HandleQuery_case_1
          solve( !KU( senc(<~cid, <~key_id, $kem_id, $kdf_id, $aead_id>, 
                            'g'^~x.1, 
                            seal(Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                               >),
                                                       <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                                        'g'^~x>,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'key', '0x00', 
                                         Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                         Extract('blank',
                                                 <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                  '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                        >,
                                        '32'),
                                 Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                               >),
                                                       <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                                        'g'^~x>,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                         Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                         Extract('blank',
                                                 <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                  '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                        >,
                                        '32'),
                                 <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                                  $aead_id>,
                                 ~req)
                           >,
                           ~k)
                 ) @ #vk.2 )
            case C_QueryGeneration___VARIANT_3
            solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                                    'g'^~x>,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'key', '0x00', 
                                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                     Extract('blank',
                                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                              '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                    >,
                                    '32'),
                             Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                                    'g'^~x>,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                     Extract('blank',
                                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                              '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                    >,
                                    '32'),
                             a2, p2)
                   ) @ #vk.2 )
              case P_HandleQuery_case_1
              by contradiction /* from formulas */
            next
              case P_HandleQuery_case_2
              by contradiction /* from formulas */
            next
              case c_seal
              solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                >,
                                                '32'),
                                         <'HPKE_v1', 'secret', 'blank'>),
                                 <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                  Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                  Extract('blank',
                                          <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                           ~key_id, $kem_id, $kdf_id, $aead_id>)
                                 >,
                                 '32')
                     ) @ #vk.4 )
                case c_Expand
                solve( !KU( Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>)
                       ) @ #vk.7 )
                  case c_Extract
                  solve( !KU( Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32')
                         ) @ #vk.20 )
                    case c_Expand
                    solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                           ) @ #vk.27 )
                      case c_Extract
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.34 )
                        case Generate_DH_key_pair
                        by solve( !KU( ~x.1 ) @ #vk.35 )
                      next
                        case P_HandleQuery
                        by contradiction /* cyclic */
                      next
                        case c_exp
                        by solve( !KU( ~x ) @ #vk.37 )
                      qed
                    qed
                  qed
                qed
              qed
            qed
          next
            case P_HandleResponse
            by contradiction /* cyclic */
          next
            case c_senc
            by contradiction /* cyclic */
          qed
        next
          case P_HandleQuery_case_2
          solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'key', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           a2, p2)
                 ) @ #vk.1 )
            case P_HandleQuery_case_1
            by contradiction /* from formulas */
          next
            case P_HandleQuery_case_2
            by contradiction /* from formulas */
          next
            case c_seal
            solve( !KU( senc(<~cid, <~key_id, $kem_id, $kdf_id, $aead_id>, 
                              'g'^~x.1, 
                              seal(Expand(Extract(Expand(Extract('blank',
                                                                 <'HPKE_v1', 'eae_prk', 
                                                                  'g'^(~x*~x.1)>),
                                                         <'32', 'HPKE_v1', 'shared_secret', 
                                                          'g'^~x.1, 'g'^~x>,
                                                         '32'),
                                                  <'HPKE_v1', 'secret', 'blank'>),
                                          <'32', 'HPKE_v1', 'key', '0x00', 
                                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                           Extract('blank',
                                                   <'HPKE_v1', 'info_hash', 
                                                    'message_bhttp_request', '0x00', ~key_id, 
                                                    $kem_id, $kdf_id, $aead_id>)
                                          >,
                                          '32'),
                                   Expand(Extract(Expand(Extract('blank',
                                                                 <'HPKE_v1', 'eae_prk', 
                                                                  'g'^(~x*~x.1)>),
                                                         <'32', 'HPKE_v1', 'shared_secret', 
                                                          'g'^~x.1, 'g'^~x>,
                                                         '32'),
                                                  <'HPKE_v1', 'secret', 'blank'>),
                                          <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                           Extract('blank',
                                                   <'HPKE_v1', 'info_hash', 
                                                    'message_bhttp_request', '0x00', ~key_id, 
                                                    $kem_id, $kdf_id, $aead_id>)
                                          >,
                                          '32'),
                                   <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                                    $aead_id>,
                                   ~req)
                             >,
                             ~k)
                   ) @ #vk.2 )
              case C_QueryGeneration___VARIANT_3
              solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                >,
                                                '32'),
                                         <'HPKE_v1', 'secret', 'blank'>),
                                 <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                  Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                  Extract('blank',
                                          <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                           ~key_id, $kem_id, $kdf_id, $aead_id>)
                                 >,
                                 '32')
                     ) @ #vk.4 )
                case c_Expand
                solve( !KU( Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>)
                       ) @ #vk.7 )
                  case c_Extract
                  solve( !KU( Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32')
                         ) @ #vk.20 )
                    case c_Expand
                    solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                           ) @ #vk.26 )
                      case c_Extract
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.35 )
                        case Generate_DH_key_pair
                        by solve( !KU( ~x.1 ) @ #vk.36 )
                      next
                        case P_HandleQuery
                        by solve( !KU( ~x ) @ #vk.36 )
                      next
                        case c_exp
                        by solve( !KU( ~x ) @ #vk.38 )
                      qed
                    qed
                  qed
                qed
              qed
            next
              case P_HandleResponse
              by contradiction /* cyclic */
            next
              case c_senc
              by contradiction /* cyclic */
            qed
          qed
        next
          case c_seal
          by contradiction /* cyclic */
        qed
      next
        case P_HandleQuery_case_1
        solve( !KU( 'g'^(~x*~x.1) ) @ #vk.50 )
          case Generate_DH_key_pair
          by solve( !KU( ~x.1 ) @ #vk.51 )
        next
          case P_HandleQuery
          by contradiction /* cyclic */
        next
          case c_exp
          by solve( !KU( ~x ) @ #vk.53 )
        qed
      next
        case P_HandleQuery_case_2
        solve( !KU( 'g'^(~x*~x.1) ) @ #vk.51 )
          case Generate_DH_key_pair
          by solve( !KU( ~x.1 ) @ #vk.52 )
        next
          case P_HandleQuery
          by solve( !KU( ~x ) @ #vk.52 )
        next
          case c_exp
          by solve( !KU( ~x ) @ #vk.54 )
        qed
      qed
    qed
  qed
next
  case C_QueryGeneration___VARIANT_4
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    by solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>,
                   x^inv((~x.1*x.2))
              ) ▶₁ #j )
  qed
next
  case C_QueryGeneration___VARIANT_5
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    by solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>,
                   x^(x.1*inv(~x.2))
              ) ▶₁ #j )
  qed
next
  case C_QueryGeneration___VARIANT_6
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    by solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>,
                   x^(x.1*inv((~x.2*x.3)))
              ) ▶₁ #j )
  qed
qed

lemma secret_response:
  all-traces
  "∀ tid T gx gy req resp #j #k.
    ((T_Answer( tid, T, gx, gy, req, resp ) @ #j) ∧
     (!KU( resp ) @ #k)) ⇒
    ((∃ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ∧ (#i < #k)) ∨
     (∃ #i. (!KU( req ) @ #i) ∧ (#i < #k)))"
/*
guarded formula characterizing all counter-examples:
"∃ tid T gx gy req resp #j #k.
  (T_Answer( tid, T, gx, gy, req, resp ) @ #j) ∧ (!KU( resp ) @ #k)
 ∧
  (∀ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ⇒ ¬(#i < #k)) ∧
  (∀ #i. (!KU( req ) @ #i) ⇒ ¬(#i < #k))"
*/
simplify
solve( T_Answer( tid, T, gx, gy, req, resp ) @ #j )
  case T_HandleQuery___VARIANT_10
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~resp ) @ #k )
      case NonceReuse
      solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', x^inv(x.1)>),
                                             <'32', 'HPKE_v1', 'shared_secret', x^inv((~y*x.1)), 
                                              'g'^~y>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'key', '0x00', 
                               Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                               Extract('blank',
                                       <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                        ~key_id, $kem_id, $kdf_id, $aead_id>)
                              >,
                              '32'),
                       Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', x^inv(x.1)>),
                                             <'32', 'HPKE_v1', 'shared_secret', x^inv((~y*x.1)), 
                                              'g'^~y>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                               Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                               Extract('blank',
                                       <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                        ~key_id, $kem_id, $kdf_id, $aead_id>)
                              >,
                              '32'),
                       <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                        $aead_id>,
                       req)
             ) @ #vk.12 )
        case c_seal
        by contradiction /* from formulas */
      qed
    next
      case T_HandleQuery___VARIANT_10
      solve( !KU( ~resp_nonce ) @ #vk.35 )
        case T_HandleQuery___VARIANT_10
        solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', x^inv(x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', x^inv((~y*x.1)), 
                                                'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'key', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', x^inv(x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', x^inv((~y*x.1)), 
                                                'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                          $aead_id>,
                         req)
               ) @ #vk.25 )
          case c_seal
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_11
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~resp ) @ #k )
      case NonceReuse
      solve( !KU( seal(Expand(Extract(<x^x.1, ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            x^(~y*x.1)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', x^x.1, 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'key', '32'),
                       Expand(Extract(<x^x.1, ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            x^(~y*x.1)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', x^x.1, 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'nonce', '32'),
                       'blank', ~resp)
             ) @ #vk.13 )
        case T_HandleQuery___VARIANT_11
        solve( !KU( seal(Expand(Extract(<x^x.1, ~resp_nonce>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              x^(~y*x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', x^x.1, 'g'^~y
                                                                     >,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                               '32')),
                                'key', '32'),
                         Expand(Extract(<x^x.1, ~resp_nonce>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              x^(~y*x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', x^x.1, 'g'^~y
                                                                     >,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                               '32')),
                                'nonce', '32'),
                         a2, p2)
               ) @ #vk.14 )
          case T_HandleQuery___VARIANT_11
          by contradiction /* from formulas */
        next
          case c_seal
          solve( !KU( Expand(Extract(<x^x.1, ~resp_nonce>,
                                     Expand(Expand(Extract(Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', 
                                                                           x^(~y*x.1)>),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', x^x.1, 'g'^~y>,
                                                                  '32'),
                                                           <'HPKE_v1', 'secret', 'blank'>),
                                                   <'32', 'HPKE_v1', 'exp', '0x00', 
                                                    Extract('blank',
                                                            <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                    Extract('blank',
                                                            <'HPKE_v1', 'info_hash', 
                                                             'message_bhttp_request', '0x00', 
                                                             ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                   >,
                                                   '32'),
                                            <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                            '32')),
                             'nonce', '32')
                 ) @ #vk.16 )
            case c_Expand
            solve( !KU( Extract(<x^x.1, ~resp_nonce>,
                                Expand(Expand(Extract(Expand(Extract('blank',
                                                                     <'HPKE_v1', 'eae_prk', 
                                                                      x^(~y*x.1)>),
                                                             <'32', 'HPKE_v1', 'shared_secret', 
                                                              x^x.1, 'g'^~y>,
                                                             '32'),
                                                      <'HPKE_v1', 'secret', 'blank'>),
                                              <'32', 'HPKE_v1', 'exp', '0x00', 
                                               Extract('blank',
                                                       <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                               Extract('blank',
                                                       <'HPKE_v1', 'info_hash', 
                                                        'message_bhttp_request', '0x00', ~key_id, 
                                                        $kem_id, $kdf_id, $aead_id>)
                                              >,
                                              '32'),
                                       <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32'))
                   ) @ #vk.19 )
              case c_Extract
              solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                                       <'32', 'HPKE_v1', 'shared_secret', x^x.1, 
                                                        'g'^~y>,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                         Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                         Extract('blank',
                                                 <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                  '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                        >,
                                        '32'),
                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                     ) @ #vk.23 )
                case c_Expand
                solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                          <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                                  <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>,
                                                  '32'),
                                           <'HPKE_v1', 'secret', 'blank'>),
                                   <'32', 'HPKE_v1', 'exp', '0x00', 
                                    Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                    Extract('blank',
                                            <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                             '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                   >,
                                   '32')
                       ) @ #vk.26 )
                  case c_Expand
                  solve( !KU( Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                             <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>)
                         ) @ #vk.34 )
                    case c_Extract
                    solve( !KU( Expand(Extract('blank',
                                               <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                       <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32')
                           ) @ #vk.43 )
                      case c_Expand
                      solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', x^(~y*x.1)>)
                             ) @ #vk.50 )
                        case c_Extract
                        solve( !KU( x^(~y*x.1) ) @ #vk.57 )
                          case C_QueryGeneration___VARIANT_3_case_1
                          by solve( !KU( ~y ) @ #vk.59 )
                        next
                          case C_QueryGeneration___VARIANT_3_case_2
                          by solve( !KU( ~y ) @ #vk.60 )
                        next
                          case Generate_DH_key_pair_case_1
                          by solve( !KU( ~y ) @ #vk.58 )
                        next
                          case Generate_DH_key_pair_case_2
                          by solve( !KU( ~y ) @ #vk.59 )
                        next
                          case Generate_DH_key_pair_case_3
                          solve( !KU( ~resp_nonce ) @ #vk.35 )
                            case T_HandleQuery___VARIANT_11
                            solve( !KU( Expand(Extract(<'g'^x, ~resp_nonce>,
                                                       Expand(Expand(Extract(Expand(Extract('blank',
                                                                                            <
                                                                                             'HPKE_v1', 
                                                                                             'eae_prk', 
                                                                                             'g'^(
                                                                                                  ~y*
                                                                                                  x)
                                                                                            >),
                                                                                    <'32', 
                                                                                     'HPKE_v1', 
                                                                                     'shared_secret', 
                                                                                     'g'^x, 'g'^~y>,
                                                                                    '32'),
                                                                             <'HPKE_v1', 'secret', 
                                                                              'blank'>),
                                                                     <'32', 'HPKE_v1', 'exp', 
                                                                      '0x00', 
                                                                      Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'psk_id_hash', 
                                                                               'blank'>), 
                                                                      Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'info_hash', 
                                                                               'message_bhttp_request', 
                                                                               '0x00', ~key_id, 
                                                                               $kem_id, $kdf_id, 
                                                                               $aead_id>)
                                                                     >,
                                                                     '32'),
                                                              <'32', 'HPKE_v1', 'sec', 
                                                               'message_bhttp_response'>,
                                                              '32')),
                                               'key', '32')
                                   ) @ #vk.31 )
                              case c_Expand
                              solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~y*x)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^x, 'g'^~y
                                                                     >,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'key', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~y*x)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^x, 'g'^~y
                                                                     >,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'message_bhttp_request', '0x00', ~key_id, $kem_id, 
                                                $kdf_id, $aead_id>,
                                               req)
                                     ) @ #vk.32 )
                                case C_QueryGeneration___VARIANT_3
                                by solve( !KU( ~x ) @ #vk.58 )
                              next
                                case P_HandleQuery_case_1
                                by solve( !KU( ~x ) @ #vk.58 )
                              next
                                case P_HandleQuery_case_2
                                by solve( !KU( ~x ) @ #vk.58 )
                              next
                                case c_seal
                                by contradiction /* from formulas */
                              qed
                            qed
                          qed
                        next
                          case P_HandleQuery_case_1
                          by solve( !KU( ~y ) @ #vk.59 )
                        next
                          case P_HandleQuery_case_2
                          by solve( !KU( ~y ) @ #vk.60 )
                        next
                          case c_exp
                          by solve( !KU( ~y ) @ #vk.60 )
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case c_seal
        by contradiction /* cyclic */
      qed
    next
      case T_HandleQuery___VARIANT_11
      solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', x^(~y*x.1)>)
             ) @ #vk.51 )
        case c_Extract
        solve( !KU( x^(~y*x.1) ) @ #vk.57 )
          case C_QueryGeneration___VARIANT_3_case_1
          by solve( !KU( ~y ) @ #vk.59 )
        next
          case C_QueryGeneration___VARIANT_3_case_2
          by solve( !KU( ~y ) @ #vk.60 )
        next
          case Generate_DH_key_pair_case_1
          by solve( !KU( ~y ) @ #vk.58 )
        next
          case Generate_DH_key_pair_case_2
          by solve( !KU( ~y ) @ #vk.59 )
        next
          case Generate_DH_key_pair_case_3
          solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~y*x)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^x, 'g'^~y>,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'key', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~y*x)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^x, 'g'^~y>,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                            $aead_id>,
                           req)
                 ) @ #vk.28 )
            case C_QueryGeneration___VARIANT_3
            by solve( !KU( ~x ) @ #vk.58 )
          next
            case P_HandleQuery_case_1
            by solve( !KU( ~x ) @ #vk.58 )
          next
            case P_HandleQuery_case_2
            by solve( !KU( ~x ) @ #vk.58 )
          next
            case c_seal
            by contradiction /* from formulas */
          qed
        next
          case P_HandleQuery_case_1
          by solve( !KU( ~y ) @ #vk.59 )
        next
          case P_HandleQuery_case_2
          by solve( !KU( ~y ) @ #vk.60 )
        next
          case c_exp
          by solve( !KU( ~y ) @ #vk.60 )
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_12
  solve( !KU( ~resp ) @ #k )
    case NonceReuse
    solve( !KU( seal(Expand(Extract(<x^(x.1*inv((~y*x.2))), ~resp_nonce
                                    >,
                                    Expand(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          x^(x.1*inv(x.2))>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x00', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 
                                                            'message_bhttp_request', '0x00', 
                                                            ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                  >,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                           '32')),
                            'key', '32'),
                     Expand(Extract(<x^(x.1*inv((~y*x.2))), ~resp_nonce>,
                                    Expand(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          x^(x.1*inv(x.2))>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x00', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 
                                                            'message_bhttp_request', '0x00', 
                                                            ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                  >,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                           '32')),
                            'nonce', '32'),
                     'blank', ~resp)
           ) @ #vk.13 )
      case T_HandleQuery___VARIANT_12
      solve( !KU( x^(x.1*inv((~y*x.2))) ) @ #vk.12 )
        case C_QueryGeneration___VARIANT_3_case_1
        by solve( !KU( ~y ) @ #vk.18 )
      next
        case C_QueryGeneration___VARIANT_3_case_2
        by solve( !KU( ~y ) @ #vk.20 )
      next
        case Generate_DH_key_pair_case_1
        by solve( !KU( ~y ) @ #vk.17 )
      next
        case Generate_DH_key_pair_case_2
        by solve( !KU( ~y ) @ #vk.19 )
      next
        case P_HandleQuery_case_1
        by solve( !KU( ~y ) @ #vk.18 )
      next
        case P_HandleQuery_case_2
        by solve( !KU( ~y ) @ #vk.20 )
      next
        case c_exp
        by solve( !KU( ~y ) @ #vk.20 )
      qed
    next
      case c_seal
      by contradiction /* cyclic */
    qed
  next
    case T_HandleQuery___VARIANT_12
    solve( !KU( ~resp_nonce ) @ #vk.35 )
      case T_HandleQuery___VARIANT_12
      solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                             <'32', 'HPKE_v1', 'shared_secret', 
                                              x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'key', '0x00', 
                               Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                               Extract('blank',
                                       <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                        ~key_id, $kem_id, $kdf_id, $aead_id>)
                              >,
                              '32'),
                       Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                             <'32', 'HPKE_v1', 'shared_secret', 
                                              x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                               Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                               Extract('blank',
                                       <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                        ~key_id, $kem_id, $kdf_id, $aead_id>)
                              >,
                              '32'),
                       <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                        $aead_id>,
                       req)
             ) @ #vk.25 )
        case c_seal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_2
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~resp ) @ #k )
      case NonceReuse
      solve( !KU( seal(Expand(Extract(<gx, ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            gx^~y>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', gx, 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'key', '32'),
                       Expand(Extract(<gx, ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            gx^~y>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', gx, 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'nonce', '32'),
                       'blank', ~resp)
             ) @ #vk.13 )
        case T_HandleQuery___VARIANT_2
        solve( !KU( seal(Expand(Extract(<gx, ~resp_nonce>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              gx^~y>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', gx, 'g'^~y>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                               '32')),
                                'key', '32'),
                         Expand(Extract(<gx, ~resp_nonce>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              gx^~y>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', gx, 'g'^~y>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                               '32')),
                                'nonce', '32'),
                         a2, p2)
               ) @ #vk.14 )
          case T_HandleQuery___VARIANT_2
          by contradiction /* from formulas */
        next
          case c_seal
          solve( !KU( Expand(Extract(<gx, ~resp_nonce>,
                                     Expand(Expand(Extract(Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', 
                                                                           gx^~y>),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', gx, 'g'^~y>,
                                                                  '32'),
                                                           <'HPKE_v1', 'secret', 'blank'>),
                                                   <'32', 'HPKE_v1', 'exp', '0x00', 
                                                    Extract('blank',
                                                            <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                    Extract('blank',
                                                            <'HPKE_v1', 'info_hash', 
                                                             'message_bhttp_request', '0x00', 
                                                             ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                   >,
                                                   '32'),
                                            <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                            '32')),
                             'nonce', '32')
                 ) @ #vk.16 )
            case c_Expand
            solve( !KU( Extract(<gx, ~resp_nonce>,
                                Expand(Expand(Extract(Expand(Extract('blank',
                                                                     <'HPKE_v1', 'eae_prk', gx^~y>),
                                                             <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                              'g'^~y>,
                                                             '32'),
                                                      <'HPKE_v1', 'secret', 'blank'>),
                                              <'32', 'HPKE_v1', 'exp', '0x00', 
                                               Extract('blank',
                                                       <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                               Extract('blank',
                                                       <'HPKE_v1', 'info_hash', 
                                                        'message_bhttp_request', '0x00', ~key_id, 
                                                        $kem_id, $kdf_id, $aead_id>)
                                              >,
                                              '32'),
                                       <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32'))
                   ) @ #vk.19 )
              case c_Extract
              solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', gx^~y>),
                                                       <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y
                                                       >,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                         Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                         Extract('blank',
                                                 <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                  '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                        >,
                                        '32'),
                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                     ) @ #vk.23 )
                case c_Expand
                solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                          <'HPKE_v1', 'eae_prk', gx^~y>),
                                                  <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                                  '32'),
                                           <'HPKE_v1', 'secret', 'blank'>),
                                   <'32', 'HPKE_v1', 'exp', '0x00', 
                                    Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                    Extract('blank',
                                            <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                             '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                   >,
                                   '32')
                       ) @ #vk.26 )
                  case c_Expand
                  solve( !KU( Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', gx^~y>),
                                             <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                      <'HPKE_v1', 'secret', 'blank'>)
                         ) @ #vk.34 )
                    case c_Extract
                    solve( !KU( Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>),
                                       <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32')
                           ) @ #vk.43 )
                      case c_Expand
                      solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>)
                             ) @ #vk.50 )
                        case c_Extract
                        solve( !KU( ~resp_nonce ) @ #vk.33 )
                          case T_HandleQuery___VARIANT_2
                          solve( !KU( Expand(Extract(<gx, ~resp_nonce>,
                                                     Expand(Expand(Extract(Expand(Extract('blank',
                                                                                          <
                                                                                           'HPKE_v1', 
                                                                                           'eae_prk', 
                                                                                           gx^~y>),
                                                                                  <'32', 'HPKE_v1', 
                                                                                   'shared_secret', 
                                                                                   gx, 'g'^~y>,
                                                                                  '32'),
                                                                           <'HPKE_v1', 'secret', 
                                                                            'blank'>),
                                                                   <'32', 'HPKE_v1', 'exp', '0x00', 
                                                                    Extract('blank',
                                                                            <'HPKE_v1', 
                                                                             'psk_id_hash', 'blank'
                                                                            >), 
                                                                    Extract('blank',
                                                                            <'HPKE_v1', 
                                                                             'info_hash', 
                                                                             'message_bhttp_request', 
                                                                             '0x00', ~key_id, 
                                                                             $kem_id, $kdf_id, 
                                                                             $aead_id>)
                                                                   >,
                                                                   '32'),
                                                            <'32', 'HPKE_v1', 'sec', 
                                                             'message_bhttp_response'>,
                                                            '32')),
                                             'key', '32')
                                 ) @ #vk.27 )
                            case c_Expand
                            solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            gx^~y>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', gx, 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'key', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            gx^~y>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', gx, 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'message_bhttp_request', '0x00', ~key_id, $kem_id, 
                                              $kdf_id, $aead_id>,
                                             req)
                                   ) @ #vk.28 )
                              case c_seal
                              by contradiction /* from formulas */
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case c_seal
        by contradiction /* cyclic */
      qed
    next
      case T_HandleQuery___VARIANT_2
      solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>)
             ) @ #vk.51 )
        case c_Extract
        solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', gx^~y>),
                                               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'key', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', gx^~y>),
                                               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                          $aead_id>,
                         req)
               ) @ #vk.25 )
          case c_seal
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_4
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~resp ) @ #k )
      case NonceReuse
      solve( !KU( seal(Expand(Extract(<z^inv(~y), ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', z
                                                                           >),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', z^inv(~y), 
                                                                    'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'key', '32'),
                       Expand(Extract(<z^inv(~y), ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', z
                                                                           >),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', z^inv(~y), 
                                                                    'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'nonce', '32'),
                       'blank', ~resp)
             ) @ #vk.13 )
        case T_HandleQuery___VARIANT_4
        solve( !KU( seal(Expand(Extract(<z^inv(~y), ~resp_nonce>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              z>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', z^inv(~y), 
                                                                      'g'^~y>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                               '32')),
                                'key', '32'),
                         Expand(Extract(<z^inv(~y), ~resp_nonce>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              z>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', z^inv(~y), 
                                                                      'g'^~y>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                               '32')),
                                'nonce', '32'),
                         a2, p2)
               ) @ #vk.14 )
          case T_HandleQuery___VARIANT_4
          by contradiction /* from formulas */
        next
          case c_seal
          solve( !KU( Expand(Extract(<z^inv(~y), ~resp_nonce>,
                                     Expand(Expand(Extract(Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', z
                                                                          >),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', z^inv(~y), 
                                                                   'g'^~y>,
                                                                  '32'),
                                                           <'HPKE_v1', 'secret', 'blank'>),
                                                   <'32', 'HPKE_v1', 'exp', '0x00', 
                                                    Extract('blank',
                                                            <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                    Extract('blank',
                                                            <'HPKE_v1', 'info_hash', 
                                                             'message_bhttp_request', '0x00', 
                                                             ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                   >,
                                                   '32'),
                                            <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                            '32')),
                             'nonce', '32')
                 ) @ #vk.16 )
            case c_Expand
            solve( !KU( Extract(<z^inv(~y), ~resp_nonce>,
                                Expand(Expand(Extract(Expand(Extract('blank',
                                                                     <'HPKE_v1', 'eae_prk', z>),
                                                             <'32', 'HPKE_v1', 'shared_secret', 
                                                              z^inv(~y), 'g'^~y>,
                                                             '32'),
                                                      <'HPKE_v1', 'secret', 'blank'>),
                                              <'32', 'HPKE_v1', 'exp', '0x00', 
                                               Extract('blank',
                                                       <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                               Extract('blank',
                                                       <'HPKE_v1', 'info_hash', 
                                                        'message_bhttp_request', '0x00', ~key_id, 
                                                        $kem_id, $kdf_id, $aead_id>)
                                              >,
                                              '32'),
                                       <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32'))
                   ) @ #vk.19 )
              case c_Extract
              solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', z>),
                                                       <'32', 'HPKE_v1', 'shared_secret', 
                                                        z^inv(~y), 'g'^~y>,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                         Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                         Extract('blank',
                                                 <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                  '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                        >,
                                        '32'),
                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                     ) @ #vk.23 )
                case c_Expand
                solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                          <'HPKE_v1', 'eae_prk', z>),
                                                  <'32', 'HPKE_v1', 'shared_secret', z^inv(~y), 
                                                   'g'^~y>,
                                                  '32'),
                                           <'HPKE_v1', 'secret', 'blank'>),
                                   <'32', 'HPKE_v1', 'exp', '0x00', 
                                    Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                    Extract('blank',
                                            <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                             '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                   >,
                                   '32')
                       ) @ #vk.26 )
                  case c_Expand
                  solve( !KU( z^inv(~y) ) @ #vk.17 )
                    case c_exp
                    by solve( !KU( ~y ) @ #vk.44 )
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case c_seal
        by contradiction /* cyclic */
      qed
    next
      case T_HandleQuery___VARIANT_4
      solve( !KU( z^inv(~y) ) @ #vk.19 )
        case c_exp
        by solve( !KU( ~y ) @ #vk.56 )
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_9
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~resp ) @ #k )
      case NonceReuse
      solve( !KU( seal(Expand(Extract(<x^(x.1*inv(~y)), ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            x^x.1>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 
                                                                    x^(x.1*inv(~y)), 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'key', '32'),
                       Expand(Extract(<x^(x.1*inv(~y)), ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            x^x.1>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 
                                                                    x^(x.1*inv(~y)), 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'nonce', '32'),
                       'blank', ~resp)
             ) @ #vk.13 )
        case T_HandleQuery___VARIANT_9
        solve( !KU( seal(Expand(Extract(<x^(x.1*inv(~y)), ~resp_nonce>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              x^x.1>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 
                                                                      x^(x.1*inv(~y)), 'g'^~y>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                               '32')),
                                'key', '32'),
                         Expand(Extract(<x^(x.1*inv(~y)), ~resp_nonce>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              x^x.1>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 
                                                                      x^(x.1*inv(~y)), 'g'^~y>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                               '32')),
                                'nonce', '32'),
                         a2, p2)
               ) @ #vk.14 )
          case T_HandleQuery___VARIANT_9
          by contradiction /* from formulas */
        next
          case c_seal
          solve( !KU( x^(x.1*inv(~y)) ) @ #vk.13 )
            case C_QueryGeneration___VARIANT_3_case_1
            by solve( !KU( ~y ) @ #vk.21 )
          next
            case C_QueryGeneration___VARIANT_3_case_2
            by solve( !KU( ~y ) @ #vk.23 )
          next
            case Generate_DH_key_pair_case_1
            by solve( !KU( ~y ) @ #vk.20 )
          next
            case Generate_DH_key_pair_case_2
            by solve( !KU( ~y ) @ #vk.22 )
          next
            case P_HandleQuery_case_1
            by solve( !KU( ~y ) @ #vk.21 )
          next
            case P_HandleQuery_case_2
            by solve( !KU( ~y ) @ #vk.23 )
          next
            case c_exp
            by solve( !KU( ~y ) @ #vk.23 )
          qed
        qed
      next
        case c_seal
        by contradiction /* cyclic */
      qed
    next
      case T_HandleQuery___VARIANT_9
      solve( !KU( ~resp_nonce ) @ #vk.35 )
        case T_HandleQuery___VARIANT_9
        solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', x^x.1>)
               ) @ #vk.51 )
          case c_Extract
          solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', x^x.1>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                  x^(x.1*inv(~y)), 'g'^~y>,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'key', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', x^x.1>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                  x^(x.1*inv(~y)), 'g'^~y>,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                            $aead_id>,
                           req)
                 ) @ #vk.28 )
            case c_seal
            by contradiction /* from formulas */
          qed
        qed
      qed
    qed
  qed
qed

lemma secret_cid [reuse]:
  all-traces
  "∀ C gx P key T gy cid req #j #k.
    ((C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧
     (!KU( cid ) @ #k)) ⇒
    (∃ #i. (RevSk( key ) @ #i) ∧ (#i < #k))"
/*
guarded formula characterizing all counter-examples:
"∃ C gx P key T gy cid req #j #k.
  (C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧ (!KU( cid ) @ #k)
 ∧
  ∀ #i. (RevSk( key ) @ #i) ⇒ ¬(#i < #k)"
*/
simplify
solve( C_QG( C, gx, P, key, T, gy, cid, req ) @ #j )
  case C_QueryGeneration___VARIANT_1
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, gy ) ▶₁ #j )
      case Generate_DH_key_pair
      by contradiction /* non-normal terms */
    qed
  qed
next
  case C_QueryGeneration___VARIANT_2
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    by solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, z^inv(~x)
              ) ▶₁ #j )
  qed
next
  case C_QueryGeneration___VARIANT_3
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>, x^x.1 ) ▶₁ #j )
      case Generate_DH_key_pair
      solve( !KU( ~cid ) @ #k.1 )
        case C_QueryGeneration___VARIANT_3
        solve( !KU( ~k ) @ #vk )
          case RevSK
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case C_QueryGeneration___VARIANT_4
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    by solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>,
                   x^inv((~x.1*x.2))
              ) ▶₁ #j )
  qed
next
  case C_QueryGeneration___VARIANT_5
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    by solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>,
                   x^(x.1*inv(~x.2))
              ) ▶₁ #j )
  qed
next
  case C_QueryGeneration___VARIANT_6
  solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
    case Starter
    by solve( !Pk( $T, <~key_id, kem_id, kdf_id, aead_id>,
                   x^(x.1*inv((~x.2*x.3)))
              ) ▶₁ #j )
  qed
qed

lemma request_binding:
  all-traces
  "∀ C gx P key T gy cid req #j #k #l.
    (((C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧
      (!KU( req ) @ #k)) ∧
     (!KU( cid ) @ #l)) ⇒
    (∃ sig_algs #h #i.
      (((RevDH( T, sig_algs, gy ) @ #h) ∧ (#h < #k)) ∧
       (RevSk( key ) @ #i)) ∧
      (#i < #l))"
/*
guarded formula characterizing all counter-examples:
"∃ C gx P key T gy cid req #j #k #l.
  (C_QG( C, gx, P, key, T, gy, cid, req ) @ #j) ∧
  (!KU( req ) @ #k) ∧
  (!KU( cid ) @ #l)
 ∧
  ∀ sig_algs #h #i.
   (RevDH( T, sig_algs, gy ) @ #h) ∧ (RevSk( key ) @ #i)
  ⇒
   ((¬(#h < #k)) ∨ (¬(#i < #l)))"
*/
simplify
by contradiction /* from formulas */

lemma consistency:
  all-traces
  "∀ req resp C gx T gy #j.
    (C_Done( req, resp, C, gx, T, gy ) @ #j) ⇒
    ((∃ tid #i.
       (T_Answer( tid, T, gx, gy, req, resp ) @ #i) ∧ (#i < #j)) ∨
     (∃ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ∧ (#i < #j)))"
/*
guarded formula characterizing all counter-examples:
"∃ req resp C gx T gy #j.
  (C_Done( req, resp, C, gx, T, gy ) @ #j)
 ∧
  (∀ tid #i.
    (T_Answer( tid, T, gx, gy, req, resp ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ sig_algs #i. (RevDH( T, sig_algs, gy ) @ #i) ⇒ ¬(#i < #j))"
*/
simplify
solve( C_Done( req, resp, C, gx, T, gy ) @ #j )
  case C_HandleResponse___VARIANT_2
  solve( C_ResponseHandler( ~request, $C, gx, $P, ~k, $T, gy,
                            shared_secret,
                            <'message_bhttp_request', '0x00', key_id, kem_id, kdf_id, aead_id>
         ) ▶₀ #j )
    case C_QueryGeneration___VARIANT_3
    solve( !KU( senc(<response_nonce, 
                      seal(Expand(Extract(<'g'^~x, response_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~x.1)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~x.1>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'key', '32'),
                           Expand(Extract(<'g'^~x, response_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~x.1)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~x.1>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'nonce', '32'),
                           'blank', resp)
                     >,
                     ~k)
           ) @ #vk )
      case P_HandleResponse
      solve( !KU( seal(Expand(Extract(<'g'^~x, response_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~x.1)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 
                                                                    'g'^~x.1>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'key', '32'),
                       Expand(Extract(<'g'^~x, response_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~x.1)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 
                                                                    'g'^~x.1>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'nonce', '32'),
                       'blank', resp)
             ) @ #vk.3 )
        case T_HandleQuery___VARIANT_11
        solve( !KU( ~resp_nonce ) @ #vk.3 )
          case T_HandleQuery___VARIANT_11
          solve( !KU( senc(<cid.1, 
                            <~key_id.1, $kem_id.1, $kdf_id.1, $aead_id.1>, gx, opaque>,
                           ~k)
                 ) @ #vk.4 )
            case C_QueryGeneration___VARIANT_3
            solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                    'g'^~x.1>,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'key', '0x00', 
                                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                     Extract('blank',
                                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                              '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                    >,
                                    '32'),
                             Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                    'g'^~x.1>,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                     Extract('blank',
                                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                              '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                    >,
                                    '32'),
                             <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                              $aead_id>,
                             request.1)
                   ) @ #vk.17 )
              case C_QueryGeneration___VARIANT_3
              by contradiction /* from formulas */
            next
              case P_HandleQuery_case_1
              by contradiction /* from formulas */
            next
              case P_HandleQuery_case_2
              by contradiction /* from formulas */
            next
              case c_seal
              solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1
                                                >,
                                                '32'),
                                         <'HPKE_v1', 'secret', 'blank'>),
                                 <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                  Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                  Extract('blank',
                                          <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                           ~key_id, $kem_id, $kdf_id, $aead_id>)
                                 >,
                                 '32')
                     ) @ #vk.20 )
                case c_Expand
                solve( !KU( Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>)
                       ) @ #vk.26 )
                  case c_Extract
                  solve( !KU( Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>, '32')
                         ) @ #vk.37 )
                    case c_Expand
                    solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                           ) @ #vk.44 )
                      case c_Extract
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.51 )
                        case C_QueryGeneration___VARIANT_3
                        by solve( !KU( ~x.1 ) @ #vk.53 )
                      next
                        case Generate_DH_key_pair
                        by solve( !KU( ~x ) @ #vk.52 )
                      next
                        case P_HandleQuery
                        by solve( !KU( ~x.1 ) @ #vk.52 )
                      next
                        case c_exp
                        by solve( !KU( ~x.1 ) @ #vk.55 )
                      qed
                    qed
                  qed
                qed
              qed
            qed
          next
            case c_senc
            solve( !KU( ~k ) @ #vk.19 )
              case RevSK
              solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                      'g'^~x.1>,
                                                     '32'),
                                              <'HPKE_v1', 'secret', 'blank'>),
                                      <'32', 'HPKE_v1', 'key', '0x00', 
                                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                       Extract('blank',
                                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                      >,
                                      '32'),
                               Expand(Extract(Expand(Extract('blank',
                                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                      'g'^~x.1>,
                                                     '32'),
                                              <'HPKE_v1', 'secret', 'blank'>),
                                      <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                       Extract('blank',
                                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                      >,
                                      '32'),
                               <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                                $aead_id>,
                               request.1)
                     ) @ #vk.18 )
                case C_QueryGeneration___VARIANT_3
                by contradiction /* from formulas */
              next
                case P_HandleQuery_case_1
                by contradiction /* cyclic */
              next
                case P_HandleQuery_case_2
                by contradiction /* cyclic */
              next
                case c_seal
                solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                          <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                  <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                   'g'^~x.1>,
                                                  '32'),
                                           <'HPKE_v1', 'secret', 'blank'>),
                                   <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                    Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                    Extract('blank',
                                            <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                             '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                   >,
                                   '32')
                       ) @ #vk.34 )
                  case c_Expand
                  solve( !KU( Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>)
                         ) @ #vk.40 )
                    case c_Extract
                    solve( !KU( Expand(Extract('blank',
                                               <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                       <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>, '32')
                           ) @ #vk.51 )
                      case c_Expand
                      solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                             ) @ #vk.58 )
                        case c_Extract
                        solve( !KU( 'g'^(~x*~x.1) ) @ #vk.65 )
                          case C_QueryGeneration___VARIANT_3
                          by solve( !KU( ~x.1 ) @ #vk.66 )
                        next
                          case Generate_DH_key_pair
                          by solve( !KU( ~x ) @ #vk.66 )
                        next
                          case P_HandleQuery
                          by contradiction /* cyclic */
                        next
                          case c_exp
                          by solve( !KU( ~x ) @ #vk.68 )
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case c_seal
        solve( !KU( Expand(Extract(<'g'^~x, response_nonce>,
                                   Expand(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         'g'^(~x*~x.1)>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x, 'g'^~x.1>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                 >,
                                                 '32'),
                                          <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                          '32')),
                           'nonce', '32')
               ) @ #vk.6 )
          case c_Expand
          solve( !KU( Extract(<'g'^~x, response_nonce>,
                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                             Extract('blank',
                                                     <'HPKE_v1', 'info_hash', 
                                                      'message_bhttp_request', '0x00', ~key_id, 
                                                      $kem_id, $kdf_id, $aead_id>)
                                            >,
                                            '32'),
                                     <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32'))
                 ) @ #vk.9 )
            case c_Extract
            solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                      'g'^~x.1>,
                                                     '32'),
                                              <'HPKE_v1', 'secret', 'blank'>),
                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                       Extract('blank',
                                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                      >,
                                      '32'),
                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                   ) @ #vk.13 )
              case c_Expand
              solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1
                                                >,
                                                '32'),
                                         <'HPKE_v1', 'secret', 'blank'>),
                                 <'32', 'HPKE_v1', 'exp', '0x00', 
                                  Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                  Extract('blank',
                                          <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                           ~key_id, $kem_id, $kdf_id, $aead_id>)
                                 >,
                                 '32')
                     ) @ #vk.16 )
                case c_Expand
                solve( !KU( Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>)
                       ) @ #vk.24 )
                  case c_Extract
                  solve( !KU( Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>, '32')
                         ) @ #vk.34 )
                    case c_Expand
                    solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                           ) @ #vk.39 )
                      case c_Extract
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.46 )
                        case C_QueryGeneration___VARIANT_3
                        by solve( !KU( ~x.1 ) @ #vk.48 )
                      next
                        case Generate_DH_key_pair
                        by solve( !KU( ~x ) @ #vk.47 )
                      next
                        case P_HandleQuery
                        by solve( !KU( ~x.1 ) @ #vk.47 )
                      next
                        case c_exp
                        by solve( !KU( ~x ) @ #vk.49 )
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    next
      case c_senc
      solve( !KU( seal(Expand(Extract(<'g'^~x, response_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~x.1)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 
                                                                    'g'^~x.1>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'key', '32'),
                       Expand(Extract(<'g'^~x, response_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~x.1)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 
                                                                    'g'^~x.1>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'nonce', '32'),
                       'blank', resp)
             ) @ #vk.4 )
        case T_HandleQuery___VARIANT_11
        solve( !KU( ~resp_nonce ) @ #vk.4 )
          case T_HandleQuery___VARIANT_11
          solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'key', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                   Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                   Extract('blank',
                                           <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                            '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                  >,
                                  '32'),
                           <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                            $aead_id>,
                           request.1)
                 ) @ #vk.17 )
            case C_QueryGeneration___VARIANT_3
            by contradiction /* from formulas */
          next
            case P_HandleQuery_case_1
            by contradiction /* from formulas */
          next
            case P_HandleQuery_case_2
            by contradiction /* from formulas */
          next
            case c_seal
            solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                      <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                              <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                              '32'),
                                       <'HPKE_v1', 'secret', 'blank'>),
                               <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                Extract('blank',
                                        <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                         ~key_id, $kem_id, $kdf_id, $aead_id>)
                               >,
                               '32')
                   ) @ #vk.20 )
              case c_Expand
              solve( !KU( Extract(Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                         '32'),
                                  <'HPKE_v1', 'secret', 'blank'>)
                     ) @ #vk.26 )
                case c_Extract
                solve( !KU( Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>, '32')
                       ) @ #vk.37 )
                  case c_Expand
                  solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                         ) @ #vk.44 )
                    case c_Extract
                    solve( !KU( 'g'^(~x*~x.1) ) @ #vk.51 )
                      case C_QueryGeneration___VARIANT_3
                      by solve( !KU( ~x.1 ) @ #vk.52 )
                    next
                      case Generate_DH_key_pair
                      by solve( !KU( ~x ) @ #vk.52 )
                    next
                      case P_HandleQuery
                      by solve( !KU( ~x.1 ) @ #vk.53 )
                    next
                      case c_exp
                      by solve( !KU( ~x ) @ #vk.54 )
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case c_seal
        solve( !KU( Expand(Extract(<'g'^~x, response_nonce>,
                                   Expand(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         'g'^(~x*~x.1)>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x, 'g'^~x.1>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                 >,
                                                 '32'),
                                          <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                          '32')),
                           'nonce', '32')
               ) @ #vk.6 )
          case c_Expand
          solve( !KU( Extract(<'g'^~x, response_nonce>,
                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                             Extract('blank',
                                                     <'HPKE_v1', 'info_hash', 
                                                      'message_bhttp_request', '0x00', ~key_id, 
                                                      $kem_id, $kdf_id, $aead_id>)
                                            >,
                                            '32'),
                                     <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32'))
                 ) @ #vk.9 )
            case c_Extract
            solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                      'g'^~x.1>,
                                                     '32'),
                                              <'HPKE_v1', 'secret', 'blank'>),
                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                       Extract('blank',
                                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                      >,
                                      '32'),
                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                   ) @ #vk.13 )
              case c_Expand
              solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1
                                                >,
                                                '32'),
                                         <'HPKE_v1', 'secret', 'blank'>),
                                 <'32', 'HPKE_v1', 'exp', '0x00', 
                                  Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                  Extract('blank',
                                          <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                           ~key_id, $kem_id, $kdf_id, $aead_id>)
                                 >,
                                 '32')
                     ) @ #vk.16 )
                case c_Expand
                solve( !KU( Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>)
                       ) @ #vk.24 )
                  case c_Extract
                  solve( !KU( Expand(Extract('blank',
                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>, '32')
                         ) @ #vk.34 )
                    case c_Expand
                    solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                           ) @ #vk.39 )
                      case c_Extract
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.46 )
                        case C_QueryGeneration___VARIANT_3
                        by solve( !KU( ~x.1 ) @ #vk.47 )
                      next
                        case Generate_DH_key_pair
                        by solve( !KU( ~x ) @ #vk.47 )
                      next
                        case P_HandleQuery
                        by solve( !KU( ~x.1 ) @ #vk.48 )
                      next
                        case c_exp
                        by solve( !KU( ~x ) @ #vk.49 )
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma reach_nonce_reuse:
  all-traces
  "∀ ttid T gx gy query answer key n a #j #k.
    ((T_Answer( ttid, T, gx, gy, query, answer ) @ #j) ∧
     (ReuseNonce( key, n, a, answer ) @ #k)) ⇒
    ((∃ kid #i. (RevDH( T, kid, gy ) @ #i) ∧ (#i < #k)) ∨
     (∃ #i. (!KU( query ) @ #i) ∧ (#i < #k)))"
/*
guarded formula characterizing all counter-examples:
"∃ ttid T gx gy query answer key n a #j #k.
  (T_Answer( ttid, T, gx, gy, query, answer ) @ #j) ∧
  (ReuseNonce( key, n, a, answer ) @ #k)
 ∧
  (∀ kid #i. (RevDH( T, kid, gy ) @ #i) ⇒ ¬(#i < #k)) ∧
  (∀ #i. (!KU( query ) @ #i) ⇒ ¬(#i < #k))"
*/
simplify
solve( T_Answer( ttid, T, gx, gy, query, answer ) @ #j )
  case T_HandleQuery___VARIANT_10
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( x^inv((~y*x.1)) ) @ #vk.13 )
      case c_exp
      by solve( !KU( ~y ) @ #vk.18 )
    qed
  qed
next
  case T_HandleQuery___VARIANT_11
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                      $aead_id>,
                     query)
           ) @ #vk.14 )
      case C_QueryGeneration___VARIANT_3
      solve( !KU( ~k.1 ) @ #vk.15 )
        case RevSK
        solve( !KU( seal(key, n, a2, ~resp) ) @ #vk.4 )
          case T_HandleQuery___VARIANT_11
          solve( !KU( seal(Expand(Extract(<'g'^~x, ~resp_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'key', '32'),
                           Expand(Extract(<'g'^~x, ~resp_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'nonce', '32'),
                           a1, a)
                 ) @ #vk.5 )
            case T_HandleQuery___VARIANT_11
            by contradiction /* from formulas */
          next
            case c_seal
            solve( !KU( Expand(Extract(<'g'^~x, ~resp_nonce>,
                                       Expand(Expand(Extract(Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~y)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 'g'^~y
                                                                    >,
                                                                    '32'),
                                                             <'HPKE_v1', 'secret', 'blank'>),
                                                     <'32', 'HPKE_v1', 'exp', '0x00', 
                                                      Extract('blank',
                                                              <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                      Extract('blank',
                                                              <'HPKE_v1', 'info_hash', 
                                                               'message_bhttp_request', '0x00', 
                                                               ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                     >,
                                                     '32'),
                                              <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                              '32')),
                               'key', '32')
                   ) @ #vk.16 )
              case c_Expand
              solve( !KU( Expand(Extract(<'g'^~x, ~resp_nonce>,
                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~y)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~y>,
                                                                      '32'),
                                                               <'HPKE_v1', 'secret', 'blank'>),
                                                       <'32', 'HPKE_v1', 'exp', '0x00', 
                                                        Extract('blank',
                                                                <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                >), 
                                                        Extract('blank',
                                                                <'HPKE_v1', 'info_hash', 
                                                                 'message_bhttp_request', '0x00', 
                                                                 ~key_id, $kem_id, $kdf_id, $aead_id
                                                                >)
                                                       >,
                                                       '32'),
                                                <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                '32')),
                                 'nonce', '32')
                     ) @ #vk.17 )
                case c_Expand
                solve( !KU( Extract(<'g'^~x, ~resp_nonce>,
                                    Expand(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^(~x*~y)>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g'^~x, 'g'^~y>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x00', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 
                                                            'message_bhttp_request', '0x00', 
                                                            ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                  >,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                           '32'))
                       ) @ #vk.20 )
                  case c_Extract
                  solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~y)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~y>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                             Extract('blank',
                                                     <'HPKE_v1', 'info_hash', 
                                                      'message_bhttp_request', '0x00', ~key_id, 
                                                      $kem_id, $kdf_id, $aead_id>)
                                            >,
                                            '32'),
                                     <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                         ) @ #vk.25 )
                    case c_Expand
                    solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                              <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                      <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                       'g'^~y>,
                                                      '32'),
                                               <'HPKE_v1', 'secret', 'blank'>),
                                       <'32', 'HPKE_v1', 'exp', '0x00', 
                                        Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                        Extract('blank',
                                                <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                 '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                       >,
                                       '32')
                           ) @ #vk.28 )
                      case c_Expand
                      solve( !KU( Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y>,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>)
                             ) @ #vk.36 )
                        case c_Extract
                        solve( !KU( Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y>, '32')
                               ) @ #vk.45 )
                          case c_Expand
                          solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>)
                                 ) @ #vk.52 )
                            case c_Extract
                            solve( !KU( 'g'^(~x*~y) ) @ #vk.59 )
                              case C_QueryGeneration___VARIANT_3
                              by solve( !KU( ~y ) @ #vk.60 )
                            next
                              case Generate_DH_key_pair
                              by solve( !KU( ~x ) @ #vk.60 )
                            next
                              case c_exp
                              by solve( !KU( ~x ) @ #vk.62 )
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        next
          case c_seal
          solve( !KU( ~resp ) @ #vk.19 )
            case NonceReuse
            solve( !KU( seal(Expand(Extract(<'g'^~x, ~resp_nonce>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'psk_id_hash', 
                                                                    'blank'>), 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'message_bhttp_request', 
                                                                    '0x00', ~key_id, $kem_id, 
                                                                    $kdf_id, $aead_id>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'
                                                   >,
                                                   '32')),
                                    'key', '32'),
                             Expand(Extract(<'g'^~x, ~resp_nonce>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'psk_id_hash', 
                                                                    'blank'>), 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'message_bhttp_request', 
                                                                    '0x00', ~key_id, $kem_id, 
                                                                    $kdf_id, $aead_id>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'
                                                   >,
                                                   '32')),
                                    'nonce', '32'),
                             'blank', ~resp)
                   ) @ #vk.20 )
              case T_HandleQuery___VARIANT_11
              solve( !KU( seal(Expand(Extract(<'g'^~x, ~resp_nonce>,
                                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'),
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'psk_id_hash', 
                                                                      'blank'>), 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'message_bhttp_request', 
                                                                      '0x00', ~key_id, $kem_id, 
                                                                      $kdf_id, $aead_id>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 
                                                      'message_bhttp_response'>,
                                                     '32')),
                                      'key', '32'),
                               Expand(Extract(<'g'^~x, ~resp_nonce>,
                                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'),
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'psk_id_hash', 
                                                                      'blank'>), 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'message_bhttp_request', 
                                                                      '0x00', ~key_id, $kem_id, 
                                                                      $kdf_id, $aead_id>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 
                                                      'message_bhttp_response'>,
                                                     '32')),
                                      'nonce', '32'),
                               a2.1, p2)
                     ) @ #vk.21 )
                case T_HandleQuery___VARIANT_11
                by contradiction /* from formulas */
              next
                case c_seal
                solve( !KU( Expand(Extract(<'g'^~x, ~resp_nonce>,
                                           Expand(Expand(Extract(Expand(Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'eae_prk', 
                                                                                 'g'^(~x*~y)>),
                                                                        <'32', 'HPKE_v1', 
                                                                         'shared_secret', 'g'^~x, 
                                                                         'g'^~y>,
                                                                        '32'),
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x00', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                  >), 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 
                                                                   'message_bhttp_request', '0x00', 
                                                                   ~key_id, $kem_id, $kdf_id, 
                                                                   $aead_id>)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'
                                                  >,
                                                  '32')),
                                   'key', '32')
                       ) @ #vk.22 )
                  case c_Expand
                  solve( !KU( Expand(Extract(<'g'^~x, ~resp_nonce>,
                                             Expand(Expand(Extract(Expand(Extract('blank',
                                                                                  <'HPKE_v1', 
                                                                                   'eae_prk', 
                                                                                   'g'^(~x*~y)>),
                                                                          <'32', 'HPKE_v1', 
                                                                           'shared_secret', 'g'^~x, 
                                                                           'g'^~y>,
                                                                          '32'),
                                                                   <'HPKE_v1', 'secret', 'blank'>),
                                                           <'32', 'HPKE_v1', 'exp', '0x00', 
                                                            Extract('blank',
                                                                    <'HPKE_v1', 'psk_id_hash', 
                                                                     'blank'>), 
                                                            Extract('blank',
                                                                    <'HPKE_v1', 'info_hash', 
                                                                     'message_bhttp_request', 
                                                                     '0x00', ~key_id, $kem_id, 
                                                                     $kdf_id, $aead_id>)
                                                           >,
                                                           '32'),
                                                    <'32', 'HPKE_v1', 'sec', 
                                                     'message_bhttp_response'>,
                                                    '32')),
                                     'nonce', '32')
                         ) @ #vk.23 )
                    case c_Expand
                    solve( !KU( Extract(<'g'^~x, ~resp_nonce>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~y)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~y>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'psk_id_hash', 'blank'
                                                               >), 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 
                                                                'message_bhttp_request', '0x00', 
                                                                ~key_id, $kem_id, $kdf_id, $aead_id
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                               '32'))
                           ) @ #vk.26 )
                      case c_Extract
                      solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                       <'HPKE_v1', 'eae_prk', 
                                                                        'g'^(~x*~y)>),
                                                               <'32', 'HPKE_v1', 'shared_secret', 
                                                                'g'^~x, 'g'^~y>,
                                                               '32'),
                                                        <'HPKE_v1', 'secret', 'blank'>),
                                                <'32', 'HPKE_v1', 'exp', '0x00', 
                                                 Extract('blank',
                                                         <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                 Extract('blank',
                                                         <'HPKE_v1', 'info_hash', 
                                                          'message_bhttp_request', '0x00', ~key_id, 
                                                          $kem_id, $kdf_id, $aead_id>)
                                                >,
                                                '32'),
                                         <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                             ) @ #vk.31 )
                        case c_Expand
                        solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                                  <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)
                                                                  >),
                                                          <'32', 'HPKE_v1', 'shared_secret', 
                                                           'g'^~x, 'g'^~y>,
                                                          '32'),
                                                   <'HPKE_v1', 'secret', 'blank'>),
                                           <'32', 'HPKE_v1', 'exp', '0x00', 
                                            Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                            Extract('blank',
                                                    <'HPKE_v1', 'info_hash', 
                                                     'message_bhttp_request', '0x00', ~key_id, 
                                                     $kem_id, $kdf_id, $aead_id>)
                                           >,
                                           '32')
                               ) @ #vk.34 )
                          case c_Expand
                          solve( !KU( Extract(Expand(Extract('blank',
                                                             <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                     <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                      'g'^~y>,
                                                     '32'),
                                              <'HPKE_v1', 'secret', 'blank'>)
                                 ) @ #vk.42 )
                            case c_Extract
                            solve( !KU( Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y>,
                                               '32')
                                   ) @ #vk.51 )
                              case c_Expand
                              solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>)
                                     ) @ #vk.58 )
                                case c_Extract
                                solve( !KU( 'g'^(~x*~y) ) @ #vk.65 )
                                  case C_QueryGeneration___VARIANT_3
                                  by solve( !KU( ~y ) @ #vk.66 )
                                next
                                  case Generate_DH_key_pair
                                  by solve( !KU( ~x ) @ #vk.66 )
                                next
                                  case c_exp
                                  by solve( !KU( ~x ) @ #vk.68 )
                                qed
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            next
              case c_seal
              by contradiction /* cyclic */
            qed
          next
            case T_HandleQuery___VARIANT_11
            solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>)
                   ) @ #vk.58 )
              case c_Extract
              solve( !KU( 'g'^(~x*~y) ) @ #vk.64 )
                case C_QueryGeneration___VARIANT_3
                by solve( !KU( ~y ) @ #vk.65 )
              next
                case Generate_DH_key_pair
                by solve( !KU( ~x ) @ #vk.65 )
              next
                case c_exp
                by solve( !KU( ~x ) @ #vk.67 )
              qed
            qed
          qed
        qed
      qed
    next
      case P_HandleQuery_case_1
      solve( !KU( senc(<~cid, <~key_id, $kem_id, $kdf_id, $aead_id>, 
                        'g'^~x, 
                        seal(Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y
                                                   >,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'key', '0x00', 
                                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                     Extract('blank',
                                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                              '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                    >,
                                    '32'),
                             Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y
                                                   >,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                     Extract('blank',
                                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                              '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                    >,
                                    '32'),
                             <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                              $aead_id>,
                             ~req)
                       >,
                       ~k.1)
             ) @ #vk.15 )
        case C_QueryGeneration___VARIANT_3
        solve( !KU( seal(key, n, a2, ~resp) ) @ #vk.5 )
          case T_HandleQuery___VARIANT_11
          solve( !KU( seal(Expand(Extract(<'g'^~x, ~resp_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'key', '32'),
                           Expand(Extract(<'g'^~x, ~resp_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'nonce', '32'),
                           a1, a)
                 ) @ #vk.6 )
            case T_HandleQuery___VARIANT_11
            by contradiction /* from formulas */
          next
            case c_seal
            solve( !KU( Expand(Extract(<'g'^~x, ~resp_nonce>,
                                       Expand(Expand(Extract(Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~y)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 'g'^~y
                                                                    >,
                                                                    '32'),
                                                             <'HPKE_v1', 'secret', 'blank'>),
                                                     <'32', 'HPKE_v1', 'exp', '0x00', 
                                                      Extract('blank',
                                                              <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                      Extract('blank',
                                                              <'HPKE_v1', 'info_hash', 
                                                               'message_bhttp_request', '0x00', 
                                                               ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                     >,
                                                     '32'),
                                              <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                              '32')),
                               'key', '32')
                   ) @ #vk.16 )
              case c_Expand
              solve( !KU( Extract(<'g'^~x, ~resp_nonce>,
                                  Expand(Expand(Extract(Expand(Extract('blank',
                                                                       <'HPKE_v1', 'eae_prk', 
                                                                        'g'^(~x*~y)>),
                                                               <'32', 'HPKE_v1', 'shared_secret', 
                                                                'g'^~x, 'g'^~y>,
                                                               '32'),
                                                        <'HPKE_v1', 'secret', 'blank'>),
                                                <'32', 'HPKE_v1', 'exp', '0x00', 
                                                 Extract('blank',
                                                         <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                 Extract('blank',
                                                         <'HPKE_v1', 'info_hash', 
                                                          'message_bhttp_request', '0x00', ~key_id, 
                                                          $kem_id, $kdf_id, $aead_id>)
                                                >,
                                                '32'),
                                         <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32'))
                     ) @ #vk.20 )
                case c_Extract
                solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                 <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)
                                                                 >),
                                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                          'g'^~y>,
                                                         '32'),
                                                  <'HPKE_v1', 'secret', 'blank'>),
                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                           Extract('blank',
                                                   <'HPKE_v1', 'info_hash', 
                                                    'message_bhttp_request', '0x00', ~key_id, 
                                                    $kem_id, $kdf_id, $aead_id>)
                                          >,
                                          '32'),
                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                       ) @ #vk.24 )
                  case c_Expand
                  solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                            <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                    <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                     'g'^~y>,
                                                    '32'),
                                             <'HPKE_v1', 'secret', 'blank'>),
                                     <'32', 'HPKE_v1', 'exp', '0x00', 
                                      Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                      Extract('blank',
                                              <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                               '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                     >,
                                     '32')
                         ) @ #vk.27 )
                    case c_Expand
                    solve( !KU( Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>)
                           ) @ #vk.35 )
                      case c_Extract
                      solve( !KU( Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y>, '32')
                             ) @ #vk.44 )
                        case c_Expand
                        solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>)
                               ) @ #vk.51 )
                          case c_Extract
                          solve( !KU( 'g'^(~x*~y) ) @ #vk.58 )
                            case Generate_DH_key_pair
                            by solve( !KU( ~x ) @ #vk.59 )
                          next
                            case P_HandleQuery
                            by contradiction /* cyclic */
                          next
                            case c_exp
                            by solve( !KU( ~x ) @ #vk.61 )
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        next
          case c_seal
          solve( !KU( ~resp ) @ #vk.19 )
            case NonceReuse
            solve( !KU( seal(Expand(Extract(<'g'^~x, ~resp_nonce>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'psk_id_hash', 
                                                                    'blank'>), 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'message_bhttp_request', 
                                                                    '0x00', ~key_id, $kem_id, 
                                                                    $kdf_id, $aead_id>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'
                                                   >,
                                                   '32')),
                                    'key', '32'),
                             Expand(Extract(<'g'^~x, ~resp_nonce>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'psk_id_hash', 
                                                                    'blank'>), 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'message_bhttp_request', 
                                                                    '0x00', ~key_id, $kem_id, 
                                                                    $kdf_id, $aead_id>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'
                                                   >,
                                                   '32')),
                                    'nonce', '32'),
                             'blank', ~resp)
                   ) @ #vk.20 )
              case T_HandleQuery___VARIANT_11
              solve( !KU( seal(Expand(Extract(<'g'^~x, ~resp_nonce>,
                                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'),
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'psk_id_hash', 
                                                                      'blank'>), 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'message_bhttp_request', 
                                                                      '0x00', ~key_id, $kem_id, 
                                                                      $kdf_id, $aead_id>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 
                                                      'message_bhttp_response'>,
                                                     '32')),
                                      'key', '32'),
                               Expand(Extract(<'g'^~x, ~resp_nonce>,
                                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'),
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'psk_id_hash', 
                                                                      'blank'>), 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'message_bhttp_request', 
                                                                      '0x00', ~key_id, $kem_id, 
                                                                      $kdf_id, $aead_id>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 
                                                      'message_bhttp_response'>,
                                                     '32')),
                                      'nonce', '32'),
                               a2.1, p2)
                     ) @ #vk.21 )
                case T_HandleQuery___VARIANT_11
                by contradiction /* from formulas */
              next
                case c_seal
                solve( !KU( Expand(Extract(<'g'^~x, ~resp_nonce>,
                                           Expand(Expand(Extract(Expand(Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'eae_prk', 
                                                                                 'g'^(~x*~y)>),
                                                                        <'32', 'HPKE_v1', 
                                                                         'shared_secret', 'g'^~x, 
                                                                         'g'^~y>,
                                                                        '32'),
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x00', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                  >), 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 
                                                                   'message_bhttp_request', '0x00', 
                                                                   ~key_id, $kem_id, $kdf_id, 
                                                                   $aead_id>)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'
                                                  >,
                                                  '32')),
                                   'nonce', '32')
                       ) @ #vk.23 )
                  case c_Expand
                  solve( !KU( Extract(<'g'^~x, ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~y)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 'g'^~y
                                                                   >,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32'))
                         ) @ #vk.26 )
                    case c_Extract
                    solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                     <'HPKE_v1', 'eae_prk', 
                                                                      'g'^(~x*~y)>),
                                                             <'32', 'HPKE_v1', 'shared_secret', 
                                                              'g'^~x, 'g'^~y>,
                                                             '32'),
                                                      <'HPKE_v1', 'secret', 'blank'>),
                                              <'32', 'HPKE_v1', 'exp', '0x00', 
                                               Extract('blank',
                                                       <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                               Extract('blank',
                                                       <'HPKE_v1', 'info_hash', 
                                                        'message_bhttp_request', '0x00', ~key_id, 
                                                        $kem_id, $kdf_id, $aead_id>)
                                              >,
                                              '32'),
                                       <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                           ) @ #vk.30 )
                      case c_Expand
                      solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                                <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)
                                                                >),
                                                        <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                         'g'^~y>,
                                                        '32'),
                                                 <'HPKE_v1', 'secret', 'blank'>),
                                         <'32', 'HPKE_v1', 'exp', '0x00', 
                                          Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                          Extract('blank',
                                                  <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                   '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                         >,
                                         '32')
                             ) @ #vk.33 )
                        case c_Expand
                        solve( !KU( Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y
                                                   >,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>)
                               ) @ #vk.41 )
                          case c_Extract
                          solve( !KU( Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y>,
                                             '32')
                                 ) @ #vk.50 )
                            case c_Expand
                            solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>)
                                   ) @ #vk.57 )
                              case c_Extract
                              solve( !KU( 'g'^(~x*~y) ) @ #vk.64 )
                                case Generate_DH_key_pair
                                by solve( !KU( ~x ) @ #vk.65 )
                              next
                                case P_HandleQuery
                                by contradiction /* cyclic */
                              next
                                case c_exp
                                by solve( !KU( ~x ) @ #vk.67 )
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            next
              case c_seal
              by contradiction /* cyclic */
            qed
          next
            case T_HandleQuery___VARIANT_11
            solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>)
                   ) @ #vk.58 )
              case c_Extract
              solve( !KU( 'g'^(~x*~y) ) @ #vk.64 )
                case Generate_DH_key_pair
                by solve( !KU( ~x ) @ #vk.65 )
              next
                case P_HandleQuery
                by contradiction /* cyclic */
              next
                case c_exp
                by solve( !KU( ~x ) @ #vk.67 )
              qed
            qed
          qed
        qed
      next
        case P_HandleResponse
        by contradiction /* cyclic */
      next
        case c_senc
        by contradiction /* cyclic */
      qed
    next
      case P_HandleQuery_case_2
      solve( !KU( senc(<~cid, <~key_id, $kem_id, $kdf_id, $aead_id>, 
                        'g'^~x, 
                        seal(Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y
                                                   >,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'key', '0x00', 
                                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                     Extract('blank',
                                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                              '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                    >,
                                    '32'),
                             Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y
                                                   >,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                     Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                     Extract('blank',
                                             <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                              '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                    >,
                                    '32'),
                             <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                              $aead_id>,
                             ~req)
                       >,
                       ~k.1)
             ) @ #vk.15 )
        case C_QueryGeneration___VARIANT_3
        solve( !KU( seal(key, n, a2, ~resp) ) @ #vk.5 )
          case T_HandleQuery___VARIANT_11
          solve( !KU( seal(Expand(Extract(<'g'^~x, ~resp_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'key', '32'),
                           Expand(Extract(<'g'^~x, ~resp_nonce>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x00', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                 >), 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'message_bhttp_request', '0x00', 
                                                                  ~key_id, $kem_id, $kdf_id, 
                                                                  $aead_id>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                                 '32')),
                                  'nonce', '32'),
                           a1, a)
                 ) @ #vk.6 )
            case T_HandleQuery___VARIANT_11
            by contradiction /* from formulas */
          next
            case c_seal
            solve( !KU( Expand(Extract(<'g'^~x, ~resp_nonce>,
                                       Expand(Expand(Extract(Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~y)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 'g'^~y
                                                                    >,
                                                                    '32'),
                                                             <'HPKE_v1', 'secret', 'blank'>),
                                                     <'32', 'HPKE_v1', 'exp', '0x00', 
                                                      Extract('blank',
                                                              <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                      Extract('blank',
                                                              <'HPKE_v1', 'info_hash', 
                                                               'message_bhttp_request', '0x00', 
                                                               ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                     >,
                                                     '32'),
                                              <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                              '32')),
                               'nonce', '32')
                   ) @ #vk.17 )
              case c_Expand
              solve( !KU( Extract(<'g'^~x, ~resp_nonce>,
                                  Expand(Expand(Extract(Expand(Extract('blank',
                                                                       <'HPKE_v1', 'eae_prk', 
                                                                        'g'^(~x*~y)>),
                                                               <'32', 'HPKE_v1', 'shared_secret', 
                                                                'g'^~x, 'g'^~y>,
                                                               '32'),
                                                        <'HPKE_v1', 'secret', 'blank'>),
                                                <'32', 'HPKE_v1', 'exp', '0x00', 
                                                 Extract('blank',
                                                         <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                 Extract('blank',
                                                         <'HPKE_v1', 'info_hash', 
                                                          'message_bhttp_request', '0x00', ~key_id, 
                                                          $kem_id, $kdf_id, $aead_id>)
                                                >,
                                                '32'),
                                         <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32'))
                     ) @ #vk.20 )
                case c_Extract
                solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                 <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)
                                                                 >),
                                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                          'g'^~y>,
                                                         '32'),
                                                  <'HPKE_v1', 'secret', 'blank'>),
                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                           Extract('blank',
                                                   <'HPKE_v1', 'info_hash', 
                                                    'message_bhttp_request', '0x00', ~key_id, 
                                                    $kem_id, $kdf_id, $aead_id>)
                                          >,
                                          '32'),
                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                       ) @ #vk.24 )
                  case c_Expand
                  solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                            <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                    <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                     'g'^~y>,
                                                    '32'),
                                             <'HPKE_v1', 'secret', 'blank'>),
                                     <'32', 'HPKE_v1', 'exp', '0x00', 
                                      Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                      Extract('blank',
                                              <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                               '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                     >,
                                     '32')
                         ) @ #vk.27 )
                    case c_Expand
                    solve( !KU( Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>)
                           ) @ #vk.35 )
                      case c_Extract
                      solve( !KU( Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y>, '32')
                             ) @ #vk.44 )
                        case c_Expand
                        solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>)
                               ) @ #vk.51 )
                          case c_Extract
                          solve( !KU( 'g'^(~x*~y) ) @ #vk.58 )
                            case Generate_DH_key_pair
                            by solve( !KU( ~x ) @ #vk.59 )
                          next
                            case P_HandleQuery
                            by solve( !KU( ~y ) @ #vk.59 )
                          next
                            case c_exp
                            by solve( !KU( ~x ) @ #vk.61 )
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        next
          case c_seal
          solve( !KU( ~resp ) @ #vk.19 )
            case NonceReuse
            solve( !KU( seal(Expand(Extract(<'g'^~x, ~resp_nonce>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'psk_id_hash', 
                                                                    'blank'>), 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'message_bhttp_request', 
                                                                    '0x00', ~key_id, $kem_id, 
                                                                    $kdf_id, $aead_id>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'
                                                   >,
                                                   '32')),
                                    'key', '32'),
                             Expand(Extract(<'g'^~x, ~resp_nonce>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x00', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'psk_id_hash', 
                                                                    'blank'>), 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'message_bhttp_request', 
                                                                    '0x00', ~key_id, $kem_id, 
                                                                    $kdf_id, $aead_id>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'
                                                   >,
                                                   '32')),
                                    'nonce', '32'),
                             'blank', ~resp)
                   ) @ #vk.20 )
              case T_HandleQuery___VARIANT_11
              solve( !KU( seal(Expand(Extract(<'g'^~x, ~resp_nonce>,
                                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'),
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'psk_id_hash', 
                                                                      'blank'>), 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'message_bhttp_request', 
                                                                      '0x00', ~key_id, $kem_id, 
                                                                      $kdf_id, $aead_id>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 
                                                      'message_bhttp_response'>,
                                                     '32')),
                                      'key', '32'),
                               Expand(Extract(<'g'^~x, ~resp_nonce>,
                                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'),
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'psk_id_hash', 
                                                                      'blank'>), 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'message_bhttp_request', 
                                                                      '0x00', ~key_id, $kem_id, 
                                                                      $kdf_id, $aead_id>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 
                                                      'message_bhttp_response'>,
                                                     '32')),
                                      'nonce', '32'),
                               a2.1, p2)
                     ) @ #vk.21 )
                case T_HandleQuery___VARIANT_11
                by contradiction /* from formulas */
              next
                case c_seal
                solve( !KU( Expand(Extract(<'g'^~x, ~resp_nonce>,
                                           Expand(Expand(Extract(Expand(Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'eae_prk', 
                                                                                 'g'^(~x*~y)>),
                                                                        <'32', 'HPKE_v1', 
                                                                         'shared_secret', 'g'^~x, 
                                                                         'g'^~y>,
                                                                        '32'),
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x00', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'psk_id_hash', 'blank'
                                                                  >), 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 
                                                                   'message_bhttp_request', '0x00', 
                                                                   ~key_id, $kem_id, $kdf_id, 
                                                                   $aead_id>)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'
                                                  >,
                                                  '32')),
                                   'nonce', '32')
                       ) @ #vk.23 )
                  case c_Expand
                  solve( !KU( Extract(<'g'^~x, ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~y)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 'g'^~y
                                                                   >,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32'))
                         ) @ #vk.26 )
                    case c_Extract
                    solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                     <'HPKE_v1', 'eae_prk', 
                                                                      'g'^(~x*~y)>),
                                                             <'32', 'HPKE_v1', 'shared_secret', 
                                                              'g'^~x, 'g'^~y>,
                                                             '32'),
                                                      <'HPKE_v1', 'secret', 'blank'>),
                                              <'32', 'HPKE_v1', 'exp', '0x00', 
                                               Extract('blank',
                                                       <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                               Extract('blank',
                                                       <'HPKE_v1', 'info_hash', 
                                                        'message_bhttp_request', '0x00', ~key_id, 
                                                        $kem_id, $kdf_id, $aead_id>)
                                              >,
                                              '32'),
                                       <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                           ) @ #vk.30 )
                      case c_Expand
                      solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                                <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)
                                                                >),
                                                        <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                         'g'^~y>,
                                                        '32'),
                                                 <'HPKE_v1', 'secret', 'blank'>),
                                         <'32', 'HPKE_v1', 'exp', '0x00', 
                                          Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                          Extract('blank',
                                                  <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                   '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                         >,
                                         '32')
                             ) @ #vk.33 )
                        case c_Expand
                        solve( !KU( Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y
                                                   >,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>)
                               ) @ #vk.41 )
                          case c_Extract
                          solve( !KU( Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>),
                                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~y>,
                                             '32')
                                 ) @ #vk.50 )
                            case c_Expand
                            solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>)
                                   ) @ #vk.57 )
                              case c_Extract
                              solve( !KU( 'g'^(~x*~y) ) @ #vk.64 )
                                case Generate_DH_key_pair
                                by solve( !KU( ~x ) @ #vk.65 )
                              next
                                case P_HandleQuery
                                by solve( !KU( ~y ) @ #vk.65 )
                              next
                                case c_exp
                                by solve( !KU( ~x ) @ #vk.67 )
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            next
              case c_seal
              by contradiction /* cyclic */
            qed
          next
            case T_HandleQuery___VARIANT_11
            solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~y)>)
                   ) @ #vk.58 )
              case c_Extract
              solve( !KU( ~resp_nonce ) @ #vk.45 )
                case T_HandleQuery___VARIANT_11
                solve( !KU( 'g'^(~x*~y) ) @ #vk.64 )
                  case Generate_DH_key_pair
                  by solve( !KU( ~x ) @ #vk.65 )
                next
                  case P_HandleQuery
                  by solve( !KU( ~y ) @ #vk.65 )
                next
                  case c_exp
                  by solve( !KU( ~x ) @ #vk.67 )
                qed
              qed
            qed
          qed
        qed
      next
        case P_HandleResponse
        by contradiction /* cyclic */
      next
        case c_senc
        by contradiction /* cyclic */
      qed
    next
      case c_seal
      solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                        <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32'),
                                 <'HPKE_v1', 'secret', 'blank'>),
                         <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                          Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                          Extract('blank',
                                  <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                   ~key_id, $kem_id, $kdf_id, $aead_id>)
                         >,
                         '32')
             ) @ #vk.17 )
        case c_Expand
        solve( !KU( Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                   <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32'),
                            <'HPKE_v1', 'secret', 'blank'>)
               ) @ #vk.23 )
          case c_Extract
          solve( !KU( Expand(Extract('blank',
                                     <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                             <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>, '32')
                 ) @ #vk.34 )
            case c_Expand
            solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', x^(~y*x.1)>)
                   ) @ #vk.41 )
              case c_Extract
              solve( !KU( seal(key, n, a2, ~resp) ) @ #vk.9 )
                case T_HandleQuery___VARIANT_11
                by contradiction /* from formulas */
              next
                case c_seal
                solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                          <'HPKE_v1', 'eae_prk', x^(~y*x.1)>),
                                                  <'32', 'HPKE_v1', 'shared_secret', x^x.1, 'g'^~y>,
                                                  '32'),
                                           <'HPKE_v1', 'secret', 'blank'>),
                                   <'32', 'HPKE_v1', 'key', '0x00', 
                                    Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                    Extract('blank',
                                            <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                             '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                   >,
                                   '32')
                       ) @ #vk.24 )
                  case c_Expand
                  solve( !KU( ~resp ) @ #vk.55 )
                    case NonceReuse
                    by contradiction /* from formulas */
                  next
                    case T_HandleQuery___VARIANT_11
                    by contradiction /* from formulas */
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_12
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( seal(key, n, a2, ~resp) ) @ #vk.1 )
      case T_HandleQuery___VARIANT_12
      solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                             <'32', 'HPKE_v1', 'shared_secret', 
                                              x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'key', '0x00', 
                               Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                               Extract('blank',
                                       <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                        ~key_id, $kem_id, $kdf_id, $aead_id>)
                              >,
                              '32'),
                       Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                             <'32', 'HPKE_v1', 'shared_secret', 
                                              x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                               Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                               Extract('blank',
                                       <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                        ~key_id, $kem_id, $kdf_id, $aead_id>)
                              >,
                              '32'),
                       <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                        $aead_id>,
                       query)
             ) @ #vk.14 )
        case c_seal
        by contradiction /* from formulas */
      qed
    next
      case c_seal
      solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                             <'32', 'HPKE_v1', 'shared_secret', 
                                              x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'key', '0x00', 
                               Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                               Extract('blank',
                                       <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                        ~key_id, $kem_id, $kdf_id, $aead_id>)
                              >,
                              '32'),
                       Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', x^(x.1*inv(x.2))>),
                                             <'32', 'HPKE_v1', 'shared_secret', 
                                              x^(x.1*inv((~y*x.2))), 'g'^~y>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                               Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                               Extract('blank',
                                       <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                        ~key_id, $kem_id, $kdf_id, $aead_id>)
                              >,
                              '32'),
                       <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                        $aead_id>,
                       query)
             ) @ #vk.14 )
        case c_seal
        solve( !KU( ~resp ) @ #vk.19 )
          case NonceReuse
          by contradiction /* from formulas */
        next
          case T_HandleQuery___VARIANT_12
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_2
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( seal(key, n, a2, ~resp) ) @ #vk.1 )
      case T_HandleQuery___VARIANT_2
      solve( !KU( seal(Expand(Extract(<gx, ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            gx^~y>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', gx, 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'key', '32'),
                       Expand(Extract(<gx, ~resp_nonce>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            gx^~y>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', gx, 'g'^~y>,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x00', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 
                                                              'message_bhttp_request', '0x00', 
                                                              ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                             '32')),
                              'nonce', '32'),
                       a1, a)
             ) @ #vk.1 )
        case T_HandleQuery___VARIANT_2
        by contradiction /* from formulas */
      next
        case c_seal
        solve( !KU( Expand(Extract(<gx, ~resp_nonce>,
                                   Expand(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', gx^~y
                                                                        >),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 gx, 'g'^~y>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x00', 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                  Extract('blank',
                                                          <'HPKE_v1', 'info_hash', 
                                                           'message_bhttp_request', '0x00', 
                                                           ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                 >,
                                                 '32'),
                                          <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>,
                                          '32')),
                           'nonce', '32')
               ) @ #vk.16 )
          case c_Expand
          solve( !KU( Extract(<gx, ~resp_nonce>,
                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', gx^~y>),
                                                           <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                            'g'^~y>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x00', 
                                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                             Extract('blank',
                                                     <'HPKE_v1', 'info_hash', 
                                                      'message_bhttp_request', '0x00', ~key_id, 
                                                      $kem_id, $kdf_id, $aead_id>)
                                            >,
                                            '32'),
                                     <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32'))
                 ) @ #vk.19 )
            case c_Extract
            solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                             <'HPKE_v1', 'eae_prk', gx^~y>),
                                                     <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                                     '32'),
                                              <'HPKE_v1', 'secret', 'blank'>),
                                      <'32', 'HPKE_v1', 'exp', '0x00', 
                                       Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                       Extract('blank',
                                               <'HPKE_v1', 'info_hash', 'message_bhttp_request', 
                                                '0x00', ~key_id, $kem_id, $kdf_id, $aead_id>)
                                      >,
                                      '32'),
                               <'32', 'HPKE_v1', 'sec', 'message_bhttp_response'>, '32')
                   ) @ #vk.23 )
              case c_Expand
              solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                        <'HPKE_v1', 'eae_prk', gx^~y>),
                                                <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                                '32'),
                                         <'HPKE_v1', 'secret', 'blank'>),
                                 <'32', 'HPKE_v1', 'exp', '0x00', 
                                  Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                  Extract('blank',
                                          <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                           ~key_id, $kem_id, $kdf_id, $aead_id>)
                                 >,
                                 '32')
                     ) @ #vk.26 )
                case c_Expand
                solve( !KU( Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', gx^~y>),
                                           <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                    <'HPKE_v1', 'secret', 'blank'>)
                       ) @ #vk.34 )
                  case c_Extract
                  solve( !KU( Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>),
                                     <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32')
                         ) @ #vk.43 )
                    case c_Expand
                    solve( !KU( ~resp_nonce ) @ #vk.31 )
                      case T_HandleQuery___VARIANT_2
                      solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>)
                             ) @ #vk.51 )
                        case c_Extract
                        solve( !KU( gx^~y ) @ #vk.57 )
                          case Generate_DH_key_pair
                          solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^~y>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g', 'g'^~y>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'key', '0x00', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 
                                                            'message_bhttp_request', '0x00', 
                                                            ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                  >,
                                                  '32'),
                                           Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^~y>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g', 'g'^~y>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 
                                                            'message_bhttp_request', '0x00', 
                                                            ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                  >,
                                                  '32'),
                                           <'message_bhttp_request', '0x00', ~key_id, $kem_id, 
                                            $kdf_id, $aead_id>,
                                           query)
                                 ) @ #vk.28 )
                            case c_seal
                            by contradiction /* from formulas */
                          qed
                        next
                          case c_exp
                          solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          gx^~y>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  gx, 'g'^~y>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'key', '0x00', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 
                                                            'message_bhttp_request', '0x00', 
                                                            ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                  >,
                                                  '32'),
                                           Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          gx^~y>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  gx, 'g'^~y>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 
                                                            'message_bhttp_request', '0x00', 
                                                            ~key_id, $kem_id, $kdf_id, $aead_id>)
                                                  >,
                                                  '32'),
                                           <'message_bhttp_request', '0x00', ~key_id, $kem_id, 
                                            $kdf_id, $aead_id>,
                                           query)
                                 ) @ #vk.28 )
                            case c_seal
                            by contradiction /* from formulas */
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    next
      case c_seal
      solve( !KU( ~resp ) @ #vk.18 )
        case NonceReuse
        solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', gx^~y>),
                                               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'key', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', gx^~y>),
                                               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                          $aead_id>,
                         query)
               ) @ #vk.15 )
          case c_seal
          by contradiction /* from formulas */
        qed
      next
        case T_HandleQuery___VARIANT_2
        solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', gx^~y>),
                                               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'key', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', gx^~y>),
                                               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                                 Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                                 Extract('blank',
                                         <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                          ~key_id, $kem_id, $kdf_id, $aead_id>)
                                >,
                                '32'),
                         <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                          $aead_id>,
                         query)
               ) @ #vk.25 )
          case c_seal
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_4
  solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', z>),
                                         <'32', 'HPKE_v1', 'shared_secret', z^inv(~y), 'g'^~y>,
                                         '32'),
                                  <'HPKE_v1', 'secret', 'blank'>),
                          <'32', 'HPKE_v1', 'key', '0x00', 
                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                           Extract('blank',
                                   <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                    ~key_id, kem_id, kdf_id, aead_id>)
                          >,
                          '32'),
                   Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                         <'32', 'HPKE_v1', 'shared_secret', z^inv(~y), 'g'^~y>,
                                         '32'),
                                  <'HPKE_v1', 'secret', 'blank'>),
                          <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                           Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                           Extract('blank',
                                   <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                    ~key_id, kem_id, kdf_id, aead_id>)
                          >,
                          '32'),
                   <'message_bhttp_request', '0x00', ~key_id, kem_id, kdf_id, aead_id
                   >,
                   query)
         ) @ #vk.14 )
    case c_seal
    solve( !KU( Expand(Extract(Expand(Extract('blank',
                                              <'HPKE_v1', 'eae_prk', z>),
                                      <'32', 'HPKE_v1', 'shared_secret', z^inv(~y), 'g'^~y>, '32'),
                               <'HPKE_v1', 'secret', 'blank'>),
                       <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                        Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                        Extract('blank',
                                <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', ~key_id, 
                                 kem_id, kdf_id, aead_id>)
                       >,
                       '32')
           ) @ #vk.17 )
      case c_Expand
      solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
        case Generate_DH_key_pair
        solve( !KU( seal(key, n, a2, ~resp) ) @ #vk.5 )
          case T_HandleQuery___VARIANT_4
          by contradiction /* from formulas */
        next
          case c_seal
          solve( !KU( ~resp ) @ #vk.36 )
            case NonceReuse
            by contradiction /* from formulas */
          next
            case T_HandleQuery___VARIANT_4
            by contradiction /* from formulas */
          qed
        qed
      qed
    qed
  qed
next
  case T_HandleQuery___VARIANT_9
  solve( !Ltk( $T, <~key_id, kem_id, kdf_id, aead_id>, ~y ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( seal(Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^x.1>),
                                           <'32', 'HPKE_v1', 'shared_secret', x^(x.1*inv(~y)), 
                                            'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'key', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     Expand(Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', x^x.1>),
                                           <'32', 'HPKE_v1', 'shared_secret', x^(x.1*inv(~y)), 
                                            'g'^~y>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x00', 
                             Extract('blank', <'HPKE_v1', 'psk_id_hash', 'blank'>), 
                             Extract('blank',
                                     <'HPKE_v1', 'info_hash', 'message_bhttp_request', '0x00', 
                                      ~key_id, $kem_id, $kdf_id, $aead_id>)
                            >,
                            '32'),
                     <'message_bhttp_request', '0x00', ~key_id, $kem_id, $kdf_id, 
                      $aead_id>,
                     query)
           ) @ #vk.14 )
      case c_seal
      solve( !KU( seal(key, n, a2, ~resp) ) @ #vk.2 )
        case T_HandleQuery___VARIANT_9
        by contradiction /* from formulas */
      next
        case c_seal
        solve( !KU( ~resp ) @ #vk.25 )
          case NonceReuse
          by contradiction /* from formulas */
        next
          case T_HandleQuery___VARIANT_9
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
qed

/* All well-formedness checks were successful. */

lemma AUTO_typing [sources]:
  all-traces
  "(((⊤) ∧
     (∀ x m #i.
       (AUTO_IN_TERM_1_0_0_1_1_0__P_HandleQuery( m, x ) @ #i) ⇒
       ((∃ #j. (!KU( x ) @ #j) ∧ (#j < #i)) ∨
        (∃ #j.
          (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( m ) @ #j) ∧
          (#j < #i))))) ∧
    (∀ x m #i.
      (AUTO_IN_TERM_1_0_0_1_1_1__P_HandleQuery( m, x ) @ #i) ⇒
      ((∃ #j. (!KU( x ) @ #j) ∧ (#j < #i)) ∨
       (∃ #j.
         (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( m ) @ #j) ∧
         (#j < #i))))) ∧
   (∀ x m #i.
     (AUTO_IN_TERM_0_0_3__NonceReuse( m, x ) @ #i) ⇒
     ((∃ #j. (!KU( x ) @ #j) ∧ (#j < #i)) ∨
      (∃ #j. (AUTO_OUT_TERM_0_0_3__NonceReuse( m ) @ #j) ∧ (#j < #i))))"
/*
guarded formula characterizing all counter-examples:
"((∃ x m #i.
    (AUTO_IN_TERM_1_0_0_1_1_0__P_HandleQuery( m, x ) @ #i)
   ∧
    (∀ #j. (!KU( x ) @ #j) ⇒ ¬(#j < #i)) ∧
    (∀ #j.
      (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( m ) @ #j)
     ⇒
      ¬(#j < #i))) ∨
  (∃ x m #i.
    (AUTO_IN_TERM_1_0_0_1_1_1__P_HandleQuery( m, x ) @ #i)
   ∧
    (∀ #j. (!KU( x ) @ #j) ⇒ ¬(#j < #i)) ∧
    (∀ #j.
      (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( m ) @ #j)
     ⇒
      ¬(#j < #i))) ∨
  (∃ x m #i.
    (AUTO_IN_TERM_0_0_3__NonceReuse( m, x ) @ #i)
   ∧
    (∀ #j. (!KU( x ) @ #j) ⇒ ¬(#j < #i)) ∧
    (∀ #j. (AUTO_OUT_TERM_0_0_3__NonceReuse( m ) @ #j) ⇒ ¬(#j < #i))))"
*/
induction
  case empty_trace
  by contradiction /* from formulas */
next
  case non_empty_trace
  simplify
  solve( (∃ x m #i.
           (AUTO_IN_TERM_1_0_0_1_1_0__P_HandleQuery( m, x ) @ #i)
          ∧
           (∀ #j. (!KU( x ) @ #j) ⇒ ¬(#j < #i)) ∧
           (∀ #j.
             (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( m ) @ #j)
            ⇒
             ¬(#j < #i)))  ∥
         (∃ x m #i.
           (AUTO_IN_TERM_1_0_0_1_1_1__P_HandleQuery( m, x ) @ #i)
          ∧
           (∀ #j. (!KU( x ) @ #j) ⇒ ¬(#j < #i)) ∧
           (∀ #j.
             (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( m ) @ #j)
            ⇒
             ¬(#j < #i)))  ∥
         (∃ x m #i.
           (AUTO_IN_TERM_0_0_3__NonceReuse( m, x ) @ #i)
          ∧
           (∀ #j. (!KU( x ) @ #j) ⇒ ¬(#j < #i)) ∧
           (∀ #j. (AUTO_OUT_TERM_0_0_3__NonceReuse( m ) @ #j) ⇒ ¬(#j < #i))) )
    case case_1
    solve( (last(#i))  ∥
           (∃ #j. (!KU( x ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #i))  ∥
           (∃ #j.
             (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid, 
                                                              <key_id, kem_id, kdf_id, aead_id>, x, 
                                                              opaque>,
                                                             ~k)
              ) @ #j)
            ∧
             (¬(last(#j))) ∧ (#j < #i)) )
      case case_1
      solve( KeyExS( $C, $P, ~k ) ▶₀ #i )
        case Starter
        solve( !Pk( $T, <key_id, kem_id, kdf_id, aead_id>, gy ) ▶₂ #i )
          case Generate_DH_key_pair
          solve( !KU( senc(<cid, <~key_id, $kem_id, $kdf_id, $aead_id>, x, 
                            opaque>,
                           ~k)
                 ) @ #vk )
            case C_QueryGeneration___VARIANT_3
            by contradiction /* from formulas */
          next
            case NonceReuse
            solve( (∃ #j. (!KU( t ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                   (∃ #j.
                     (AUTO_OUT_TERM_0_0_3__NonceReuse( seal(k.1, n, a1, t) ) @ #j)
                    ∧
                     (¬(last(#j))) ∧ (#j < #vr.2)) )
              case case_1
              by contradiction /* cyclic */
            next
              case case_2
              solve( AUTO_OUT_TERM_0_0_3__NonceReuse( seal(k.1, n, a1, t)
                     ) @ #j )
                case C_QueryGeneration___VARIANT_1
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_2
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_3
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_4
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_5
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_6
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_10
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_11
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_12
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_2
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_4
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_9
                by contradiction /* impossible chain */
              qed
            qed
          next
            case P_HandleQuery_case_1
            solve( (∃ #j. (!KU( gx ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                   (∃ #j.
                     (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                      <~key_id.1, $kem_id.1, 
                                                                       $kdf_id.1, $aead_id.1>, 
                                                                      gx, opaque.1>,
                                                                     ~k.1)
                      ) @ #j)
                    ∧
                     (¬(last(#j))) ∧ (#j < #vr.2)) )
              case case_1
              by contradiction /* cyclic */
            next
              case case_2
              solve( (∃ #j.
                       (!KU( opaque.1 ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                     (∃ #j.
                       (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                        <~key_id.1, $kem_id.1, 
                                                                         $kdf_id.1, $aead_id.1>, 
                                                                        gx, opaque.1>,
                                                                       ~k.1)
                        ) @ #j)
                      ∧
                       (¬(last(#j))) ∧ (#j < #vr.2)) )
                case case_1
                solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                       <~key_id.1, $kem_id.1, 
                                                                        $kdf_id.1, $aead_id.1>, 
                                                                       gx, opaque.1>,
                                                                      ~k.1)
                       ) @ #j )
                  case C_QueryGeneration___VARIANT_1
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_2
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_3
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_4
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_5
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_6
                  by contradiction /* impossible chain */
                next
                  case P_HandleResponse
                  by contradiction /* cyclic */
                qed
              next
                case case_2
                solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                       <~key_id.1, $kem_id.1, 
                                                                        $kdf_id.1, $aead_id.1>, 
                                                                       gx, opaque.1>,
                                                                      ~k.1)
                       ) @ #j )
                  case C_QueryGeneration___VARIANT_1
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_2
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_3
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_4
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_5
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_6
                  by contradiction /* impossible chain */
                next
                  case P_HandleResponse
                  by contradiction /* cyclic */
                qed
              qed
            qed
          next
            case P_HandleQuery_case_2
            solve( (∃ #j. (!KU( gx ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                   (∃ #j.
                     (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                      <~key_id.1, $kem_id.1, 
                                                                       $kdf_id.1, $aead_id.1>, 
                                                                      gx, opaque.1>,
                                                                     ~k.1)
                      ) @ #j)
                    ∧
                     (¬(last(#j))) ∧ (#j < #vr.2)) )
              case case_1
              solve( (∃ #j.
                       (!KU( opaque.1 ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                     (∃ #j.
                       (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                        <~key_id.1, $kem_id.1, 
                                                                         $kdf_id.1, $aead_id.1>, 
                                                                        gx, opaque.1>,
                                                                       ~k.1)
                        ) @ #j)
                      ∧
                       (¬(last(#j))) ∧ (#j < #vr.2)) )
                case case_1
                by contradiction /* cyclic */
              next
                case case_2
                solve( AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                       <~key_id.1, $kem_id.1, 
                                                                        $kdf_id.1, $aead_id.1>, 
                                                                       gx, opaque.1>,
                                                                      ~k.1)
                       ) @ #j.1 )
                  case C_QueryGeneration___VARIANT_1
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_2
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_3
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_4
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_5
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_6
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case P_HandleResponse
                  by contradiction /* cyclic */
                qed
              qed
            next
              case case_2
              solve( (∃ #j.
                       (!KU( opaque.1 ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                     (∃ #j.
                       (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                        <~key_id.1, $kem_id.1, 
                                                                         $kdf_id.1, $aead_id.1>, 
                                                                        gx, opaque.1>,
                                                                       ~k.1)
                        ) @ #j)
                      ∧
                       (¬(last(#j))) ∧ (#j < #vr.2)) )
                case case_1
                by contradiction /* cyclic */
              next
                case case_2
                solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                       <~key_id.1, $kem_id.1, 
                                                                        $kdf_id.1, $aead_id.1>, 
                                                                       gx, opaque.1>,
                                                                      ~k.1)
                       ) @ #j )
                  case C_QueryGeneration___VARIANT_1
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_2
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_3
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_4
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_5
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_6
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case P_HandleResponse
                  by contradiction /* cyclic */
                qed
              qed
            qed
          next
            case P_HandleResponse
            by contradiction /* cyclic */
          next
            case c_senc
            by contradiction /* from formulas */
          qed
        qed
      qed
    next
      case case_2
      by contradiction /* from formulas */
    next
      case case_3
      by contradiction /* from formulas */
    qed
  next
    case case_2
    solve( (last(#i))  ∥
           (∃ #j. (!KU( gx ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #i))  ∥
           (∃ #j.
             (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid, 
                                                              <key_id, kem_id, kdf_id, aead_id>, 
                                                              gx, x>,
                                                             ~k)
              ) @ #j)
            ∧
             (¬(last(#j))) ∧ (#j < #i)) )
      case case_1
      solve( KeyExS( $C, $P, ~k ) ▶₀ #i )
        case Starter
        solve( !Pk( $T, <key_id, kem_id, kdf_id, aead_id>, gy ) ▶₂ #i )
          case Generate_DH_key_pair
          solve( !KU( senc(<cid, <~key_id, $kem_id, $kdf_id, $aead_id>, gx, x
                           >,
                           ~k)
                 ) @ #vk )
            case C_QueryGeneration___VARIANT_3
            by contradiction /* from formulas */
          next
            case NonceReuse
            solve( (∃ #j. (!KU( t ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                   (∃ #j.
                     (AUTO_OUT_TERM_0_0_3__NonceReuse( seal(k.1, n, a1, t) ) @ #j)
                    ∧
                     (¬(last(#j))) ∧ (#j < #vr.2)) )
              case case_1
              by contradiction /* cyclic */
            next
              case case_2
              solve( AUTO_OUT_TERM_0_0_3__NonceReuse( seal(k.1, n, a1, t)
                     ) @ #j )
                case C_QueryGeneration___VARIANT_1
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_2
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_3
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_4
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_5
                by contradiction /* impossible chain */
              next
                case C_QueryGeneration___VARIANT_6
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_10
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_11
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_12
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_2
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_4
                by contradiction /* impossible chain */
              next
                case T_HandleQuery___VARIANT_9
                by contradiction /* impossible chain */
              qed
            qed
          next
            case P_HandleQuery_case_1
            solve( (∃ #j. (!KU( gx.1 ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                   (∃ #j.
                     (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                      <~key_id.1, $kem_id.1, 
                                                                       $kdf_id.1, $aead_id.1>, 
                                                                      gx.1, opaque>,
                                                                     ~k.1)
                      ) @ #j)
                    ∧
                     (¬(last(#j))) ∧ (#j < #vr.2)) )
              case case_1
              by contradiction /* cyclic */
            next
              case case_2
              solve( (∃ #j.
                       (!KU( opaque ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                     (∃ #j.
                       (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                        <~key_id.1, $kem_id.1, 
                                                                         $kdf_id.1, $aead_id.1>, 
                                                                        gx.1, opaque>,
                                                                       ~k.1)
                        ) @ #j)
                      ∧
                       (¬(last(#j))) ∧ (#j < #vr.2)) )
                case case_1
                solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                       <~key_id.1, $kem_id.1, 
                                                                        $kdf_id.1, $aead_id.1>, 
                                                                       gx.1, opaque>,
                                                                      ~k.1)
                       ) @ #j )
                  case C_QueryGeneration___VARIANT_1
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_2
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_3
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_4
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_5
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_6
                  by contradiction /* impossible chain */
                next
                  case P_HandleResponse
                  by contradiction /* cyclic */
                qed
              next
                case case_2
                solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                       <~key_id.1, $kem_id.1, 
                                                                        $kdf_id.1, $aead_id.1>, 
                                                                       gx.1, opaque>,
                                                                      ~k.1)
                       ) @ #j )
                  case C_QueryGeneration___VARIANT_1
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_2
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_3
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_4
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_5
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_6
                  by contradiction /* impossible chain */
                next
                  case P_HandleResponse
                  by contradiction /* cyclic */
                qed
              qed
            qed
          next
            case P_HandleQuery_case_2
            solve( (∃ #j. (!KU( gx.1 ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                   (∃ #j.
                     (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                      <~key_id.1, $kem_id.1, 
                                                                       $kdf_id.1, $aead_id.1>, 
                                                                      gx.1, opaque>,
                                                                     ~k.1)
                      ) @ #j)
                    ∧
                     (¬(last(#j))) ∧ (#j < #vr.2)) )
              case case_1
              solve( (∃ #j.
                       (!KU( opaque ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                     (∃ #j.
                       (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                        <~key_id.1, $kem_id.1, 
                                                                         $kdf_id.1, $aead_id.1>, 
                                                                        gx.1, opaque>,
                                                                       ~k.1)
                        ) @ #j)
                      ∧
                       (¬(last(#j))) ∧ (#j < #vr.2)) )
                case case_1
                by contradiction /* cyclic */
              next
                case case_2
                solve( AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                       <~key_id.1, $kem_id.1, 
                                                                        $kdf_id.1, $aead_id.1>, 
                                                                       gx.1, opaque>,
                                                                      ~k.1)
                       ) @ #j.1 )
                  case C_QueryGeneration___VARIANT_1
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_2
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_3
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_4
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_5
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_6
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case P_HandleResponse
                  by contradiction /* cyclic */
                qed
              qed
            next
              case case_2
              solve( (∃ #j.
                       (!KU( opaque ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                     (∃ #j.
                       (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                        <~key_id.1, $kem_id.1, 
                                                                         $kdf_id.1, $aead_id.1>, 
                                                                        gx.1, opaque>,
                                                                       ~k.1)
                        ) @ #j)
                      ∧
                       (¬(last(#j))) ∧ (#j < #vr.2)) )
                case case_1
                by contradiction /* cyclic */
              next
                case case_2
                solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                       <~key_id.1, $kem_id.1, 
                                                                        $kdf_id.1, $aead_id.1>, 
                                                                       gx.1, opaque>,
                                                                      ~k.1)
                       ) @ #j )
                  case C_QueryGeneration___VARIANT_1
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_2
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_3
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_4
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_5
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case C_QueryGeneration___VARIANT_6
                  solve( (#vr.5, 0) ~~> (#vk, 0) )
                    case d_3_open
                    by contradiction /* impossible chain */
                  qed
                next
                  case P_HandleResponse
                  by contradiction /* cyclic */
                qed
              qed
            qed
          next
            case P_HandleResponse
            by contradiction /* cyclic */
          next
            case c_senc
            by contradiction /* from formulas */
          qed
        qed
      qed
    next
      case case_2
      solve( (last(#i))  ∥
             (∃ #j. (!KU( x ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #i))  ∥
             (∃ #j.
               (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid, 
                                                                <key_id, kem_id, kdf_id, aead_id>, 
                                                                gx, x>,
                                                               ~k)
                ) @ #j)
              ∧
               (¬(last(#j))) ∧ (#j < #i)) )
        case case_1
        solve( KeyExS( $C, $P, ~k ) ▶₀ #i )
          case Starter
          solve( !Pk( $T, <key_id, kem_id, kdf_id, aead_id>, gy ) ▶₂ #i )
            case Generate_DH_key_pair
            solve( !KU( senc(<cid, <~key_id, $kem_id, $kdf_id, $aead_id>, gx, x
                             >,
                             ~k)
                   ) @ #vk )
              case C_QueryGeneration___VARIANT_3
              by contradiction /* from formulas */
            next
              case NonceReuse
              solve( (∃ #j. (!KU( t ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                     (∃ #j.
                       (AUTO_OUT_TERM_0_0_3__NonceReuse( seal(k.1, n, a1, t) ) @ #j)
                      ∧
                       (¬(last(#j))) ∧ (#j < #vr.2)) )
                case case_1
                by contradiction /* cyclic */
              next
                case case_2
                solve( AUTO_OUT_TERM_0_0_3__NonceReuse( seal(k.1, n, a1, t)
                       ) @ #j.1 )
                  case C_QueryGeneration___VARIANT_1
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_2
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_3
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_4
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_5
                  by contradiction /* impossible chain */
                next
                  case C_QueryGeneration___VARIANT_6
                  by contradiction /* impossible chain */
                next
                  case T_HandleQuery___VARIANT_10
                  by contradiction /* impossible chain */
                next
                  case T_HandleQuery___VARIANT_11
                  by contradiction /* impossible chain */
                next
                  case T_HandleQuery___VARIANT_12
                  by contradiction /* impossible chain */
                next
                  case T_HandleQuery___VARIANT_2
                  by contradiction /* impossible chain */
                next
                  case T_HandleQuery___VARIANT_4
                  by contradiction /* impossible chain */
                next
                  case T_HandleQuery___VARIANT_9
                  by contradiction /* impossible chain */
                qed
              qed
            next
              case P_HandleQuery_case_1
              solve( (∃ #j. (!KU( gx.1 ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                     (∃ #j.
                       (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                        <~key_id.1, $kem_id.1, 
                                                                         $kdf_id.1, $aead_id.1>, 
                                                                        gx.1, opaque>,
                                                                       ~k.1)
                        ) @ #j)
                      ∧
                       (¬(last(#j))) ∧ (#j < #vr.2)) )
                case case_1
                by contradiction /* cyclic */
              next
                case case_2
                solve( (∃ #j.
                         (!KU( opaque ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                       (∃ #j.
                         (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                          <~key_id.1, $kem_id.1, 
                                                                           $kdf_id.1, $aead_id.1>, 
                                                                          gx.1, opaque>,
                                                                         ~k.1)
                          ) @ #j)
                        ∧
                         (¬(last(#j))) ∧ (#j < #vr.2)) )
                  case case_1
                  solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                         <~key_id.1, $kem_id.1, 
                                                                          $kdf_id.1, $aead_id.1>, 
                                                                         gx.1, opaque>,
                                                                        ~k.1)
                         ) @ #j.1 )
                    case C_QueryGeneration___VARIANT_1
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_2
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_3
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_4
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_5
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_6
                    by contradiction /* impossible chain */
                  next
                    case P_HandleResponse
                    by contradiction /* cyclic */
                  qed
                next
                  case case_2
                  solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                         <~key_id.1, $kem_id.1, 
                                                                          $kdf_id.1, $aead_id.1>, 
                                                                         gx.1, opaque>,
                                                                        ~k.1)
                         ) @ #j.1 )
                    case C_QueryGeneration___VARIANT_1
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_2
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_3
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_4
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_5
                    by contradiction /* impossible chain */
                  next
                    case C_QueryGeneration___VARIANT_6
                    by contradiction /* impossible chain */
                  next
                    case P_HandleResponse
                    by contradiction /* cyclic */
                  qed
                qed
              qed
            next
              case P_HandleQuery_case_2
              solve( (∃ #j. (!KU( gx.1 ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                     (∃ #j.
                       (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                        <~key_id.1, $kem_id.1, 
                                                                         $kdf_id.1, $aead_id.1>, 
                                                                        gx.1, opaque>,
                                                                       ~k.1)
                        ) @ #j)
                      ∧
                       (¬(last(#j))) ∧ (#j < #vr.2)) )
                case case_1
                solve( (∃ #j.
                         (!KU( opaque ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                       (∃ #j.
                         (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                          <~key_id.1, $kem_id.1, 
                                                                           $kdf_id.1, $aead_id.1>, 
                                                                          gx.1, opaque>,
                                                                         ~k.1)
                          ) @ #j)
                        ∧
                         (¬(last(#j))) ∧ (#j < #vr.2)) )
                  case case_1
                  by contradiction /* cyclic */
                next
                  case case_2
                  solve( AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                         <~key_id.1, $kem_id.1, 
                                                                          $kdf_id.1, $aead_id.1>, 
                                                                         gx.1, opaque>,
                                                                        ~k.1)
                         ) @ #j.2 )
                    case C_QueryGeneration___VARIANT_1
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_2
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_3
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_4
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_5
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_6
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case P_HandleResponse
                    by contradiction /* cyclic */
                  qed
                qed
              next
                case case_2
                solve( (∃ #j.
                         (!KU( opaque ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr.2))  ∥
                       (∃ #j.
                         (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid.1, 
                                                                          <~key_id.1, $kem_id.1, 
                                                                           $kdf_id.1, $aead_id.1>, 
                                                                          gx.1, opaque>,
                                                                         ~k.1)
                          ) @ #j)
                        ∧
                         (¬(last(#j))) ∧ (#j < #vr.2)) )
                  case case_1
                  by contradiction /* cyclic */
                next
                  case case_2
                  solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid.1, 
                                                                         <~key_id.1, $kem_id.1, 
                                                                          $kdf_id.1, $aead_id.1>, 
                                                                         gx.1, opaque>,
                                                                        ~k.1)
                         ) @ #j.1 )
                    case C_QueryGeneration___VARIANT_1
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_2
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_3
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_4
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_5
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case C_QueryGeneration___VARIANT_6
                    solve( (#vr.5, 0) ~~> (#vk, 0) )
                      case d_3_open
                      by contradiction /* impossible chain */
                    qed
                  next
                    case P_HandleResponse
                    by contradiction /* cyclic */
                  qed
                qed
              qed
            next
              case P_HandleResponse
              by contradiction /* cyclic */
            next
              case c_senc
              by contradiction /* from formulas */
            qed
          qed
        qed
      next
        case case_2
        by contradiction /* from formulas */
      next
        case case_3
        by contradiction /* from formulas */
      qed
    next
      case case_3
      solve( (last(#i))  ∥
             (∃ #j. (!KU( x ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #i))  ∥
             (∃ #j.
               (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid, 
                                                                <key_id, kem_id, kdf_id, aead_id>, 
                                                                gx, x>,
                                                               ~k)
                ) @ #j)
              ∧
               (¬(last(#j))) ∧ (#j < #i)) )
        case case_1
        solve( KeyExS( $C, $P, ~k ) ▶₀ #i )
          case Starter
          solve( !Pk( $T, <key_id, kem_id, kdf_id, aead_id>, gy ) ▶₂ #i )
            case Generate_DH_key_pair
            solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid, 
                                                                   <~key_id, $kem_id, $kdf_id, 
                                                                    $aead_id>, 
                                                                   gx, x>,
                                                                  ~k)
                   ) @ #j )
              case C_QueryGeneration___VARIANT_1
              by contradiction /* from formulas */
            next
              case C_QueryGeneration___VARIANT_2
              by contradiction /* from formulas */
            next
              case C_QueryGeneration___VARIANT_3
              by contradiction /* from formulas */
            next
              case C_QueryGeneration___VARIANT_4
              by contradiction /* from formulas */
            next
              case C_QueryGeneration___VARIANT_5
              by contradiction /* from formulas */
            next
              case C_QueryGeneration___VARIANT_6
              by contradiction /* from formulas */
            next
              case P_HandleResponse
              by contradiction /* from formulas */
            qed
          qed
        qed
      next
        case case_2
        by contradiction /* from formulas */
      next
        case case_3
        by contradiction /* from formulas */
      qed
    qed
  next
    case case_3
    solve( (last(#i))  ∥
           (∃ #j. (!KU( x ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #i))  ∥
           (∃ #j.
             (AUTO_OUT_TERM_0_0_3__NonceReuse( seal(k, n, a1, x) ) @ #j)
            ∧
             (¬(last(#j))) ∧ (#j < #i)) )
      case case_1
      solve( !KU( seal(k, n, a1, x) ) @ #vk )
        case C_QueryGeneration___VARIANT_3
        by contradiction /* from formulas */
      next
        case NonceReuse
        solve( (∃ #j. (!KU( t ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr))  ∥
               (∃ #j.
                 (AUTO_OUT_TERM_0_0_3__NonceReuse( seal(k.1, n.1, a1.1, t) ) @ #j)
                ∧
                 (¬(last(#j))) ∧ (#j < #vr)) )
          case case_1
          by contradiction /* cyclic */
        next
          case case_2
          solve( AUTO_OUT_TERM_0_0_3__NonceReuse( seal(k.1, n.1, a1.1, t)
                 ) @ #j )
            case C_QueryGeneration___VARIANT_1
            by contradiction /* impossible chain */
          next
            case C_QueryGeneration___VARIANT_2
            by contradiction /* impossible chain */
          next
            case C_QueryGeneration___VARIANT_3
            by contradiction /* impossible chain */
          next
            case C_QueryGeneration___VARIANT_4
            by contradiction /* impossible chain */
          next
            case C_QueryGeneration___VARIANT_5
            by contradiction /* impossible chain */
          next
            case C_QueryGeneration___VARIANT_6
            by contradiction /* impossible chain */
          next
            case T_HandleQuery___VARIANT_10
            by contradiction /* impossible chain */
          next
            case T_HandleQuery___VARIANT_11
            by contradiction /* impossible chain */
          next
            case T_HandleQuery___VARIANT_12
            by contradiction /* impossible chain */
          next
            case T_HandleQuery___VARIANT_2
            by contradiction /* impossible chain */
          next
            case T_HandleQuery___VARIANT_4
            by contradiction /* impossible chain */
          next
            case T_HandleQuery___VARIANT_9
            by contradiction /* impossible chain */
          qed
        qed
      next
        case P_HandleQuery_case_1
        solve( (∃ #j. (!KU( gx ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr))  ∥
               (∃ #j.
                 (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid, 
                                                                  <~key_id, $kem_id, $kdf_id, 
                                                                   $aead_id>, 
                                                                  gx, opaque>,
                                                                 ~k.1)
                  ) @ #j)
                ∧
                 (¬(last(#j))) ∧ (#j < #vr)) )
          case case_1
          by contradiction /* cyclic */
        next
          case case_2
          solve( (∃ #j. (!KU( opaque ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr))  ∥
                 (∃ #j.
                   (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid, 
                                                                    <~key_id, $kem_id, $kdf_id, 
                                                                     $aead_id>, 
                                                                    gx, opaque>,
                                                                   ~k.1)
                    ) @ #j)
                  ∧
                   (¬(last(#j))) ∧ (#j < #vr)) )
            case case_1
            solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid, 
                                                                   <~key_id, $kem_id, $kdf_id, 
                                                                    $aead_id>, 
                                                                   gx, opaque>,
                                                                  ~k.1)
                   ) @ #j )
              case C_QueryGeneration___VARIANT_1
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_2
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_3
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_4
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_5
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_6
              by contradiction /* impossible chain */
            next
              case P_HandleResponse
              by contradiction /* cyclic */
            qed
          next
            case case_2
            solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid, 
                                                                   <~key_id, $kem_id, $kdf_id, 
                                                                    $aead_id>, 
                                                                   gx, opaque>,
                                                                  ~k.1)
                   ) @ #j )
              case C_QueryGeneration___VARIANT_1
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_2
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_3
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_4
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_5
              by contradiction /* impossible chain */
            next
              case C_QueryGeneration___VARIANT_6
              by contradiction /* impossible chain */
            next
              case P_HandleResponse
              by contradiction /* cyclic */
            qed
          qed
        qed
      next
        case P_HandleQuery_case_2
        solve( (∃ #j. (!KU( gx ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr))  ∥
               (∃ #j.
                 (AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid, 
                                                                  <~key_id, $kem_id, $kdf_id, 
                                                                   $aead_id>, 
                                                                  gx, opaque>,
                                                                 ~k.1)
                  ) @ #j)
                ∧
                 (¬(last(#j))) ∧ (#j < #vr)) )
          case case_1
          solve( (∃ #j. (!KU( opaque ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr))  ∥
                 (∃ #j.
                   (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid, 
                                                                    <~key_id, $kem_id, $kdf_id, 
                                                                     $aead_id>, 
                                                                    gx, opaque>,
                                                                   ~k.1)
                    ) @ #j)
                  ∧
                   (¬(last(#j))) ∧ (#j < #vr)) )
            case case_1
            by contradiction /* cyclic */
          next
            case case_2
            solve( AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid, 
                                                                   <~key_id, $kem_id, $kdf_id, 
                                                                    $aead_id>, 
                                                                   gx, opaque>,
                                                                  ~k.1)
                   ) @ #j.1 )
              case C_QueryGeneration___VARIANT_1
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_2
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_3
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_4
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_5
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_6
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case P_HandleResponse
              by contradiction /* cyclic */
            qed
          qed
        next
          case case_2
          solve( (∃ #j. (!KU( opaque ) @ #j) ∧ (¬(last(#j))) ∧ (#j < #vr))  ∥
                 (∃ #j.
                   (AUTO_OUT_TERM_1_0_0_1_1_1__P_HandleQuery( senc(<cid, 
                                                                    <~key_id, $kem_id, $kdf_id, 
                                                                     $aead_id>, 
                                                                    gx, opaque>,
                                                                   ~k.1)
                    ) @ #j)
                  ∧
                   (¬(last(#j))) ∧ (#j < #vr)) )
            case case_1
            by contradiction /* cyclic */
          next
            case case_2
            solve( AUTO_OUT_TERM_1_0_0_1_1_0__P_HandleQuery( senc(<cid, 
                                                                   <~key_id, $kem_id, $kdf_id, 
                                                                    $aead_id>, 
                                                                   gx, opaque>,
                                                                  ~k.1)
                   ) @ #j )
              case C_QueryGeneration___VARIANT_1
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_2
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_3
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_4
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_5
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case C_QueryGeneration___VARIANT_6
              solve( (#vr.3, 0) ~~> (#vk, 0) )
                case d_3_open
                by contradiction /* impossible chain */
              next
                case seal
                by contradiction /* from formulas */
              qed
            next
              case P_HandleResponse
              by contradiction /* cyclic */
            qed
          qed
        qed
      next
        case T_HandleQuery___VARIANT_10
        by contradiction /* from formulas */
      next
        case T_HandleQuery___VARIANT_11
        by contradiction /* from formulas */
      next
        case T_HandleQuery___VARIANT_12
        by contradiction /* from formulas */
      next
        case T_HandleQuery___VARIANT_2
        by contradiction /* from formulas */
      next
        case T_HandleQuery___VARIANT_4
        by contradiction /* from formulas */
      next
        case T_HandleQuery___VARIANT_9
        by contradiction /* from formulas */
      next
        case c_seal
        by contradiction /* from formulas */
      qed
    next
      case case_2
      by contradiction /* from formulas */
    next
      case case_3
      by contradiction /* from formulas */
    qed
  qed
qed

end